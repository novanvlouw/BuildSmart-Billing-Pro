<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BuildSmart Billing Pro - Professional Billing Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', system-ui, sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #0f0f23 0%, #1e1b4b 30%, #1a1a2e 50%, #0f0f23 100%); }
        .sleek-gradient { background: linear-gradient(135deg, #0f0f23 0%, #1e1b4b 30%, #16213e 60%, #0f0f23 100%); }
        .accent-gradient { background: linear-gradient(135deg, #1e293b 0%, #4c1d95 50%, #1e1b4b 100%); }
        .purple-gradient { background: linear-gradient(135deg, #1a1a2e 0%, #4c1d95 50%, #1e1b4b 100%); }
        .tri-gradient { background: linear-gradient(135deg, #0f172a 0%, #4c1d95 33%, #1e1b4b 66%, #0f0f23 100%); }
        .sea-glass { background: linear-gradient(135deg, rgba(76, 29, 149, 0.1) 0%, rgba(76, 29, 149, 0.1) 100%); }
        .card-glass { backdrop-filter: blur(16px); background: rgba(15, 15, 35, 0.8); border: 1px solid rgba(76, 29, 149, 0.4); }
        .hover-lift { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .hover-lift:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .glass-effect { backdrop-filter: blur(20px); background: rgba(15, 23, 42, 0.8); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); }
        .animate-fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .success-notification { 
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        @keyframes slideInRight { 
            from { 
                opacity: 0; 
                transform: translateX(100%); 
            } 
            to { 
                opacity: 1; 
                transform: translateX(0); 
            } 
        }
    </style>
</head>
<body class="text-white min-h-screen" style="background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 20%, #1e1b4b 50%, #16213e 80%, #0f0f23 100%);">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-slate-950 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-t-transparent rounded-full animate-spin mx-auto mb-4" style="border-color: #4c1d95; border-top-color: transparent;"></div>
            <div class="text-xl font-semibold text-white">Loading BuildSmart Billing Pro...</div>
            <div class="mt-2" style="color: rgba(148, 163, 184, 0.9);">Professional Billing Management System</div>
        </div>
    </div>

    <div class="flex min-h-screen" id="main-app" style="display: none;">
        <!-- Enhanced Sidebar -->
        <div class="w-72 border-r shadow-2xl backdrop-blur-xl" style="background: linear-gradient(180deg, #1e1b4b 0%, #1a1a2e 30%, #16213e 70%, #0f0f23 100%); border-color: rgba(76, 29, 149, 0.4);">
            <div class="p-6 border-b" style="background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #0f0f23 100%); border-color: rgba(30, 27, 75, 0.3);">
                <div class="flex items-center space-x-4">
                    <div class="w-14 h-14 rounded-2xl flex items-center justify-center backdrop-blur-sm" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid rgba(30, 27, 75, 0.5); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);">
                        <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M3 13h4v8H3v-8zm6-5h4v13H9V8zm6-7h4v20h-4V1z" stroke="currentColor" stroke-width="0.5"/></svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white tracking-wide">BuildSmart Billing Pro</h1>
                        <p class="text-xs font-medium" style="color: rgba(148, 163, 184, 0.8);">Professional Billing Management</p>
                    </div>
                </div>
            </div>
            
            <nav class="p-4">
                <div class="space-y-2">
                    <button onclick="showPage('dashboard')" class="nav-item w-full flex items-center px-4 py-3 rounded-xl text-sm font-medium hover-lift" data-page="dashboard">
                        <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 24 24"><path d="M4 4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h7v5H4V6zm9 0h7v3h-7V6zm-9 7h7v5H4v-5zm9 2h7v3h-7v-3z"/></svg>
                        <span>Dashboard</span>
                        <span class="ml-auto">→</span>
                    </button>
                    <button onclick="showPage('clients')" class="nav-item w-full flex items-center px-4 py-3 rounded-xl text-sm font-medium hover-lift" data-page="clients">
                        <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
                        <span>Client Management</span>
                        <span class="ml-auto">→</span>
                    </button>
                    <button onclick="showPage('billing')" class="nav-item w-full flex items-center px-4 py-3 rounded-xl text-sm font-medium hover-lift" data-page="billing">
                        <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z"/></svg>
                        <span>Billing Models</span>
                        <span class="ml-auto">→</span>
                    </button>
                    <button onclick="showPage('analytics')" class="nav-item w-full flex items-center px-4 py-3 rounded-xl text-sm font-medium hover-lift" data-page="analytics">
                        <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M7.5 14.25v2.25m3-4.5v4.5m3-6.75v6.75m3-9v9M6 20.25h12A2.25 2.25 0 0020.25 18V6A2.25 2.25 0 0018 3.75H6A2.25 2.25 0 003.75 6v12A2.25 2.25 0 006 20.25z"/></svg>
                        <span>Advanced Analytics</span>
                        <span class="ml-auto">→</span>
                    </button>
                    <button onclick="showPage('billing-overview')" class="nav-item w-full flex items-center px-4 py-3 rounded-xl text-sm font-medium hover-lift" data-page="billing-overview">
                        <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span>Billing Overview</span>
                        <span class="ml-auto">→</span>
                    </button>
                    <button onclick="showPage('vars')" class="nav-item w-full flex items-center px-4 py-3 rounded-xl text-sm font-medium hover-lift" data-page="vars">
                        <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/></svg>
                        <span>VAR Management</span>
                        <span class="ml-auto">→</span>
                    </button>
                    <button onclick="showPage('reports')" class="nav-item w-full flex items-center px-4 py-3 rounded-xl text-sm font-medium hover-lift" data-page="reports">
                        <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
                        <span>Professional Reports</span>
                        <span class="ml-auto">→</span>
                    </button>
                </div>

                <!-- Data Management -->
                <div class="mt-8 pt-6 border-t border-slate-600/30">
                    <div class="text-xs font-semibold uppercase tracking-wider mb-3" style="color: rgba(148, 163, 184, 0.8);">Data Management</div>
                    <div class="space-y-2">
                        <button onclick="exportData()" class="w-full flex items-center px-4 py-2 rounded-xl text-sm hover-lift transition-all duration-200" style="color: rgba(148, 163, 184, 0.9);" onmouseover="this.style.background='rgba(46, 16, 101, 0.3)'; this.style.color='#ffffff'" onmouseout="this.style.background=''; this.style.color='rgba(148, 163, 184, 0.9)'"
                            <svg class="w-4 h-4 mr-3" fill="currentColor" viewBox="0 0 24 24"><path d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/></svg>
                            <span>Export Data</span>
                        </button>
                        <button onclick="importData()" class="w-full flex items-center px-4 py-2 rounded-xl text-sm hover-lift transition-all duration-200" style="color: rgba(148, 163, 184, 0.9);" onmouseover="this.style.background='rgba(46, 16, 101, 0.3)'; this.style.color='#ffffff'" onmouseout="this.style.background=''; this.style.color='rgba(148, 163, 184, 0.9)'"
                            <svg class="w-4 h-4 mr-3" fill="currentColor" viewBox="0 0 24 24"><path d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12M12 16.5V3"/></svg>
                            <span>Import Data</span>
                        </button>
                    </div>
                </div>
            </nav>
        </div>
        
        <!-- Main Content Area -->
        <div class="flex-1 overflow-hidden">
            <div id="content-area" class="h-full overflow-y-auto">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Import Billing Model Selection Modal -->
    <div id="import-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div class="relative card-glass p-8 rounded-2xl max-w-md w-full mx-4" style="border: 1px solid rgba(76, 29, 149, 0.5);">
            <h3 class="text-2xl font-bold text-white mb-6 text-center">Import Client Data</h3>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-3">Select Billing Model for Imported Clients</label>
                    <select id="import-billing-model" class="w-full px-4 py-3 bg-slate-900 border border-slate-800 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">Choose billing model...</option>
                        <option value="perpetual">Perpetual</option>
                        <option value="subscription">Subscription</option>
                        <option value="installment">Instalment</option>
                        <option value="var">VAR</option>
                        <option value="rentals">Rentals</option>
                    </select>
                    <div class="text-xs text-slate-400 mt-2">All clients in the Excel file will be imported with this billing model</div>
                </div>
                
                <div class="text-center">
                    <div class="text-slate-400 text-sm mb-4">Ready to import Excel (.xlsx) file</div>
                    <div class="flex space-x-4">
                        <button onclick="app.startImportProcess()" class="flex-1 px-6 py-3 rounded-xl font-medium text-white transition-all duration-200" style="background: linear-gradient(135deg, #4c1d95, #6B46C1, #003366);" onmouseover="this.style.background='linear-gradient(135deg, #6B46C1, #4c1d95, #003366)'" onmouseout="this.style.background='linear-gradient(135deg, #4c1d95, #6B46C1, #003366)'">
                            Select File
                        </button>
                        <button onclick="closeImportModal()" class="flex-1 px-6 py-3 rounded-xl font-medium border transition-all duration-200" style="color: rgba(148, 163, 184, 0.9); border-color: rgba(107, 70, 193, 0.3);" onmouseover="this.style.background='rgba(107, 70, 193, 0.1)'" onmouseout="this.style.background=''">
                            Cancel
                        </button>
                    </div>
                    
                    <!-- Clear Data Section -->
                    <div class="mt-6 pt-4 border-t border-slate-700">
                        <div class="text-center">
                            <button onclick="app.clearAllData(); closeImportModal();" class="px-6 py-2 rounded-lg text-white text-sm font-medium transition-all duration-200 hover:scale-105" style="background: linear-gradient(135deg, rgba(153, 27, 27, 0.7), rgba(127, 29, 29, 0.7)); border: 1px solid rgba(153, 27, 27, 0.4);" onmouseover="this.style.background='linear-gradient(135deg, rgba(153, 27, 27, 0.9), rgba(127, 29, 29, 0.9))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(153, 27, 27, 0.7), rgba(127, 29, 29, 0.7))'">
                                <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                Clear All Data
                            </button>
                            <div class="text-xs text-slate-400 mt-2">Remove all clients and reset application</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div id="add-client-modal" class="fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center z-50 hidden">
        <div class="card-glass rounded-3xl w-full max-w-3xl shadow-2xl animate-fade-in max-h-[90vh] overflow-y-auto hover-lift flex flex-col">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-8 pb-0">
                <h2 class="text-2xl font-bold text-white">Add New Client</h2>
                <button onclick="closeAddClientModal()" class="text-2xl transition-colors" style="color: rgba(148, 163, 184, 0.7);" onmouseover="this.style.color='#ffffff'" onmouseout="this.style.color='rgba(148, 163, 184, 0.7)'">×</button>
            </div>
            
            <!-- Modal Body -->
            <div class="flex-1 p-8">
                <form id="add-client-form" class="space-y-6">
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Client Name</label>
                        <input type="text" name="clientName" required class="w-full px-4 py-3 bg-slate-900/80 border border-slate-700/60 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent backdrop-blur-sm" placeholder="Enter client name">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Debt Code</label>
                        <input type="text" name="debtCode" class="w-full px-4 py-3 bg-slate-900/80 border border-slate-700/60 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent backdrop-blur-sm" placeholder="Enter debt code (optional)">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Billing Model</label>
                        <select name="billingModel" required class="w-full px-4 py-3 bg-slate-900/80 border border-slate-700/60 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent backdrop-blur-sm" onchange="handleClientBillingModelChange(this)">
                            <option value="">Select Billing Model</option>
                            <option value="perpetual">Perpetual</option>
                            <option value="subscription">Subscription</option>
                            <option value="installment">Instalment</option>
                            <option value="var">VAR</option>
                            <option value="rentals">Rentals</option>
                        </select>
                    </div>
                    
                    <div id="client-var-partner-field" class="hidden">
                        <label class="block text-sm font-medium text-slate-300 mb-2">VAR Partner</label>
                        <select name="varPartner" class="w-full px-4 py-3 bg-slate-900/80 border border-slate-700/60 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent backdrop-blur-sm" id="client-var-partner-select">
                            <!-- Options populated by JavaScript -->
                        </select>
                    </div>
                    
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Users Count</label>
                        <input type="number" name="users" min="0" required class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="Number of users">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Currency</label>
                        <select name="currency" required class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                            <option value="ZAR">ZAR - South African Rand</option>
                            <option value="USD">USD - US Dollar</option>
                            <option value="EUR">EUR - Euro</option>
                            <option value="GBP">GBP - British Pound</option>
                            <option value="CAD">CAD - Canadian Dollar</option>
                            <option value="AUD">AUD - Australian Dollar</option>
                            <option value="JPY">JPY - Japanese Yen</option>
                        </select>
                    </div>
                    
                    <!-- Monthly Values Grid -->
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-4">Monthly Billing Values</label>
                        <div class="grid grid-cols-3 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">January</label>
                                <input type="number" name="jan" step="0.01" min="0" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-1 focus:ring-teal-500" placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">February</label>
                                <input type="number" name="feb" step="0.01" min="0" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-1 focus:ring-teal-500" placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">March</label>
                                <input type="number" name="mar" step="0.01" min="0" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-1 focus:ring-teal-500" placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">April</label>
                                <input type="number" name="apr" step="0.01" min="0" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-1 focus:ring-teal-500" placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">May</label>
                                <input type="number" name="may" step="0.01" min="0" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-1 focus:ring-teal-500" placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">June</label>
                                <input type="number" name="jun" step="0.01" min="0" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-1 focus:ring-teal-500" placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">July</label>
                                <input type="number" name="jul" step="0.01" min="0" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-1 focus:ring-teal-500" placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">August</label>
                                <input type="number" name="aug" step="0.01" min="0" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-1 focus:ring-teal-500" placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">September</label>
                                <input type="number" name="sep" step="0.01" min="0" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-1 focus:ring-teal-500" placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">October</label>
                                <input type="number" name="oct" step="0.01" min="0" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-1 focus:ring-teal-500" placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">November</label>
                                <input type="number" name="nov" step="0.01" min="0" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-1 focus:ring-teal-500" placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">December</label>
                                <input type="number" name="dec" step="0.01" min="0" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-1 focus:ring-teal-500" placeholder="0.00">
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Total (will be calculated automatically)</label>
                        <input type="number" name="total" step="0.01" min="0" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="Total annual value" readonly>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Deal Start Date</label>
                            <input type="date" name="dealStartDate" required class="w-full px-4 py-3 bg-slate-900/80 border border-slate-700/60 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent backdrop-blur-sm" onchange="updateAnniversaryFromDealDate(this)">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Anniversary Month</label>
                            <select name="anniversaryMonth" required class="w-full px-4 py-3 bg-slate-900/80 border border-slate-700/60 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent backdrop-blur-sm">
                                <option value="">Select Anniversary Month</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="bg-purple-900/20 border border-purple-500/30 rounded-xl p-4">
                        <div class="flex items-start space-x-3">
                            <svg class="w-5 h-5 text-purple-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <div class="text-sm">
                                <div class="text-purple-200 font-medium mb-1">Anniversary Date Logic</div>
                                <div class="text-purple-300/80">The anniversary month determines when annual billing cycles occur, regardless of billing frequency (monthly, quarterly, etc.). Additional licenses will be prorated to align with this anniversary date.</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Comments</label>
                        <textarea name="comments" rows="3" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="Additional notes or comments"></textarea>
                    </div>

                </div>
                </form>
            </div>
            
            <!-- Modal Footer - Fixed at Bottom -->
            <div class="px-8 py-6 border-t border-slate-700">
                <div class="flex justify-center items-center space-x-6 mt-4">
                    <button type="button" onclick="closeAddClientModal()" class="text-white py-3 px-8 rounded-xl font-medium hover-lift text-sm transition-all duration-200" style="background: rgba(0, 51, 102, 0.5);" onmouseover="this.style.background='rgba(0, 51, 102, 0.6)'" onmouseout="this.style.background='rgba(0, 51, 102, 0.5)'">
                        Cancel
                    </button>
                    <button type="submit" form="add-client-form" class="text-white py-3 px-8 rounded-xl font-medium hover-lift shadow-lg text-sm transition-all duration-200" style="background: linear-gradient(135deg, #0f172a, #4c1d95, #1e1b4b);" onmouseover="this.style.background='linear-gradient(135deg, #4c1d95, #0f172a, #1e1b4b)'" onmouseout="this.style.background='linear-gradient(135deg, #0f172a, #4c1d95, #1e1b4b)'">
                        <div class="text-center">Add Client</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit VAR Modal -->
    <div id="add-var-modal" class="fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center z-40 hidden">
        <div class="card-glass rounded-3xl p-8 w-full max-w-2xl shadow-2xl animate-fade-in max-h-[90vh] overflow-y-auto hover-lift">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white" id="var-modal-title">Add New VAR Partner</h2>
                <button onclick="closeAddVarModal()" class="text-2xl transition-colors" style="color: rgba(148, 163, 184, 0.7);" onmouseover="this.style.color='#ffffff'" onmouseout="this.style.color='rgba(148, 163, 184, 0.7)'">×</button>
            </div>
            
            <form id="add-var-form" class="space-y-6">
                <input type="hidden" name="varId" id="var-id-input">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Company Name</label>
                        <input type="text" name="companyName" required class="w-full px-4 py-3 bg-slate-900/80 border border-slate-700/60 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent backdrop-blur-sm">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Region</label>
                        <select name="region" required class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                            <option value="">Select Region</option>
                            <option value="North America">North America</option>
                            <option value="Europe">Europe</option>
                            <option value="Asia Pacific">Asia Pacific</option>
                            <option value="Latin America">Latin America</option>
                            <option value="Middle East">Middle East</option>
                            <option value="Africa">Africa</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Contact Person</label>
                        <input type="text" name="contactPerson" required class="w-full px-4 py-3 bg-slate-900/80 border border-slate-700/60 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent backdrop-blur-sm">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Email Address</label>
                        <input type="email" name="email" required class="w-full px-4 py-3 bg-slate-900/80 border border-slate-700/60 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent backdrop-blur-sm">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Phone Number</label>
                        <input type="tel" name="phone" class="w-full px-4 py-3 bg-slate-900/80 border border-slate-700/60 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent backdrop-blur-sm">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Commission Rate (%)</label>
                        <input type="number" name="commissionRate" step="0.1" min="0" max="100" required class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="e.g., 15.5">
                    </div>
                </div>
                
                <div class="flex space-x-4 pt-6">
                    <button type="submit" class="flex-1 text-white py-3 px-6 rounded-xl font-medium hover-lift shadow-lg" style="background: linear-gradient(135deg, #0f172a, #4c1d95, #1e1b4b);" onmouseover="this.style.background='linear-gradient(135deg, #4c1d95, #0f172a, #1e1b4b)'" onmouseout="this.style.background='linear-gradient(135deg, #0f172a, #4c1d95, #1e1b4b)'" id="var-submit-btn">
                        Add VAR Partner
                    </button>
                    <button type="button" onclick="closeAddVarModal()" class="flex-1 text-white py-3 px-6 rounded-xl font-medium hover-lift" style="background: rgba(0, 51, 102, 0.5);" onmouseover="this.style.background='rgba(0, 51, 102, 0.6)'" onmouseout="this.style.background='rgba(0, 51, 102, 0.5)'">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add License Modal -->
    <div id="add-license-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-40 hidden">
        <div class="bg-slate-900 rounded-2xl p-8 w-full max-w-2xl border border-slate-800 shadow-2xl animate-fade-in">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white">Add Additional License</h2>
                <button onclick="closeAddLicenseModal()" class="text-2xl transition-colors" style="color: rgba(148, 163, 184, 0.7);" onmouseover="this.style.color='#ffffff'" onmouseout="this.style.color='rgba(148, 163, 184, 0.7)'">×</button>
            </div>
            
            <form id="add-license-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Client</label>
                        <select name="clientId" required class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent" id="license-client-select" onchange="handleLicenseClientChange(this)">
                            <!-- Options populated by JavaScript -->
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Billing Model</label>
                        <select name="billingModel" id="license-billing-model" required class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent" onchange="handleLicenseBillingModelChange(this)">
                            <option value="">Select Billing Model</option>
                            <option value="perpetual">Perpetual</option>
                            <option value="subscription">Subscription</option>
                            <option value="installment">Instalment</option>
                            <option value="var">VAR</option>
                            <option value="rentals">Rentals</option>
                        </select>
                    </div>
                    
                    <div id="license-var-partner-field" class="hidden col-span-2">
                        <label class="block text-sm font-medium text-slate-300 mb-2">VAR Partner</label>
                        <select name="licenseVarPartner" id="license-var-partner-select" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                            <!-- Options populated by JavaScript -->
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Quantity/Users</label>
                        <input type="number" name="quantity" min="1" required class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2" id="price-per-unit-label">Price Per Unit</label>
                        <input type="number" name="pricePerUnit" step="0.01" min="0" required class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="Price per unit" id="price-per-unit-input">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Currency</label>
                        <select name="currency" required class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent" id="license-currency-select">
                            <option value="ZAR">ZAR - South African Rand</option>
                            <option value="USD">USD - US Dollar</option>
                            <option value="EUR">EUR - Euro</option>
                            <option value="GBP">GBP - British Pound</option>
                            <option value="CAD">CAD - Canadian Dollar</option>
                            <option value="AUD">AUD - Australian Dollar</option>
                            <option value="JPY">JPY - Japanese Yen</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Start Date</label>
                        <input type="date" name="startDate" required class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                    </div>
                </div>
                
                <div id="billing-info" class="rounded-xl p-4" style="background: rgba(15, 15, 35, 0.6); border: 1px solid rgba(76, 29, 149, 0.5);">
                    <div class="flex items-center mb-2">
                        <svg class="w-4 h-4 mr-2" style="color: #94a3b8;" fill="currentColor" viewBox="0 0 24 24"><path d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                        <h4 class="font-semibold" style="color: #94a3b8;" id="billing-info-title">Billing Information</h4>
                    </div>
                    <div class="text-sm text-white/80" id="billing-info-text">
                        Select a billing model to see specific billing information.
                    </div>
                </div>
                
                <div class="flex space-x-4 pt-6">
                    <button type="submit" class="flex-1 text-white py-3 px-6 rounded-xl font-medium hover-lift shadow-lg" style="background: linear-gradient(135deg, #4c1d95, #003366);" onmouseover="this.style.background='linear-gradient(135deg, #003366, #4c1d95)'" onmouseout="this.style.background='linear-gradient(135deg, #4c1d95, #003366)'">
                        <div class="text-center">Add License</div>
                    </button>
                    <button type="button" onclick="closeAddLicenseModal()" class="flex-1 bg-slate-600 hover:bg-slate-700 text-white py-3 px-6 rounded-xl font-medium transition-colors">
                        <div class="text-center">Cancel</div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Billing Configuration Modal -->
    <div id="billing-config-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-40 hidden">
        <div class="bg-slate-900 rounded-2xl p-8 w-full max-w-4xl border border-slate-800 shadow-2xl animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white">Configure Billing Models</h2>
                <button onclick="closeBillingConfigModal()" class="text-2xl transition-colors" style="color: rgba(148, 163, 184, 0.7);" onmouseover="this.style.color='#ffffff'" onmouseout="this.style.color='rgba(148, 163, 184, 0.7)'">×</button>
            </div>
            
            <form id="billing-config-form" class="space-y-8">
                <div id="billing-model-config">
                    <!-- Model-specific configuration will be loaded here -->
                </div>
                
                <div class="flex space-x-4 pt-6 border-t border-slate-700">
                    <button type="submit" class="flex-1 text-white py-3 px-6 rounded-xl font-medium hover-lift shadow-lg" style="background: linear-gradient(135deg, #4c1d95, #003366);" onmouseover="this.style.background='linear-gradient(135deg, #003366, #4c1d95)'" onmouseout="this.style.background='linear-gradient(135deg, #4c1d95, #003366)'">
                        Save Configuration
                    </button>
                    <button type="button" onclick="closeBillingConfigModal()" class="flex-1 bg-slate-600 hover:bg-slate-700 text-white py-3 px-6 rounded-xl font-medium transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Enhanced BuildSmart Billing Pro with exact business requirements
        class BuildSmartBillingPro {
            constructor() {
                this.clients = this.loadClients();
                this.additionalLicenses = this.loadAdditionalLicenses();
                this.varPartners = this.loadVarPartners();
                // Annual increases now handled by getAnnualIncreases() method
                this.globalAnnualIncrease = this.loadGlobalAnnualIncrease();
                this.increaseYear = this.loadIncreaseYear();
                this.currentPage = 'dashboard';
                
                // Ensure all clients have anniversary months set
                this.ensureAnniversaryMonths();
                
                // Clear any existing hardcoded increases on first load
                this.initializeCleanState();
                
                this.initializeApp();
            }
            
            ensureAnniversaryMonths() {
                let updated = false;
                this.clients.forEach(client => {
                    if (!client.anniversaryMonth && client.dealStartDate) {
                        client.anniversaryMonth = new Date(client.dealStartDate).getMonth() + 1;
                        updated = true;
                        console.log('Set anniversary month for', client.clientName + ':', client.anniversaryMonth);
                    }
                });
                
                if (updated) {
                    this.saveClients();
                }
            }
            
            initializeCleanState() {
                // Clear any hardcoded increases to start with clean state
                const stored = localStorage.getItem('buildsmart_annual_increases');
                if (!stored) {
                    // First time setup - clear any existing increases
                    localStorage.setItem('buildsmart_annual_increases', JSON.stringify([]));
                    console.log('Initialized clean state: No annual increases applied. 2025, 2026, 2027 will show same values.');
                }
            }

            initializeApp() {
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('main-app').style.display = 'flex';
                    this.showPage('dashboard');
                }, 1500);

                // Add form submit handlers
                document.getElementById('add-client-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const formData = new FormData(form);
                    
                    if (form.dataset.editingClientId) {
                        // We're editing an existing client
                        this.updateClient(form.dataset.editingClientId, formData);
                    } else {
                        // We're adding a new client
                        this.addClient(formData);
                    }
                });

                document.getElementById('add-license-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addAdditionalLicense(new FormData(e.target));
                });
                
                document.getElementById('add-var-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addVarPartner(new FormData(e.target));
                });
                
                // Populate VAR partners dropdown when modal opens
                this.populateVarPartners();
                
                // Add billing configuration form handler
                setTimeout(() => {
                    const billingForm = document.getElementById('billing-config-form');
                    if (billingForm) {
                        billingForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            const formData = new FormData(e.target);
                            
                            const settings = {
                                perpetual: {
                                    year1Policy: formData.get('perpetual_year1_policy') || 'free',
                                    alignment: formData.get('perpetual_alignment') || 'anniversary',
                                    defaultAnniversary: parseInt(formData.get('perpetual_default_anniversary') || 1)
                                },
                                subscription: {
                                    frequency: formData.get('subscription_frequency') || 'monthly',
                                    renewal: formData.get('subscription_renewal') || 'auto',
                                    gracePeriod: parseInt(formData.get('subscription_grace_period') || 7)
                                },
                                var: {
                                    defaultCommission: parseFloat(formData.get('var_default_commission') || 20),
                                    paymentTerms: formData.get('var_payment_terms') || 'net30',
                                    minThreshold: parseFloat(formData.get('var_min_threshold') || 1000)
                                },
                                installment: {
                                    defaultPeriod: parseInt(formData.get('installment_default_period') || 12),
                                    latePolicy: formData.get('installment_late_policy') || 'grace',
                                    interestRate: parseFloat(formData.get('installment_interest_rate') || 0)
                                },
                                rentals: {
                                    defaultPeriod: parseInt(formData.get('rentals_default_period') || 12),
                                    monthlyFactor: parseFloat(formData.get('rentals_monthly_factor') || 0.08),
                                    securityDeposit: parseFloat(formData.get('rentals_security_deposit') || 10)
                                }
                            };
                            
                            this.saveBillingModelSettings(settings);
                            this.closeBillingConfigModal();
                        });
                    }
                }, 100);
            }

            // Local Storage Management
            loadClients() {
                const stored = localStorage.getItem('buildsmart_clients');
                if (stored) {
                    return JSON.parse(stored);
                }
                
                // Sample data matching import format: Users, Client Name, Debt Code, Monthly Values, Total, Comments
                return [
                    {
                        id: '1',
                        clientName: 'TechCorp Solutions Inc.',
                        debtCode: 'TC001',
                        users: 50,
                        jan: 0, feb: 0, mar: 0, apr: 0, may: 0, jun: 0,
                        jul: 450000, aug: 0, sep: 0, oct: 0, nov: 0, dec: 0,
                        total: 450000,
                        comments: 'Annual S&M billing in July',
                        currency: 'ZAR',
                        dealStartDate: '2024-07-15',
                        billingModel: 'perpetual',
                        anniversaryMonth: 7,
                        isActive: true,
                        createdAt: new Date('2025-07-15').toISOString()
                    },
                    {
                        id: '2',
                        clientName: 'European Analytics Ltd',
                        debtCode: 'EA002',
                        users: 25,
                        jan: 0, feb: 0, mar: 180000, apr: 0, may: 0, jun: 0,
                        jul: 0, aug: 0, sep: 0, oct: 0, nov: 0, dec: 0,
                        total: 180000,
                        comments: 'Monthly subscription billing',
                        currency: 'EUR',
                        dealStartDate: '2024-03-01',
                        billingModel: 'subscription',
                        billingFrequency: 'monthly',
                        isActive: true,
                        createdAt: new Date('2024-03-01').toISOString()
                    },
                    {
                        id: '3',
                        clientName: 'Global VAR Partners',
                        debtCode: 'GVP003',
                        users: 100,
                        jan: 300000, feb: 0, mar: 0, apr: 0, may: 0, jun: 0,
                        jul: 0, aug: 0, sep: 0, oct: 0, nov: 0, dec: 0,
                        total: 300000,
                        comments: 'VAR commission-based billing',
                        currency: 'ZAR',
                        dealStartDate: '2024-01-01',
                        billingModel: 'var',
                        commissionRate: 25,
                        varPartner: 'GlobalTech VAR',
                        isActive: true,
                        createdAt: new Date('2024-01-01').toISOString()
                    },
                    {
                        id: '4',
                        clientName: 'CloudSync Pro Ltd',
                        debtCode: 'CSP004',
                        users: 75,
                        jan: 85000, feb: 85000, mar: 85000, apr: 85000, may: 85000, jun: 85000,
                        jul: 85000, aug: 85000, sep: 85000, oct: 85000, nov: 85000, dec: 85000,
                        total: 1020000,
                        comments: 'Monthly subscription - enterprise tier',
                        currency: 'USD',
                        dealStartDate: '2024-01-01',
                        billingModel: 'subscription',
                        billingFrequency: 'monthly',
                        isActive: true,
                        createdAt: new Date('2024-01-01').toISOString()
                    },
                    {
                        id: '5',
                        clientName: 'AfriTech Manufacturing',
                        debtCode: 'ATM005',
                        users: 35,
                        jan: 0, feb: 0, mar: 0, apr: 0, may: 220000, jun: 0,
                        jul: 0, aug: 0, sep: 0, oct: 0, nov: 0, dec: 0,
                        total: 220000,
                        comments: 'Annual S&M billing in May',
                        currency: 'ZAR',
                        dealStartDate: '2024-05-01',
                        billingModel: 'perpetual',
                        anniversaryMonth: 5,
                        isActive: true,
                        createdAt: new Date('2024-05-01').toISOString()
                    },
                    {
                        id: '6',
                        clientName: 'DataFlow Solutions',
                        debtCode: 'DFS006',
                        users: 60,
                        jan: 50000, feb: 50000, mar: 50000, apr: 50000, may: 50000, jun: 50000,
                        jul: 50000, aug: 50000, sep: 50000, oct: 50000, nov: 50000, dec: 50000,
                        total: 600000,
                        comments: '12-month instalment plan for enterprise license',
                        currency: 'GBP',
                        dealStartDate: '2024-01-01',
                        billingModel: 'installment',
                        instalmentPeriods: 12,
                        instalmentAmount: 50000,
                        isActive: true,
                        createdAt: new Date('2024-01-01').toISOString()
                    },
                    {
                        id: 'client7',
                        companyName: 'RentalTech Solutions',
                        clientName: 'RentalTech Solutions',
                        contactPerson: 'Maria Rodriguez', 
                        email: 'maria.rodriguez@rentaltech.com',
                        phone: '+1-555-0189',
                        debtCode: 'RENTAL-001',
                        status: 'Active',
                        users: 25,
                        jan: 8000, feb: 8000, mar: 8000, apr: 8000, may: 8000, jun: 8000,
                        jul: 8000, aug: 8000, sep: 8000, oct: 8000, nov: 8000, dec: 8000,
                        total: 96000,
                        comments: 'BuildSmart rental program - 24 month contract',
                        currency: 'USD',
                        dealStartDate: '2024-02-01',
                        billingModel: 'rentals',
                        rentalPeriods: 24,
                        monthlyFactor: 0.08,
                        securityDeposit: 10,
                        isActive: true,
                        createdAt: new Date('2024-02-01').toISOString()
                    }
                ];
            }

            loadAdditionalLicenses() {
                const stored = localStorage.getItem('buildsmart_additional_licenses');
                if (stored) {
                    return JSON.parse(stored);
                }
                
                // Sample additional licenses
                return [
                    {
                        id: '1',
                        clientId: '1',
                        licenseType: 'user',
                        quantity: 10,
                        pricePerUnit: 200,
                        startDate: '2025-03-15',
                        isActive: true,
                        createdAt: new Date('2025-03-15').toISOString()
                    }
                ];
            }

            loadAnnualIncreases() {
                const stored = localStorage.getItem('buildsmart_annual_increases');
                if (stored) {
                    return JSON.parse(stored);
                }
                
                // Default annual increases
                return [
                    { year: 2024, percentage: 5.0 },
                    { year: 2025, percentage: 5.5 },
                    { year: 2026, percentage: 6.0 }
                ];
            }

            saveClients() {
                localStorage.setItem('buildsmart_clients', JSON.stringify(this.clients));
            }

            saveAdditionalLicenses() {
                localStorage.setItem('buildsmart_additional_licenses', JSON.stringify(this.additionalLicenses));
            }

            saveAnnualIncreases() {
                localStorage.setItem('buildsmart_annual_increases', JSON.stringify(this.getAnnualIncreases()));
            }

            // Currency Formatting
            formatCurrency(amount, currency = 'ZAR') {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: currency,
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                }).format(amount);
            }

            formatNumber(num) {
                return new Intl.NumberFormat('en-US').format(num);
            }

            // Advanced Analytics Calculations
            calculateARR() {
                // Calculate Annual Recurring Revenue from all clients
                let totalARR = 0;
                this.clients.forEach(client => {
                    if (client.billingModel === 'subscription') {
                        totalARR += client.total || 0;
                    } else if (client.billingModel === 'perpetual') {
                        // For perpetual, only count S&M revenue as recurring
                        totalARR += this.calculatePerpetualSM(client, new Date().getFullYear());
                    }
                });
                return totalARR;
            }

            calculateARPU() {
                // Average Revenue Per User
                const totalRevenue = this.clients.reduce((sum, client) => sum + (client.total || 0), 0);
                const totalUsers = this.clients.reduce((sum, client) => sum + (client.users || 0), 0);
                return totalUsers > 0 ? totalRevenue / totalUsers : 0;
            }

            calculateCLV() {
                // Customer Lifetime Value (simplified calculation)
                const averageRevenue = this.clients.length > 0 ? 
                    this.clients.reduce((sum, client) => sum + (client.total || 0), 0) / this.clients.length : 0;
                const estimatedLifespan = 3; // Assume 3 years average
                return averageRevenue * estimatedLifespan;
            }

            calculateSMGrowth() {
                // S&M Revenue Growth percentage
                const currentYear = new Date().getFullYear();
                const currentSM = this.clients.reduce((sum, client) => {
                    if (client.billingModel === 'perpetual') {
                        return sum + this.calculatePerpetualSM(client, currentYear);
                    }
                    return sum;
                }, 0);
                
                const previousSM = this.clients.reduce((sum, client) => {
                    if (client.billingModel === 'perpetual') {
                        return sum + this.calculatePerpetualSM(client, currentYear - 1);
                    }
                    return sum;
                }, 0);
                
                return previousSM > 0 ? ((currentSM - previousSM) / previousSM * 100).toFixed(1) : '0';
            }

            projectSM(year) {
                // Project S&M revenue for a given year
                return this.clients.reduce((sum, client) => {
                    if (client.billingModel === 'perpetual') {
                        return sum + this.calculatePerpetualSM(client, year);
                    }
                    return sum;
                }, 0);
            }

            getTotalLicenses() {
                const clientLicenses = this.clients.reduce((sum, client) => sum + (client.users || 0), 0);
                const additionalLicenses = this.additionalLicenses.reduce((sum, license) => sum + (license.quantity || 0), 0);
                return clientLicenses + additionalLicenses;
            }

            // Annual Increases Data
            getAnnualIncreases() {
                const stored = localStorage.getItem('buildsmart_annual_increases');
                if (stored) {
                    return JSON.parse(stored);
                }
                
                // Default: no increases applied yet - all years show same values
                return [
                    // Add increases here when ready to apply them
                    // { year: '2026', percentage: 5.0 }  // Example: 5% increase starting 2026
                ];
            }
            
            setAnnualIncrease(year, percentage) {
                const increases = this.getAnnualIncreases();
                const existingIndex = increases.findIndex(inc => inc.year === year);
                
                // Ensure percentage is stored as a number, preserving decimals
                const numericPercentage = parseFloat(percentage);
                
                if (existingIndex !== -1) {
                    increases[existingIndex].percentage = numericPercentage;
                } else {
                    increases.push({ year: year, percentage: numericPercentage });
                }
                
                localStorage.setItem('buildsmart_annual_increases', JSON.stringify(increases));
                console.log('Set annual increase for', year + ':', numericPercentage + '% (type:', typeof numericPercentage + ')');
                
                // Auto-add next year if we're close to current target year
                this.autoAddFutureYears();
            }
            
            autoAddFutureYears() {
                const currentYear = new Date().getFullYear();
                const increases = this.getAnnualIncreases();
                
                // If we're in a year that has increases defined, add 2 years ahead
                const hasCurrentYearIncrease = increases.some(inc => parseInt(inc.year) === currentYear);
                if (hasCurrentYearIncrease) {
                    const futureYear = currentYear + 2;
                    const hasFutureYear = increases.some(inc => parseInt(inc.year) === futureYear);
                    
                    if (!hasFutureYear) {
                        console.log('Auto-adding year', futureYear, 'for future planning');
                        // Don't auto-set an increase, just make the year available
                    }
                }
            }

            // Billing Overview Helper Functions
            getBillingSummaryCards() {
                const currentYear = parseInt(document.getElementById('billing-year')?.value || new Date().getFullYear());
                const modelFilter = document.getElementById('billing-model-filter')?.value || 'all';
                const filteredClients = this.getFilteredClients(modelFilter);
                
                const monthlyBilling = filteredClients.reduce((sum, client) => {
                    return sum + this.calculateMonthlyBillingPerClient(client, currentYear);
                }, 0);
                
                const yearlyBilling = monthlyBilling * 12;
                const totalClients = filteredClients.length;
                const averageRevenue = totalClients > 0 ? yearlyBilling / totalClients : 0;
                
                return `
                    <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl border border-slate-700 p-6">
                        <h3 class="text-lg font-semibold text-white mb-2">Monthly Revenue</h3>
                        <p class="text-3xl font-bold text-white">${this.formatCurrency(monthlyBilling)}</p>
                        <p class="text-slate-400 text-sm">Current projection</p>
                    </div>
                    <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl border border-slate-700 p-6">
                        <h3 class="text-lg font-semibold text-white mb-2">Annual Revenue</h3>
                        <p class="text-3xl font-bold text-white">${this.formatCurrency(yearlyBilling)}</p>
                        <p class="text-slate-400 text-sm">${currentYear} projection</p>
                    </div>
                    <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl border border-slate-700 p-6">
                        <h3 class="text-lg font-semibold text-white mb-2">Active Clients</h3>
                        <p class="text-3xl font-bold text-white">${totalClients}</p>
                        <p class="text-slate-400 text-sm">Filtered view</p>
                    </div>
                    <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl border border-slate-700 p-6">
                        <h3 class="text-lg font-semibold text-white mb-2">Average Revenue</h3>
                        <p class="text-3xl font-bold text-white">${this.formatCurrency(averageRevenue)}</p>
                        <p class="text-slate-400 text-sm">Per client annually</p>
                    </div>
                `;
            }

            getFilteredClients(modelFilter) {
                if (modelFilter === 'all') return this.clients;
                return this.clients.filter(client => client.billingModel === modelFilter);
            }

            calculateMonthlyBillingPerClient(client, year) {
                const currentYear = new Date().getFullYear();
                const targetYear = year || currentYear;
                
                // For future years, apply the increase to the standard calculation
                let baseAmount = 0;
                switch(client.billingModel) {
                    case 'subscription':
                        const frequency = client.billingFrequency || 'annually';
                        const divisors = { monthly: 1, quarterly: 3, 'semi-annually': 6, annually: 12 };
                        baseAmount = (client.total || 0) / (divisors[frequency] || 12);
                        break;
                    case 'var':
                        baseAmount = ((client.total || 0) * (client.commissionRate || 20) / 100) / 12;
                        break;
                    case 'perpetual':
                        baseAmount = this.calculatePerpetualSM(client, currentYear) / 12;
                        break;
                    case 'installment':
                        baseAmount = (client.total || 0) / (client.installmentMonths || 12);
                        break;
                    case 'rentals':
                        baseAmount = (client.total || 0) * (client.monthlyFactor || 0.08);
                        break;
                    default:
                        return 0;
                }
                
                // Apply increase for future years using the new annual increase system
                if (targetYear > currentYear) {
                    const increases = this.getAnnualIncreases();
                    
                    if (increases.length > 0) {
                        const firstIncreaseYear = Math.min(...increases.map(inc => parseInt(inc.year)));
                        
                        if (targetYear >= firstIncreaseYear) {
                            // Find applicable increase for this year (carries forward)
                            let applicableIncrease = null;
                            for (let checkYear = targetYear; checkYear >= firstIncreaseYear; checkYear--) {
                                const increase = increases.find(inc => parseInt(inc.year) === checkYear);
                                if (increase) {
                                    applicableIncrease = increase;
                                    break;
                                }
                            }
                            
                            if (applicableIncrease) {
                                return baseAmount * (1 + applicableIncrease.percentage / 100);
                            }
                        }
                    }
                    
                    // No increases set, return base amount
                    return baseAmount;
                }
                
                return baseAmount;
            }

            getMonthlyBillingTableByCurrency(currency) {
                const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                const modelFilter = document.getElementById('billing-model-filter')?.value || 'all';
                const filteredClients = this.getFilteredClients(modelFilter).filter(c => c.currency === currency);
                
                return `
                    <table class="w-full">
                        <thead style="background: rgba(6, 63, 120, 0.4);">
                            <tr>
                                <th class="text-left py-3 px-4 font-semibold text-slate-300">Month</th>
                                <th class="text-right py-3 px-4 font-semibold text-slate-300">Revenue</th>
                                <th class="text-right py-3 px-4 font-semibold text-slate-300">Clients</th>
                                <th class="text-right py-3 px-4 font-semibold text-slate-300">Growth</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-700">
                            ${months.map((month, index) => {
                                // Get actual revenue from client monthly data
                                const monthlyRevenue = filteredClients.reduce((sum, client) => {
                                    return sum + (client[month] || 0);
                                }, 0);
                                
                                // Count clients with revenue in this month
                                const activeClients = filteredClients.filter(client => (client[month] || 0) > 0).length;
                                
                                // Calculate growth from previous month
                                const prevMonth = months[index - 1];
                                const prevRevenue = prevMonth ? filteredClients.reduce((sum, client) => sum + (client[prevMonth] || 0), 0) : monthlyRevenue;
                                const growth = prevRevenue > 0 ? ((monthlyRevenue - prevRevenue) / prevRevenue * 100) : 0;
                                
                                const currencySymbol = currency === 'USD' ? '$' : 'R';
                                const formattedRevenue = currencySymbol + monthlyRevenue.toLocaleString();
                                
                                return `
                                    <tr class="hover:bg-slate-700/30 transition-colors">
                                        <td class="py-3 px-4 text-white font-medium">${monthNames[index]}</td>
                                        <td class="py-3 px-4 text-right text-white font-semibold">${formattedRevenue}</td>
                                        <td class="py-3 px-4 text-right text-slate-300">${activeClients}</td>
                                        <td class="py-3 px-4 text-right">
                                            <span class="${growth >= 0 ? 'text-green-400' : 'text-red-400'} font-medium text-sm">
                                                ${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%
                                            </span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            }

            getSixMonthProjections() {
                const currentYear = new Date().getFullYear();
                const periods = [
                    { label: 'Jan-Jun', months: ['jan','feb','mar','apr','may','jun'], year: currentYear },
                    { label: 'Jul-Dec', months: ['jul','aug','sep','oct','nov','dec'], year: currentYear },
                    { label: 'Jan-Jun ' + (currentYear + 1), months: ['jan','feb','mar','apr','may','jun'], year: currentYear + 1 },
                    { label: 'Jul-Dec ' + (currentYear + 1), months: ['jul','aug','sep','oct','nov','dec'], year: currentYear + 1 }
                ];
                
                const modelFilter = document.getElementById('billing-model-filter')?.value || 'all';
                const filteredClients = this.getFilteredClients(modelFilter);
                
                return `
                    <div class="space-y-3">
                        ${periods.map(period => {
                            // Calculate total for this 6-month period using actual monthly data
                            let periodTotal = 0;
                            
                            if (period.year === currentYear) {
                                // For current year, use actual monthly data from clients
                                periodTotal = period.months.reduce((sum, monthKey) => {
                                    const monthTotal = filteredClients.reduce((clientSum, client) => {
                                        return clientSum + (parseFloat(client[monthKey]) || 0);
                                    }, 0);
                                    return sum + monthTotal;
                                }, 0);
                            } else {
                                // For future years, use projections based on average monthly billing
                                periodTotal = period.months.reduce((sum, monthKey) => {
                                    const monthTotal = filteredClients.reduce((clientSum, client) => {
                                        return clientSum + this.calculateMonthlyBillingPerClient(client, period.year);
                                    }, 0);
                                    return sum + monthTotal;
                                }, 0);
                            }
                            
                            return `
                                <div class="flex justify-between items-center py-3 border-b border-slate-700/50">
                                    <span class="text-slate-300 font-medium">${period.label}</span>
                                    <span class="text-white font-semibold">${this.formatCurrency(periodTotal)}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            // This function is replaced by the comprehensive version below

            getAnnualComparison() {
                const currentYear = new Date().getFullYear();
                const modelFilter = document.getElementById('billing-model-filter')?.value || 'all';
                const filteredClients = this.getFilteredClients(modelFilter);
                
                const years = [currentYear, currentYear + 1, currentYear + 2];
                
                return years.map(year => {
                    let totalRevenue = 0;
                    let monthlyAverage = 0;
                    let smRevenue = 0;
                    
                    if (year === currentYear) {
                        // For current year, use actual monthly data
                        const monthKeys = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
                        totalRevenue = monthKeys.reduce((sum, monthKey) => {
                            const monthTotal = filteredClients.reduce((clientSum, client) => {
                                return clientSum + (parseFloat(client[monthKey]) || 0);
                            }, 0);
                            return sum + monthTotal;
                        }, 0);
                        monthlyAverage = totalRevenue / 12;
                    } else {
                        // For future years, calculate projections
                        const nonPerpetualClients = filteredClients.filter(c => c.billingModel !== 'perpetual');
                        const perpetualClients = filteredClients.filter(c => c.billingModel === 'perpetual');
                        
                        // Calculate monthly billing for non-perpetual clients (subscription, var, installment, rentals)
                        const monthlyBilling = nonPerpetualClients.reduce((sum, client) => {
                            return sum + this.calculateMonthlyBillingPerClient(client, year);
                        }, 0);
                        
                        // Calculate S&M revenue for perpetual clients separately (no doubling)
                        smRevenue = perpetualClients.reduce((sum, client) => {
                            const clientSM = this.calculatePerpetualSM(client, year);
                            console.log(`${year} S&M for ${client.clientName}: ${this.formatCurrency(clientSM)} (Anniversary: ${client.anniversaryMonth || 'Not Set'})`);
                            return sum + clientSM;
                        }, 0);
                        
                        console.log(`${year} Total S&M Revenue: ${this.formatCurrency(smRevenue)}`);
                        
                        totalRevenue = (monthlyBilling * 12) + smRevenue;
                        monthlyAverage = monthlyBilling;
                    }
                    
                    return `
                        <div class="p-4 rounded-xl" style="background: rgba(15, 15, 35, 0.6); border: 1px solid rgba(148, 163, 184, 0.2);">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-white font-semibold text-lg">${year}</span>
                                <span class="text-blue-400 font-bold">${this.formatCurrency(totalRevenue)}</span>
                            </div>
                            <div class="text-xs space-y-1">
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Monthly Avg:</span>
                                    <span class="text-slate-300">${this.formatCurrency(monthlyAverage)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-400">S&M Revenue:</span>
                                    <span class="text-slate-300">${this.formatCurrency(smRevenue)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            getUSDInsights() {
                const usdClients = this.clients.filter(c => c.currency === 'USD' && c.isActive);
                const zarClients = this.clients.filter(c => c.currency === 'ZAR' && c.isActive);
                const exchangeRate = 18.5; // Approximate USD to ZAR exchange rate
                
                const usdTotalRevenue = usdClients.reduce((sum, client) => sum + (client.total || 0), 0);
                const zarTotalRevenue = zarClients.reduce((sum, client) => sum + (client.total || 0), 0);
                const zarEquivalentFromUsd = usdTotalRevenue * exchangeRate;
                
                const usdByModel = {
                    perpetual: usdClients.filter(c => c.billingModel === 'perpetual').reduce((sum, c) => sum + (c.total || 0), 0),
                    subscription: usdClients.filter(c => c.billingModel === 'subscription').reduce((sum, c) => sum + (c.total || 0), 0),
                    installment: usdClients.filter(c => c.billingModel === 'installment').reduce((sum, c) => sum + (c.total || 0), 0),
                    rentals: usdClients.filter(c => c.billingModel === 'rentals').reduce((sum, c) => sum + (c.total || 0), 0),
                    var: usdClients.filter(c => c.billingModel === 'var').reduce((sum, c) => sum + (c.total || 0), 0)
                };
                
                return `
                    <div class="bg-slate-700/50 rounded-xl p-4">
                        <h4 class="text-lg font-semibold text-white mb-4">USD Revenue Summary</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-400">Total USD Revenue:</span>
                                <span class="text-white font-semibold">$${usdTotalRevenue.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-400">ZAR Equivalent:</span>
                                <span class="text-green-400 font-semibold">R${zarEquivalentFromUsd.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-400">USD Clients:</span>
                                <span class="text-slate-300">${usdClients.length} active</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-400">Exchange Rate:</span>
                                <span class="text-slate-300">$1 = R${exchangeRate}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-700/50 rounded-xl p-4">
                        <h4 class="text-lg font-semibold text-white mb-4">USD by Billing Model</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-400">Perpetual:</span>
                                <span class="text-white font-semibold">$${usdByModel.perpetual.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-400">Subscription:</span>
                                <span class="text-white font-semibold">$${usdByModel.subscription.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-400">Instalment:</span>
                                <span class="text-white font-semibold">$${usdByModel.installment.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-400">VAR:</span>
                                <span class="text-white font-semibold">$${usdByModel.var.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            getInstalmentMonthlyOverview() {
                const instalmentClients = this.clients.filter(c => c.billingModel === 'installment' && c.isActive);
                
                if (instalmentClients.length === 0) {
                    return `
                        <div class="p-6 text-center">
                            <p class="text-slate-400">No instalment clients found</p>
                        </div>
                    `;
                }
                
                const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                return `
                    <table class="w-full">
                        <thead style="background: rgba(6, 63, 120, 0.4);">
                            <tr>
                                <th class="text-left py-4 px-6 font-semibold text-slate-300">Client</th>
                                <th class="text-right py-4 px-6 font-semibold text-slate-300">Users</th>
                                <th class="text-right py-4 px-6 font-semibold text-slate-300">Commission</th>
                                ${months.slice(0, 7).map(month => '<th class="text-right py-4 px-4 font-semibold text-slate-300 text-sm">' + monthNames[months.indexOf(month)] + '</th>').join('')}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-700">
                            ${instalmentClients.map(client => {
                                const currencySymbol = client.currency === 'USD' ? '$' : 'R';
                                return `
                                    <tr class="hover:bg-slate-700/30 transition-colors">
                                        <td class="py-4 px-6 text-white font-medium">
                                            ${client.clientName}
                                            <div class="text-xs text-slate-400">${client.debtCode || client.currency}</div>
                                        </td>
                                        <td class="py-4 px-6 text-right text-slate-300">${client.users || 0}</td>
                                        <td class="py-4 px-6 text-right">
                                            <span class="text-purple-400 font-medium">Fixed Payment</span>
                                        </td>
                                        ${months.slice(0, 7).map(month => {
                                            const amount = client[month] || 0;
                                            return '<td class="py-4 px-4 text-right text-white font-semibold text-sm">' + (amount > 0 ? currencySymbol + amount.toLocaleString() : '-') + '</td>';
                                        }).join('')}
                                    </tr>
                                `;
                            }).join('')}
                            <tr style="background: rgba(76, 29, 149, 0.2);">
                                <td class="py-4 px-6 font-bold text-white">TOTAL</td>
                                <td class="py-4 px-6 text-right font-bold text-slate-300">${instalmentClients.reduce((sum, c) => sum + (c.users || 0), 0)}</td>
                                <td class="py-4 px-6 text-right">
                                    <span class="text-purple-400 font-bold">-</span>
                                </td>
                                ${months.slice(0, 7).map(month => {
                                    const total = instalmentClients.reduce((sum, c) => sum + (c[month] || 0), 0);
                                    return '<td class="py-4 px-4 text-right font-bold text-purple-400 text-sm">' + (total > 0 ? 'R' + total.toLocaleString() : '-') + '</td>';
                                }).join('')}
                            </tr>
                        </tbody>
                    </table>
                `;
            }



            updateBillingOverview() {
                // Update the billing overview when filters change
                document.getElementById('billing-summary-cards').innerHTML = this.getBillingSummaryCards();
                document.getElementById('zar-monthly-billing-table').innerHTML = this.getMonthlyBillingTableByCurrency('ZAR');
                document.getElementById('usd-monthly-billing-table').innerHTML = this.getMonthlyBillingTableByCurrency('USD');
                document.getElementById('six-month-projections').innerHTML = this.getSixMonthProjections();
                document.getElementById('annual-comparison').innerHTML = this.getAnnualComparison();
                document.getElementById('billing-models-tables').innerHTML = this.getBillingModelTables();
            }

            // Billing Calculations
            calculatePerpetualSM(client, year) {
                const startYear = new Date(client.dealStartDate).getFullYear();
                const anniversaryMonth = client.anniversaryMonth || new Date(client.dealStartDate).getMonth() + 1; // Default to deal start month if not specified
                
                // S&M billing starts from Year 1 for existing perpetual clients
                // Only new additional licenses get Year 1 free
                
                // Calculate base S&M from original client contract
                let baseAmount = client.total || 0;
                
                // Apply annual increases to base amount
                // Find the earliest increase year and apply from that point forward
                const increases = this.getAnnualIncreases();
                if (increases.length > 0) {
                    const firstIncreaseYear = Math.min(...increases.map(inc => parseInt(inc.year)));
                    
                    if (year >= firstIncreaseYear) {
                        // Find the applicable increase for this year or the most recent one before it
                        let applicableIncrease = null;
                        for (let checkYear = year; checkYear >= firstIncreaseYear; checkYear--) {
                            const increase = increases.find(inc => parseInt(inc.year) === checkYear);
                            if (increase) {
                                applicableIncrease = increase;
                                break;
                            }
                        }
                        
                        if (applicableIncrease) {
                            const increaseMultiplier = 1 + (parseFloat(applicableIncrease.percentage) / 100);
                            baseAmount *= increaseMultiplier;
                            console.log('Applied', applicableIncrease.percentage + '% increase for year', year + ', multiplier:', increaseMultiplier + ', new base:', baseAmount.toLocaleString());
                        }
                    }
                }
                
                // Add S&M from additional licenses with proper prorated billing logic
                if (client.billingModel === 'perpetual') {
                    const clientAdditionalLicenses = this.additionalLicenses.filter(license => 
                        license.clientId === client.id && license.isActive
                    );
                    
                    console.log(`${client.clientName} has ${clientAdditionalLicenses.length} additional licenses for year ${year}`);
                    
                    clientAdditionalLicenses.forEach(license => {
                        const licenseStartDate = new Date(license.startDate);
                        const licenseStartYear = licenseStartDate.getFullYear();
                        const licenseStartMonth = licenseStartDate.getMonth() + 1; // 1-based month
                        const licenseValue = (license.quantity || 0) * (license.pricePerUnit || 0);
                        
                        // For EXISTING clients: S&M billing starts from Year 1 (no free year)
                        // Free year only applies to NEW clients, not existing perpetual clients adding licenses
                        if (year === licenseStartYear) {
                            // Calculate prorated amount for remaining months in first year
                            let proratedAmount = 0;
                            let monthsToCalculate = 0;
                            
                            if (licenseStartMonth <= anniversaryMonth) {
                                // License added before anniversary - calculate from license start month to anniversary
                                // August license (month 8) with October anniversary (month 10) = 1 month (Sept-Oct partial)
                                monthsToCalculate = anniversaryMonth - licenseStartMonth;
                                console.log(`Year ${year} EXISTING CLIENT: License added before anniversary (${anniversaryMonth}): calculating ${monthsToCalculate} months from month ${licenseStartMonth} to ${anniversaryMonth}`);
                            } else {
                                // License added after anniversary - calculate to next anniversary  
                                monthsToCalculate = (12 - licenseStartMonth) + anniversaryMonth;
                                console.log(`Year ${year} EXISTING CLIENT: License added after anniversary (${anniversaryMonth}): calculating ${monthsToCalculate} months`);
                            }
                            
                            if (monthsToCalculate > 0) {
                                proratedAmount = (licenseValue * monthsToCalculate) / 12;
                                console.log(`Year ${year} Prorated amount for ${monthsToCalculate} months: R${proratedAmount.toLocaleString()} (from R${licenseValue.toLocaleString()} annual)`);
                                baseAmount += proratedAmount;
                            }
                            return; // Year 1 processing complete
                        }
                        
                        // Year 2: Remaining prorated billing to complete alignment with anniversary
                        if (year === licenseStartYear + 1) {
                            let proratedAmount = 0;
                            let monthsToCalculate = 0;
                            
                            if (licenseStartMonth <= anniversaryMonth) {
                                // License added before anniversary - calculate remaining months to complete the year cycle
                                // Year 1 already paid partial (licenseStartMonth to anniversary)
                                // Year 2 should pay the balance (anniversary+1 to next anniversary = 11 months)
                                monthsToCalculate = 12 - (anniversaryMonth - licenseStartMonth);
                                console.log(`Year 2: License added before anniversary (${anniversaryMonth}): calculating remaining ${monthsToCalculate} months to complete cycle`);
                            } else {
                                // License added after anniversary - should be 0 for year 2 since full cycle was in year 1
                                monthsToCalculate = 0;
                                console.log(`Year 2: License added after anniversary (${anniversaryMonth}): no additional billing needed, full cycle in year 1`);
                            }
                            
                            if (monthsToCalculate > 0) {
                                // Use base license value without any increases for prorated billing
                                proratedAmount = (licenseValue * monthsToCalculate) / 12;
                                console.log(`Year 2 Prorated amount for ${monthsToCalculate} months: R${proratedAmount.toLocaleString()} (from R${licenseValue.toLocaleString()} annual - NO INCREASES)`);
                            }
                            
                            baseAmount += proratedAmount;
                        }
                        
                        // Year 3+: Full 12-month billing at base rate (aligned, no increases unless specifically applied)
                        if (year >= licenseStartYear + 2) {
                            // Use base license value - increases should only be applied when specifically set
                            let alignedLicenseValue = licenseValue;
                            console.log(`Year ${year}: Full 12-month billing for additional license: R${alignedLicenseValue.toLocaleString()} (NO AUTOMATIC INCREASES)`);
                            baseAmount += alignedLicenseValue;
                        }
                    });
                }
                
                console.log(`${client.clientName} Year ${year} Total S&M: ${this.formatCurrency(baseAmount)} (Base: ${this.formatCurrency(client.total || 0)})`);
                
                return baseAmount;
            }

            calculateProratedLicense(license, client) {
                if (!license || !client) {
                    console.warn('calculateProratedLicense: Missing license or client data');
                    return 0;
                }
                
                if (!license.startDate || !client.dealStartDate) {
                    console.warn('calculateProratedLicense: Missing required date fields');
                    return (license.quantity || 0) * (license.pricePerUnit || 0);
                }
                
                try {
                    const licenseStart = new Date(license.startDate);
                    const clientStart = new Date(client.dealStartDate);
                    const anniversaryMonth = client.anniversaryMonth || new Date(client.dealStartDate).getMonth() + 1;
                    
                    // Calculate prorated amount to align with anniversary
                    const licenseAmount = (license.quantity || 0) * (license.pricePerUnit || 0);
                    
                    // For first year, no billing if client is in year 1
                    if (licenseStart.getFullYear() === clientStart.getFullYear()) {
                        return 0;
                    }
                    
                    // Calculate prorated billing
                    const monthsToAnniversary = this.getMonthsToAnniversary ? this.getMonthsToAnniversary(licenseStart, anniversaryMonth) : 6;
                    const proratedAmount = licenseAmount * (monthsToAnniversary / 12);
                    
                    return proratedAmount;
                } catch (error) {
                    console.error('calculateProratedLicense error:', error);
                    return (license.quantity || 0) * (license.pricePerUnit || 0);
                }
            }

            getMonthsToAnniversary(startDate, anniversaryMonth) {
                const start = new Date(startDate);
                const currentMonth = start.getMonth() + 1;
                
                console.log('Calculating months to anniversary: Start month', currentMonth, 'Anniversary month', anniversaryMonth);
                
                let monthsToAnniversary;
                if (currentMonth <= anniversaryMonth) {
                    monthsToAnniversary = anniversaryMonth - currentMonth;
                } else {
                    monthsToAnniversary = (12 - currentMonth) + anniversaryMonth;
                }
                
                console.log('Months to anniversary:', monthsToAnniversary);
                return monthsToAnniversary;
            }

            // Navigation
            showPage(page) {
                try {
                    console.log('Navigating to page:', page);
                    this.currentPage = page;
                    
                    // Update navigation
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.remove('text-white', 'shadow-lg'); item.style.background = ''; item.style.boxShadow = '';
                        item.classList.add('text-slate-300', 'hover:text-white'); item.onmouseenter = () => item.style.background = 'rgba(6, 63, 120, 0.3)'; item.onmouseleave = () => {if(!item.classList.contains('shadow-lg')) item.style.background='';};
                    });
                    
                    const activeItem = document.querySelector('[data-page="' + page + '"]');
                    if (activeItem) {
                        activeItem.classList.remove('text-slate-300', 'hover:text-white', 'hover:bg-slate-700');
                        activeItem.classList.add('text-white', 'shadow-lg'); activeItem.style.background = 'linear-gradient(135deg, #4c1d95, #003366)'; activeItem.style.boxShadow = '0 10px 25px rgba(76, 29, 149, 0.3)';
                    }

                    // Load page content with error handling
                    console.log('Getting content for page:', page);
                    const content = this.getPageContent(page);
                    
                    console.log('Content length:', content.length);
                    const contentArea = document.getElementById('content-area');
                    if (contentArea) {
                        contentArea.innerHTML = content;
                        console.log('Content loaded successfully');
                    } else {
                        console.error('Content area not found');
                    }
                    
                    // Initialize page-specific functionality
                    this.initializePage(page);
                    console.log('Page navigation completed successfully');
                    
                } catch (error) {
                    console.error('Error navigating to page:', page, error);
                    console.error('Error loading page, please refresh');
                }
            }

            getPageContent(page) {
                try {
                    console.log('Getting content for:', page);
                    
                    switch(page) {
                        case 'dashboard':
                            console.log('Loading dashboard content');
                            return this.getDashboardContent();
                        case 'clients':
                            console.log('Loading clients content, client count:', this.clients.length);
                            return this.getClientsContent();
                        case 'billing':
                            console.log('Loading billing content');
                            return this.getBillingContent();
                        case 'licenses':
                            console.log('Loading licenses content, license count:', this.additionalLicenses.length);
                            return this.getLicensesContent();
                        case 'vars':
                            console.log('Loading vars content');
                            return this.getVarsContent();
                        case 'analytics':
                            console.log('Loading analytics content');
                            return this.getAnalyticsContent();
                        case 'billing-overview':
                            console.log('Loading billing overview content');
                            return this.getBillingOverviewContent();
                        case 'reports':
                            console.log('Loading reports content');
                            return this.getReportsContent();
                        default:
                            console.log('Unknown page, loading dashboard');
                            return this.getDashboardContent();
                    }
                } catch (error) {
                    console.error('Error getting content for page:', page, error);
                    return `<div class="p-8"><h1 class="text-white text-2xl">Error Loading Page</h1><p class="text-slate-400">An error occurred while loading the ${page} page. Please check the console and refresh.</p></div>`;
                }
            }

            getDashboardContent() {
                const metrics = this.calculateDashboardMetrics();
                
                return `
                    <div class="p-8 animate-fade-in">
                        <div class="mb-8">
                            <div class="flex items-center mb-4">
                                <svg class="w-8 h-8 mr-3" style="color: #4c1d95;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l-1-3m1 3l-1-3m-9.5 0h9.5M6.75 7.5l3 2.25-3 2.25m4.5-4.5v4.5"/></svg>
                                <h1 class="text-4xl font-bold text-white">Dashboard Overview</h1>
                            </div>
                            <p class="text-lg" style="color: rgba(148, 163, 184, 0.8);">Professional billing management with advanced S&M calculations</p>
                        </div>

                       <!-- Key Metrics Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    
    <div class="p-6 rounded-2xl card-hover" style="background: linear-gradient(135deg, #0f0f23 0%, #1e1b4b 100%); border: 1px solid rgba(76, 29, 149, 0.4);">
        <p class="text-sm font-medium mb-1 text-gray-400">Total Licenses</p>
        <p class="text-3xl font-bold text-white">${this.formatNumber(metrics.totalLicenses)}</p>
        <p class="text-sm mt-2 text-gray-400">Active licenses</p>
    </div>

    <div class="p-6 rounded-2xl card-hover" style="background: linear-gradient(135deg, #16213e 0%, #0f172a 100%); border: 1px solid rgba(76, 29, 149, 0.4);">
        <p class="text-sm font-medium mb-1 text-gray-400">Monthly Billing</p>
        <p class="text-3xl font-bold text-white">${this.formatCurrency(metrics.monthlyBilling)}</p>
        <p class="text-sm mt-2 text-gray-400">Current month</p>
    </div>

    <div class="p-6 rounded-2xl card-hover" style="background: linear-gradient(135deg, #1a1a2e 0%, #1e1b4b 100%); border: 1px solid rgba(76, 29, 149, 0.4);">
        <p class="text-sm font-medium mb-1 text-gray-400">Active Clients</p>
        <p class="text-3xl font-bold text-white">${this.formatNumber(metrics.activeClients)}</p>
        <p class="text-sm mt-2 text-gray-400">Paying customers</p>
    </div>

    <div class="p-6 rounded-2xl card-hover" style="background: linear-gradient(135deg, rgba(8, 32, 79, 0.4) 0%, rgba(3, 46, 102, 0.4) 100%); border: 1px solid rgba(76, 29, 149, 0.3);">
        <p class="text-sm font-medium mb-1 text-gray-400">S&M Revenue</p>
        <p class="text-3xl font-bold text-white">${this.formatCurrency(metrics.smRevenue)}</p>
        <p class="text-sm mt-2 text-gray-400">Support & Maintenance</p>
    </div>

</div>


                        <!-- Billing Model Breakdown -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <h3 class="text-xl font-semibold text-white mb-4">Revenue by Model</h3>
                                <div class="space-y-4">
                                    ${metrics.modelBreakdown.map(model => `
                                        <div class="flex items-center justify-between p-4 rounded-xl" style="background: rgba(6, 63, 120, 0.3);">
                                            <div class="flex items-center space-x-3">
                                                <div class="w-3 h-3 rounded-full" style="background-color: ${model.color};"></div>
                                                <span class="text-slate-300 capitalize">${model.name}</span>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-white font-semibold">${this.formatCurrency(model.revenue)}</div>
                                                <div class="text-xs" style="color: rgba(148, 163, 184, 0.6);">${model.clients} clients</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <h3 class="text-xl font-semibold text-white mb-4">Currency Distribution</h3>
                                <div class="space-y-4">
                                    ${metrics.currencyBreakdown.map(currency => `
                                        <div class="flex items-center justify-between p-4 rounded-xl" style="background: rgba(6, 63, 120, 0.3);">
                                            <div class="flex items-center space-x-3">
                                                <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background: rgba(76, 29, 149, 0.2);">
                                                    <span class="text-xs font-bold" style="color: #4c1d95;">${currency.code}</span>
                                                </div>
                                                <span class="text-slate-300">${currency.name}</span>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-white font-semibold">${this.formatCurrency(currency.amount, currency.code)}</div>
                                                <div class="text-xs" style="color: rgba(76, 29, 149, 0.6);">${currency.percentage}%</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="card-glass rounded-2xl p-6 border border-slate-600/30">
                            <h3 class="text-xl font-semibold text-white mb-4">Quick Actions</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- Removed Add License button - functionality moved to Client Management -->
                                <button onclick="app.showPage('clients')" class="p-4 bg-slate-700/40 hover:bg-slate-600/60 rounded-xl hover-lift text-center group border border-slate-600/30 backdrop-blur-sm">
                                    <svg class="w-8 h-8 mb-3 mx-auto group-hover:scale-110 transition-transform" style="color: #4c1d95;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M18 7.5v3m0 0V18a2.25 2.25 0 01-2.25 2.25h-11.5A2.25 2.25 0 012 18V6a2.25 2.25 0 012.25-2.25H15m3 2.5l-3-2.5v2.25a.75.75 0 001.5 0V7.5z"/><path d="M15.75 7.5H18v2.25m0 0V18a2.25 2.25 0 01-2.25 2.25h-11.5A2.25 2.25 0 012 18V6a2.25 2.25 0 012.25-2.25H15"/></svg>
                                    <div class="text-white font-medium">Add Client</div>
                                </button>
                                <button onclick="app.showPage('analytics')" class="p-4 bg-slate-700/40 hover:bg-slate-600/60 rounded-xl hover-lift text-center group border border-slate-600/30 backdrop-blur-sm">
                                    <svg class="w-8 h-8 mb-3 mx-auto group-hover:scale-110 transition-transform" style="color: #4c1d95;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l-1-3m1 3l-1-3m-9.5 0h9.5M6.75 7.5l3 2.25-3 2.25m4.5-4.5v4.5"/></svg>
                                    <div class="text-white font-medium">View Analytics</div>
                                </button>
                                <button onclick="app.showPage('reports')" class="p-4 bg-slate-700/40 hover:bg-slate-600/60 rounded-xl hover-lift text-center group border border-slate-600/30 backdrop-blur-sm">
                                    <svg class="w-8 h-8 mb-3 mx-auto group-hover:scale-110 transition-transform" style="color: #4c1d95;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
                                    <div class="text-white font-medium">Export Reports</div>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            calculateDashboardMetrics() {
                const currentYear = new Date().getFullYear();
                const totalLicenses = this.clients.reduce((sum, client) => sum + (client.users || 0), 0);
                const activeClients = this.clients.filter(client => client.isActive).length;
                
                // Calculate monthly billing based on model
                let monthlyBilling = 0;
                this.clients.forEach(client => {
                    switch(client.billingModel) {
                        case 'subscription':
                            const frequency = client.billingFrequency || 'annually';
                            let divisor = 1;
                            switch(frequency) {
                                case 'monthly': divisor = 1; break;
                                case 'quarterly': divisor = 3; break;
                                case 'semi-annually': divisor = 6; break;
                                case 'annually': divisor = 12; break;
                            }
                            monthlyBilling += (client.total || 0) / divisor;
                            break;
                        case 'var':
                            monthlyBilling += ((client.total || 0) * (client.commissionRate || 20) / 100) / 12;
                            break;
                        case 'installment':
                            const installmentMonths = client.installmentMonths || 12;
                            monthlyBilling += (client.total || 0) / installmentMonths;
                            break;
                        case 'rentals':
                            monthlyBilling += (client.total || 0) * (client.monthlyFactor || 0.08);
                            break;
                        case 'perpetual':
                            monthlyBilling += (client.total || 0) / 12;
                            break;
                    }
                });

                // Calculate S&M revenue for perpetual licenses 
                let smRevenue = this.clients.filter(c => c.billingModel === 'perpetual').reduce((sum, client) => sum + (client.total || 0), 0);

                // Model breakdown
                const modelBreakdown = [
                    {
                        name: 'Perpetual',
                        color: '#4c1d95',
                        clients: this.clients.filter(c => c.billingModel === 'perpetual').length,
                        revenue: this.clients.filter(c => c.billingModel === 'perpetual').reduce((sum, c) => sum + (c.total || 0), 0)
                    },
                    {
                        name: 'Subscription',
                        color: '#7c3aed',
                        clients: this.clients.filter(c => c.billingModel === 'subscription').length,
                        revenue: this.clients.filter(c => c.billingModel === 'subscription').reduce((sum, c) => sum + (c.total || 0), 0)
                    },
                    {
                        name: 'VAR',
                        color: '#a855f7',
                        clients: this.clients.filter(c => c.billingModel === 'var').length,
                        revenue: this.clients.filter(c => c.billingModel === 'var').reduce((sum, c) => sum + (c.total || 0), 0)
                    },
                    {
                        name: 'Instalment',
                        color: '#c084fc',
                        clients: this.clients.filter(c => c.billingModel === 'installment').length,
                        revenue: this.clients.filter(c => c.billingModel === 'installment').reduce((sum, c) => sum + (c.total || 0), 0)
                    },
                    {
                        name: 'Rentals',
                        color: '#8b5cf6',
                        clients: this.clients.filter(c => c.billingModel === 'rentals').length,
                        revenue: this.clients.filter(c => c.billingModel === 'rentals').reduce((sum, c) => sum + (c.total || 0), 0)
                    }
                ];

                // Currency breakdown
                const currencyMap = {};
                this.clients.forEach(client => {
                    if (!currencyMap[client.currency]) {
                        currencyMap[client.currency] = {
                            code: client.currency,
                            name: this.getCurrencyName(client.currency),
                            amount: 0
                        };
                    }
                    currencyMap[client.currency].amount += (client.total || 0);
                });

                const totalRevenue = Object.values(currencyMap).reduce((sum, c) => sum + c.amount, 0);
                const currencyBreakdown = Object.values(currencyMap).map(currency => ({
                    ...currency,
                    percentage: ((currency.amount / totalRevenue) * 100).toFixed(1)
                }));

                return {
                    totalLicenses,
                    monthlyBilling,
                    activeClients,
                    smRevenue,
                    modelBreakdown,
                    currencyBreakdown
                };
            }

            getCurrencyName(code) {
                const currencies = {
                    'ZAR': 'South African Rand',
                    'USD': 'US Dollar',
                    'EUR': 'Euro',
                    'GBP': 'British Pound',
                    'CAD': 'Canadian Dollar',
                    'AUD': 'Australian Dollar',
                    'JPY': 'Japanese Yen'
                };
                return currencies[code] || code;
            }

            getBillingModelDisplayName(model) {
                const modelNames = {
                    'perpetual': 'Perpetual',
                    'subscription': 'Subscription',
                    'installment': 'Instalment',
                    'var': 'VAR'
                };
                return modelNames[model] || (model ? model.charAt(0).toUpperCase() + model.slice(1) : 'Unknown');
            }

            getMonthKey(monthNumber) {
                const monthKeys = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                return monthKeys[monthNumber - 1];
            }

            calculateClientTotal(client) {
                return (client.jan || 0) + (client.feb || 0) + (client.mar || 0) + (client.apr || 0) + 
                       (client.may || 0) + (client.jun || 0) + (client.jul || 0) + (client.aug || 0) + 
                       (client.sep || 0) + (client.oct || 0) + (client.nov || 0) + (client.dec || 0);
            }

            getClientsContent() {
                try {
                    console.log('Getting clients content, clients count:', this.clients ? this.clients.length : 'undefined');
                    if (!this.clients) {
                        console.error('Clients array is undefined');
                        return '<div class="p-8"><h1 class="text-white">No clients data found. Please refresh.</h1></div>';
                    }
                    return `
                        <div class="p-8 animate-fade-in">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-4xl font-bold text-white mb-2">Client Management</h1>
            <p style="color: rgba(148, 163, 184, 0.8);" class="text-lg">Manage clients across all billing models with S&M calculations</p>
        </div>
        <div class="flex space-x-4">
            <div class="flex items-center space-x-4">
                <!-- Year & Annual Increase Controls -->
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium" style="color: rgba(148, 163, 184, 0.9);">Year:</label>
                    <select id="increaseYear" class="px-3 py-2 rounded-lg font-semibold" style="background: rgba(6, 63, 120, 0.3); border: 1px solid rgba(148, 163, 184, 0.4); color: #94a3b8;" onchange="app.updateIncreaseYear(this.value)">
                        <option value="2025" ${this.increaseYear === 2025 ? 'selected' : ''}>2025</option>
                        <option value="2026" ${this.increaseYear === 2026 ? 'selected' : ''}>2026</option>
                        <option value="2027" ${this.increaseYear === 2027 ? 'selected' : ''}>2027</option>
                        <option value="2028" ${this.increaseYear === 2028 ? 'selected' : ''}>2028</option>
                        <option value="2029" ${this.increaseYear === 2029 ? 'selected' : ''}>2029</option>
                    </select>
                </div>
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium" style="color: rgba(148, 163, 184, 0.9);">Annual Increase:</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="globalAnnualIncrease" step="any" min="0" max="50" value="${this.globalAnnualIncrease || 5.0}" class="w-24 px-3 py-2 rounded-lg text-center font-semibold" style="background: rgba(6, 63, 120, 0.3); border: 1px solid rgba(148, 163, 184, 0.4); color: #94a3b8;" onchange="app.updateGlobalAnnualIncrease(this.value)" placeholder="5.5">
                        <span class="text-sm" style="color: rgba(148, 163, 184, 0.9);">%</span>
                        <button onclick="app.applyAnnualIncrease()" class="px-4 py-2 rounded-lg font-semibold text-sm transition-all hover:scale-105" style="background: linear-gradient(135deg, rgba(76, 29, 149, 0.8), rgba(55, 48, 163, 0.8)); color: white; border: none;" onmouseover="this.style.background='linear-gradient(135deg, rgba(76, 29, 149, 1), rgba(55, 48, 163, 1))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(76, 29, 149, 0.8), rgba(55, 48, 163, 0.8))'">
                            Apply
                        </button>
                        <button onclick="app.clearAnnualIncreases()" class="px-3 py-2 rounded-lg font-semibold text-sm transition-all" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.4);" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
                            Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Buttons moved below increases -->
    <div class="flex space-x-4 mt-4">
        <button onclick="openAddClientModal()" 
            class="flex-1 flex items-center justify-center text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 text-sm shadow-lg hover:shadow-xl" 
            style="background: linear-gradient(135deg, #4c1d95, #4c1d95);" 
            onmouseover="this.style.background='linear-gradient(135deg, #003366, #4c1d95)'" 
            onmouseout="this.style.background='linear-gradient(135deg, #4c1d95, #4c1d95)'">
            Add New Client
        </button>

        <button onclick="openAddLicenseModal()" 
            class="flex-1 flex items-center justify-center text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 text-sm shadow-lg hover:shadow-xl" 
            style="background: linear-gradient(135deg, rgba(0, 51, 102, 0.8), rgba(76, 29, 149, 0.8));" 
            onmouseover="this.style.background='linear-gradient(135deg, rgba(0, 51, 102, 1), rgba(76, 29, 149, 1))'" 
            onmouseout="this.style.background='linear-gradient(135deg, rgba(0, 51, 102, 0.8), rgba(76, 29, 149, 0.8))'">
            Add Additional License
        </button>
    </div>
</div>


                        <!-- Client Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(76, 29, 149, 0.2);">
                                        <svg class="w-6 h-6" style="color: #4c1d95;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159-.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z"/></svg>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-white">${this.clients.filter(c => c.billingModel === 'perpetual').length}</div>
                                        <div style="color: rgba(148, 163, 184, 0.6);" class="text-sm">Perpetual</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(76, 29, 149, 0.2);">
                                        <svg class="w-6 h-6" style="color: #4c1d95;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"/></svg>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-white">${this.clients.filter(c => c.billingModel === 'subscription').length}</div>
                                        <div style="color: rgba(148, 163, 184, 0.6);" class="text-sm">Subscription</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(76, 29, 149, 0.2);">
                                        <svg class="w-6 h-6" style="color: #4c1d95;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/></svg>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-white">${this.clients.filter(c => c.billingModel === 'var').length}</div>
                                        <div style="color: rgba(148, 163, 184, 0.6);" class="text-sm">VAR Partners</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(76, 29, 149, 0.2);">
                                        <svg class="w-6 h-6" style="color: #4c1d95;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M12 6v12m6-6H6"/></svg>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-white">${this.clients.filter(c => c.billingModel === 'installment').length}</div>
                                        <div style="color: rgba(148, 163, 184, 0.6);" class="text-sm">Instalment</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Second row of stats for Rentals -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(76, 29, 149, 0.2);">
                                        <svg class="w-6 h-6" style="color: #4c1d95;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-18M2.25 9l4.5-1.636M18.75 3l-1.5.545m0 6.205 3 1m1.5.5-1.5-.5M6.75 7.364V3h-3v18m3-13.636 10.5-3.819"/></svg>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-white">${this.clients.filter(c => c.billingModel === 'rentals').length}</div>
                                        <div style="color: rgba(148, 163, 184, 0.6);" class="text-sm">Rentals</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(76, 29, 149, 0.2);">
                                        <svg class="w-6 h-6" style="color: #4c1d95;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-white">${this.formatCurrency(this.clients.reduce((sum, c) => sum + (c.total || 0), 0), 'ZAR')}</div>
                                        <div style="color: rgba(148, 163, 184, 0.6);" class="text-sm">Total Revenue</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(76, 29, 149, 0.2);">
                                        <svg class="w-6 h-6" style="color: #4c1d95;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z"/></svg>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-white">${this.clients.reduce((sum, c) => sum + (c.users || 0), 0)}</div>
                                        <div style="color: rgba(148, 163, 184, 0.6);" class="text-sm">Total Users</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(76, 29, 149, 0.2);">
                                        <svg class="w-6 h-6" style="color: #4c1d95;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-white">${this.clients.filter(c => c.status === 'Active').length}</div>
                                        <div style="color: rgba(148, 163, 184, 0.6);" class="text-sm">Active Clients</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Search Bar -->
                        <div class="mb-6">
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                        <path d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"/>
                                    </svg>
                                </div>
                                <input type="text" id="client-search" placeholder="Search clients by name, debt code, or comments..." 
                                       class="block w-full pl-10 pr-3 py-3 border border-slate-700/60 rounded-xl bg-slate-900/80 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent backdrop-blur-sm" 
                                       onkeyup="app.filterClients(this.value)">
                            </div>
                        </div>

                        <!-- Clients Table -->
                        <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl border border-slate-700 overflow-hidden mb-8">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead style="background: rgba(6, 63, 120, 0.4);">
                                        <tr>
                                            <th class="text-left py-4 px-6 font-semibold text-slate-300">Client & Debt Code</th>
                                            <th class="text-left py-4 px-6 font-semibold text-slate-300">Users</th>
                                            <th class="text-left py-4 px-6 font-semibold text-slate-300">Annual Total</th>
                                            <th class="text-left py-4 px-6 font-semibold text-slate-300">Anniversary Month</th>
                                            <th class="text-left py-4 px-6 font-semibold text-slate-300">Comments</th>
                                            <th class="text-left py-4 px-6 font-semibold text-slate-300">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-700">
                                        ${this.clients.map(client => {
                                            try {
                                                console.log('Rendering client:', client.clientName, 'debt code:', client.debtCode);
                                                const monthsData = [
                                                    {name: 'Jan', value: client.jan}, {name: 'Feb', value: client.feb}, {name: 'Mar', value: client.mar},
                                                    {name: 'Apr', value: client.apr}, {name: 'May', value: client.may}, {name: 'Jun', value: client.jun},
                                                    {name: 'Jul', value: client.jul}, {name: 'Aug', value: client.aug}, {name: 'Sep', value: client.sep},
                                                    {name: 'Oct', value: client.oct}, {name: 'Nov', value: client.nov}, {name: 'Dec', value: client.dec}
                                                ];
                                                const anniversaryMonth = monthsData.find(m => m.value > 0);
                                                
                                                return `
                                                    <tr class="hover:bg-slate-700/30 transition-colors">
                                                        <td class="py-4 px-6">
                                                            <div class="flex items-center space-x-3">
                                                                <div class="w-10 h-10 bg-gradient-to-br from-purple-500/20 to-blue-500/20 rounded-xl flex items-center justify-center">
                                                                    <svg class="w-5 h-5 text-blue-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                                                        <path d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z"/>
                                                                    </svg>
                                                                </div>
                                                                <div>
                                                                    <div class="font-semibold text-white">${client.clientName || 'Unknown'}</div>
                                                                    <div class="text-sm text-slate-400">${client.debtCode || 'No Code'}</div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td class="py-4 px-6 text-white font-semibold">${this.formatNumber ? this.formatNumber(client.users || 0) : (client.users || 0)}</td>
                                                        <td class="py-4 px-6">
                                                            <div class="text-white font-semibold">${this.formatCurrency ? this.formatCurrency(client.total || 0, client.currency || 'ZAR') : (client.total || 0)}</div>
                                                            <div class="text-xs text-slate-400">${client.currency || 'ZAR'}</div>
                                                        </td>
                                                        <td class="py-4 px-6">
                                                            <div class="text-white">${anniversaryMonth ? anniversaryMonth.name : 'None'}</div>
                                                            <div class="text-xs text-slate-400">${anniversaryMonth ? this.formatCurrency(anniversaryMonth.value, client.currency || 'ZAR') : '-'}</div>
                                                        </td>
                                                        <td class="py-4 px-6">
                                                            <div class="text-sm text-slate-300 max-w-sm" title="${client.comments || 'No comments'}">
                                                                ${client.comments ? client.comments.split('\n').map(comment => 
                                                                    `<div class="mb-1 ${comment.includes('Added') && comment.includes('licenses') ? 'text-green-400 font-medium' : 'text-slate-400'}">${comment}</div>`
                                                                ).join('') : '<div class="text-slate-500">No comments</div>'}
                                                            </div>
                                                        </td>
                                                        <td class="py-4 px-6">
                                                            <div class="flex space-x-2">
                                                                <button onclick="app.openClientIncreaseModal('${client.id || ''}')" class="text-gray-400 hover:text-gray-300 transition-colors p-1 rounded-lg hover:bg-gray-500/10" title="Apply Individual Increase">
                                                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                                                        <path d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                                    </svg>
                                                                </button>
                                                                <button onclick="app.editClient('${client.id || ''}')" class="text-gray-400 hover:text-gray-300 transition-colors p-1 rounded-lg hover:bg-gray-500/10" title="Edit">
                                                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                                                        <path d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"/>
                                                                    </svg>
                                                                </button>
                                                                <button onclick="app.deleteClient('${client.id || ''}')" class="text-gray-400 hover:text-gray-300 transition-colors p-1 rounded-lg hover:bg-gray-500/10" title="Delete">
                                                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                                                        <path d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"/>
                                                                    </svg>
                                                                </button>
                                                                <button onclick="app.viewClientDetails('${client.id || ''}')" class="text-gray-400 hover:text-gray-300 transition-colors p-1 rounded-lg hover:bg-gray-500/10" title="View Monthly Details">
                                                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                                                        <path d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z"/>
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                `;
                                            } catch (clientError) {
                                                console.error('Error rendering client:', client, clientError);
                                                return '<tr><td colspan="6" class="py-4 px-6 text-red-400">Error rendering client data</td></tr>';
                                            }
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                } catch (error) {
                    console.error('Error in getClientsContent:', error);
                    return '<div class="p-8"><h1 class="text-white">Error loading clients content. Please refresh.</h1></div>';
                }
            }

            getBillingContent() {
                return `
                    <div class="p-8 animate-fade-in">
                        <div class="flex items-center justify-between mb-8">
                            <div>
                                <h1 class="text-4xl font-bold text-white mb-2">Billing Models</h1>
                                <p class="text-slate-400 text-lg">Professional billing approaches with advanced S&M calculations</p>
                            </div>
                            <button onclick="openBillingConfigModal()" class="text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 flex items-center space-x-2 shadow-lg hover:shadow-xl" style="background: linear-gradient(135deg, #4c1d95, #003366);" onmouseover="this.style.background='linear-gradient(135deg, #003366, #4c1d95)'" onmouseout="this.style.background='linear-gradient(135deg, #4c1d95, #003366)'">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                    <path d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"/>
                                    <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span>Configure Models</span>
                            </button>
                        </div>

                        <div class="flex flex-col space-y-8 mb-8">
                            <!-- Perpetual License -->
                            <div class="p-8 rounded-2xl card-hover" style="background: linear-gradient(135deg, rgba(6, 63, 120, 0.2) 0%, rgba(1, 99, 148, 0.3) 100%); border: 1px solid rgba(76, 29, 149, 0.3);">
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(76, 29, 149, 0.2);">
                                            <svg class="w-6 h-6" style="color: #4c1d95;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159-.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z"/></svg>
                                        </div>
                                        <h3 class="text-2xl font-bold text-white">Perpetual License</h3>
                                    </div>
                                    <button onclick="editBillingModel('perpetual')" class="p-2 rounded-lg hover:bg-white/10 transition-colors" title="Edit Perpetual Model">
                                        <svg class="w-4 h-4 text-slate-400 hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                            <path d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"/>
                                        </svg>
                                    </button>
                                </div>
                                <p class="mb-6" style="color: rgba(148, 163, 184, 0.8);">One-time purchase with annual Support & Maintenance</p>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center py-2 border-b border-white/20">
                                        <span class="text-white">Year 1 S&M</span>
                                        <span class="text-white font-semibold">FREE</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-white/20">
                                        <span class="text-white">Year ≥2 S&M</span>
                                        <span class="text-white font-semibold">Base × (1 + Increase%)</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-white/20">
                                        <span class="text-white">Additional Licenses</span>
                                        <span class="text-white font-semibold">Prorated to Anniversary</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="text-white">Annual Increases</span>
                                        <span class="text-white font-semibold">Global Application</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Subscription -->
                            <div class="p-8 rounded-2xl card-hover" style="background: linear-gradient(135deg, rgba(0, 51, 102, 0.2) 0%, rgba(76, 29, 149, 0.3) 100%); border: 1px solid rgba(76, 29, 149, 0.3);">
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(76, 29, 149, 0.2);">
                                            <svg class="w-6 h-6" style="color: #4c1d95;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"/></svg>
                                        </div>
                                        <h3 class="text-2xl font-bold text-white">Subscription</h3>
                                    </div>
                                    <button onclick="editBillingModel('subscription')" class="p-2 rounded-lg hover:bg-white/10 transition-colors" title="Edit Subscription Model">
                                        <svg class="w-4 h-4 text-slate-400 hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                            <path d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"/>
                                        </svg>
                                    </button>
                                </div>
                                <p class="mb-6" style="color: rgba(148, 163, 184, 0.8);">Recurring payments with flexible frequency options</p>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center py-2 border-b border-blue-500/20">
                                        <span class="text-white/80">Monthly</span>
                                        <span class="text-white font-semibold">Full Amount</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-blue-500/20">
                                        <span class="text-white/80">Quarterly</span>
                                        <span class="text-white font-semibold">Amount ÷ 3</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-blue-500/20">
                                        <span class="text-white/80">Semi-Annually</span>
                                        <span class="text-white font-semibold">Amount ÷ 6</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="text-white/80">Annually</span>
                                        <span class="text-white font-semibold">Amount ÷ 12</span>
                                    </div>
                                </div>
                            </div>

                            <!-- VAR Model -->
                            <div class="p-8 rounded-2xl card-hover" style="background: linear-gradient(135deg, rgba(0, 51, 102, 0.3) 0%, rgba(76, 29, 149, 0.4) 100%); border: 1px solid rgba(76, 29, 149, 0.3);">
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(76, 29, 149, 0.2);">
                                            <svg class="w-6 h-6" style="color: #4c1d95;" fill="currentColor" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                                        </div>
                                        <h3 class="text-2xl font-bold text-white">VAR Partnership</h3>
                                    </div>
                                    <button onclick="editBillingModel('var')" class="p-2 rounded-lg hover:bg-white/10 transition-colors" title="Edit VAR Model">
                                        <svg class="w-4 h-4 text-slate-400 hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                            <path d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"/>
                                        </svg>
                                    </button>
                                </div>
                                <p class="mb-6" style="color: rgba(148, 163, 184, 0.8);">Value Added Reseller with commission-based revenue</p>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center py-2 border-b border-white/20">
                                        <span class="text-white/70">Commission Rate</span>
                                        <span class="text-white font-semibold">Configurable %</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-white/20">
                                        <span class="text-white/70">Billing Frequency</span>
                                        <span class="text-white font-semibold">Monthly</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-white/20">
                                        <span class="text-white/70">Payment</span>
                                        <span class="text-white font-semibold">Deal Value × Rate%</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="text-white/70">Market Extension</span>
                                        <span class="text-white font-semibold">Partner Network</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Installments Model -->
                            <div class="p-8 rounded-2xl card-hover" style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.2) 0%, rgba(14, 116, 144, 0.3) 100%); border: 1px solid rgba(6, 182, 212, 0.3);">
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(6, 182, 212, 0.2);">
                                            <svg class="w-6 h-6" style="color: #06b6d4;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                        </div>
                                        <h3 class="text-2xl font-bold text-white">Instalment</h3>
                                    </div>
                                    <button onclick="editBillingModel('installment')" class="p-2 rounded-lg hover:bg-white/10 transition-colors" title="Edit Instalment Model">
                                        <svg class="w-4 h-4 text-slate-400 hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                            <path d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"/>
                                        </svg>
                                    </button>
                                </div>
                                <p class="mb-6" style="color: rgba(148, 163, 184, 0.8);">Spread payments over specified time periods</p>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center py-2 border-b border-cyan-500/20">
                                        <span class="text-white/80">Payment Period</span>
                                        <span class="text-white font-semibold">Configurable Months</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-cyan-500/20">
                                        <span class="text-white/80">Monthly Amount</span>
                                        <span class="text-white font-semibold">Total ÷ Months</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-cyan-500/20">
                                        <span class="text-white/80">Start Month</span>
                                        <span class="text-white font-semibold">Deal Start Date</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="text-white/80">Completion</span>
                                        <span class="text-white font-semibold">After Final Payment</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Rentals Model -->
                            <div class="p-8 rounded-2xl card-hover" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(109, 40, 217, 0.3) 100%); border: 1px solid rgba(139, 92, 246, 0.3);">
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(139, 92, 246, 0.2);">
                                            <svg class="w-6 h-6" style="color: #8b5cf6;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-18M2.25 9l4.5-1.636M18.75 3l-1.5.545m0 6.205 3 1m1.5.5-1.5-.5M6.75 7.364V3h-3v18m3-13.636 10.5-3.819"/></svg>
                                        </div>
                                        <h3 class="text-2xl font-bold text-white">Rentals</h3>
                                    </div>
                                    <button onclick="editBillingModel('rentals')" class="p-2 rounded-lg hover:bg-white/10 transition-colors" title="Edit Rentals Model">
                                        <svg class="w-4 h-4 text-slate-400 hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                            <path d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"/>
                                        </svg>
                                    </button>
                                </div>
                                <p class="mb-6" style="color: rgba(148, 163, 184, 0.8);">BuildSmart software rental with recurring payments</p>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center py-2 border-b border-purple-500/20">
                                        <span class="text-white/80">Billing Frequency</span>
                                        <span class="text-white font-semibold">Monthly/Quarterly</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-purple-500/20">
                                        <span class="text-white/80">Payment Terms</span>
                                        <span class="text-white font-semibold">Recurring Rental</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-purple-500/20">
                                        <span class="text-white/80">Usage Period</span>
                                        <span class="text-white font-semibold">Flexible Terms</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="text-white/80">License Return</span>
                                        <span class="text-white font-semibold">End of Term</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Example Calculation -->
                        <div class="bg-slate-800/50 backdrop-blur-sm p-8 rounded-2xl border border-slate-700">
                            <h3 class="text-2xl font-bold text-white mb-6">Example: ABC Corp Perpetual License</h3>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div>
                                    <h4 class="text-lg font-semibold text-white mb-4">Main License Scenario</h4>
                                    <div class="bg-slate-700/30 p-4 rounded-xl space-y-3">
                                        <div class="flex justify-between">
                                            <span class="text-slate-400">Client:</span>
                                            <span class="text-white">ABC Corp</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-400">Start Date:</span>
                                            <span class="text-white">July 2025</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-400">Deal Value:</span>
                                            <span class="text-white">$10,000</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-400">2025 S&M:</span>
                                            <span style="color: #4c1d95;">FREE (Year 1)</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-400">2026 S&M:</span>
                                            <span class="text-white">$10,000 × (1 + 5%) = $10,500</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-400">2027 S&M:</span>
                                            <span class="text-white">$10,500 × (1 + 5.5%) = $11,078</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="text-lg font-semibold text-white mb-4">Additional License Scenario</h4>
                                    <div class="bg-slate-700/30 p-4 rounded-xl space-y-3">
                                        <div class="flex justify-between">
                                            <span class="text-slate-400">License Date:</span>
                                            <span class="text-white">March 2026</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-400">License Value:</span>
                                            <span class="text-white">$2,000</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-400">2026 Billing:</span>
                                            <span class="text-white">$2,000 × 4/12 = $667</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-400">2027 Billing:</span>
                                            <span class="text-white">Full S&M Aligned</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-400">Anniversary:</span>
                                            <span class="text-blue-400">July (Aligned)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            getLicensesContent() {
                try {
                    console.log('Loading licenses content, license count:', this.additionalLicenses ? this.additionalLicenses.length : 'undefined');
                    if (!this.additionalLicenses) {
                        console.error('Additional licenses array is undefined');
                        return '<div class="p-8"><h1 class="text-white">No additional licenses data found. Please refresh.</h1></div>';
                    }
                    return `
                        <div class="p-8 animate-fade-in">
                            <div class="flex items-center justify-between mb-8">
                                <div>
                                    <h1 class="text-4xl font-bold text-white mb-2">Additional Licenses</h1>
                                    <p class="text-lg" style="color: rgba(148, 163, 184, 0.8);">Manage additional licenses with prorated anniversary alignment</p>
                                </div>
                            <button onclick="openAddLicenseModal()" class="text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 flex items-center space-x-2 shadow-lg hover:shadow-xl" style="background: linear-gradient(135deg, #4c1d95, #003366);" onmouseover="this.style.background='linear-gradient(135deg, #003366, #4c1d95)'" onmouseout="this.style.background='linear-gradient(135deg, #4c1d95, #003366)'">
                                <svg class="w-4 h-4" style="color: #ffffff;" fill="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                                <span>Add Additional License</span>
                            </button>
                        </div>

                        <!-- License Overview -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-white">${this.additionalLicenses.length}</div>
                                    <div class="text-sm" style="color: rgba(148, 163, 184, 0.7);">Additional Licenses</div>
                                </div>
                            </div>
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-white">${this.additionalLicenses.reduce((sum, l) => sum + l.quantity, 0)}</div>
                                    <div class="text-sm" style="color: rgba(148, 163, 184, 0.7);">Total Additional Users</div>
                                </div>
                            </div>
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-white">${this.formatCurrency(this.additionalLicenses.reduce((sum, l) => sum + (l.quantity * l.pricePerUnit), 0))}</div>
                                    <div class="text-sm" style="color: rgba(148, 163, 184, 0.7);">Total License Value</div>
                                </div>
                            </div>
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-white">${this.additionalLicenses.filter(l => l.isActive).length}</div>
                                    <div class="text-sm" style="color: rgba(148, 163, 184, 0.7);">Active Licenses</div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Licenses Table -->
                        <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl border border-slate-700 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead style="background: rgba(6, 63, 120, 0.4);">
                                        <tr>
                                            <th class="text-left py-4 px-6 font-semibold text-slate-300">Client</th>
                                            <th class="text-left py-4 px-6 font-semibold text-slate-300">License Type</th>
                                            <th class="text-left py-4 px-6 font-semibold text-slate-300">Quantity</th>
                                            <th class="text-left py-4 px-6 font-semibold text-slate-300">Annual S&M Value</th>
                                            <th class="text-left py-4 px-6 font-semibold text-slate-300">Total Value</th>
                                            <th class="text-left py-4 px-6 font-semibold text-slate-300">Start Date</th>
                                            <th class="text-left py-4 px-6 font-semibold text-slate-300">Prorated Amount</th>
                                            <th class="text-left py-4 px-6 font-semibold text-slate-300">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-700">
                                        ${this.additionalLicenses.map(license => {
                                            try {
                                                console.log('Rendering license:', license.id, 'for client:', license.clientId);
                                                const client = this.clients.find(c => c.id === license.clientId);
                                                const totalValue = (license.quantity || 0) * (license.pricePerUnit || 0);
                                                const proratedAmount = this.calculateProratedLicense && client && license ? this.calculateProratedLicense(license, client) : ((license.quantity || 0) * (license.pricePerUnit || 0));
                                            
                                            return `
                                                <tr class="hover:bg-slate-700/30 transition-colors">
                                                    <td class="py-4 px-6">
                                                        <div class="flex items-center space-x-3">
                                                            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background: rgba(76, 29, 149, 0.2);">
                                                                <span class="text-blue-300 font-bold text-xs">${String(client?.companyName || 'Unknown').charAt(0)}</span>
                                                            </div>
                                                            <div>
                                                                <div class="font-semibold text-white">${client?.companyName || 'Unknown'}</div>
                                                                <div class="text-xs text-slate-400">${client?.billingModel || 'N/A'}</div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="py-4 px-6">
                                                        <span class="inline-flex px-3 py-1 rounded-full text-xs font-medium bg-blue-500/20 text-blue-300">
                                                            ${String(license.licenseType || 'unknown').charAt(0).toUpperCase() + String(license.licenseType || 'unknown').slice(1)}
                                                        </span>
                                                    </td>
                                                    <td class="py-4 px-6 text-white font-semibold">${this.formatNumber ? this.formatNumber(license.quantity || 0) : (license.quantity || 0)}</td>
                                                    <td class="py-4 px-6 text-white">${this.formatCurrency ? this.formatCurrency(license.pricePerUnit || 0, client?.currency || 'ZAR') : (license.pricePerUnit || 0)}</td>
                                                    <td class="py-4 px-6 text-white font-semibold">${this.formatCurrency ? this.formatCurrency(totalValue, client?.currency || 'ZAR') : totalValue}</td>
                                                    <td class="py-4 px-6 text-white">${this.formatDate ? this.formatDate(license.startDate) : (license.startDate || 'N/A')}</td>
                                                    <td class="py-4 px-6">
                                                        <div class="text-white font-semibold">${this.formatCurrency ? this.formatCurrency(proratedAmount, client?.currency || 'ZAR') : proratedAmount}</div>
                                                        <div class="text-xs text-slate-400">Aligned to anniversary</div>
                                                    </td>
                                                    <td class="py-4 px-6">
                                                        <div class="flex space-x-2">
                                                            <button onclick="app.editLicense('${license.id}')" class="text-blue-400 hover:text-blue-300 transition-colors" title="Edit">
                                                                <span class="text-lg">✏️</span>
                                                            </button>
                                                            <button onclick="app.deleteLicense('${license.id}')" class="text-red-400 hover:text-red-300 transition-colors" title="Delete">
                                                                <span class="text-lg">🗑️</span>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `;
                                            } catch (licenseError) {
                                                console.error('Error rendering license:', license, licenseError);
                                                return '<tr><td colspan="7" class="py-4 px-6 text-red-400">Error rendering license data</td></tr>';
                                            }
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                } catch (error) {
                    console.error('Error in getLicensesContent:', error);
                    return '<div class="p-8"><h1 class="text-white">Error loading licenses content. Please refresh.</h1></div>';
                }
            }

            getAnalyticsContent() {
                return `
                    <div class="p-8 animate-fade-in">
                        <div class="mb-8">
                            <h1 class="text-4xl font-bold text-white mb-2">Advanced Analytics</h1>
                            <p class="text-slate-400 text-lg">Revenue insights, forecasting, and performance metrics</p>
                        </div>

                        <!-- Analytics Charts -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <h3 class="text-xl font-semibold text-white mb-4">Revenue Over Time</h3>
                                <canvas id="revenue-line-chart" width="400" height="200"></canvas>
                            </div>
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <h3 class="text-xl font-semibold text-white mb-4">Revenue by Model</h3>
                                <canvas id="model-bar-chart" width="400" height="200"></canvas>
                            </div>
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <h3 class="text-xl font-semibold text-white mb-4">License Distribution</h3>
                                <canvas id="license-pie-chart" width="400" height="200"></canvas>
                            </div>
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <h3 class="text-xl font-semibold text-white mb-4">3-Year Forecast</h3>
                                <canvas id="forecast-chart" width="400" height="200"></canvas>
                            </div>
                        </div>

                        <!-- Detailed Metrics -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <h3 class="text-xl font-semibold text-white mb-4">Key Performance Metrics</h3>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-slate-400">Annual Recurring Revenue (ARR)</span>
                                        <span class="text-white font-semibold">${this.formatCurrency(this.calculateARR())}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-slate-400">Average Revenue Per User (ARPU)</span>
                                        <span class="text-white font-semibold">${this.formatCurrency(this.calculateARPU())}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-slate-400">Customer Lifetime Value (CLV)</span>
                                        <span class="text-white font-semibold">${this.formatCurrency(this.calculateCLV())}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-slate-400">S&M Revenue Growth</span>
                                        <span class="font-semibold" style="color: #4c1d95;">+${this.calculateSMGrowth()}%</span>
                                    </div>
                                </div>
                            </div>

                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <h3 class="text-xl font-semibold text-white mb-4">Annual Increases Impact</h3>
                                <div class="space-y-4">
                                    ${this.getAnnualIncreases().map(increase => `
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-400">${increase.year} Increase</span>
                                            <span class="text-white font-semibold">${increase.percentage}%</span>
                                        </div>
                                    `).join('')}
                                    <div class="border-t border-slate-600 pt-2">
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-400">Projected 2027 S&M</span>
                                            <span class="text-blue-400 font-semibold">${this.formatCurrency(this.projectSM(2027))}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <h3 class="text-xl font-semibold text-white mb-4">License Breakdown</h3>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-slate-400">Base Licenses</span>
                                        <span class="text-white font-semibold">${this.formatNumber(this.clients.reduce((sum, c) => sum + (c.users || 0), 0))}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-slate-400">Additional Licenses</span>
                                        <span class="text-white font-semibold">${this.formatNumber(this.additionalLicenses.reduce((sum, l) => sum + l.quantity, 0))}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-slate-400">Total Active Licenses</span>
                                        <span class="text-blue-400 font-semibold">${this.formatNumber(this.getTotalLicenses())}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Multi-Currency Analysis Section -->
                        <div class="mt-8">
                            <h2 class="text-2xl font-bold text-white mb-6">Multi-Currency Analysis</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                ${this.getUSDInsights()}
                            </div>
                        </div>



                    </div>
                `;
            }

            getVarsContent() {
                return `
                    <div class="p-8 animate-fade-in">
                        <div class="flex items-center justify-between mb-8">
                            <div>
                                <h1 class="text-4xl font-bold text-white mb-2">VAR Management</h1>
                                <p class="text-lg" style="color: rgba(148, 163, 184, 0.8);">Manage your Value Added Reseller partners</p>
                            </div>
                            <button onclick="openAddVarModal()" class="text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 flex items-center space-x-2 shadow-lg hover:shadow-xl" style="background: linear-gradient(135deg, #4c1d95, #003366);" onmouseover="this.style.background='linear-gradient(135deg, #003366, #4c1d95)'" onmouseout="this.style.background='linear-gradient(135deg, #4c1d95, #003366)'">
                                <svg class="w-4 h-4" style="color: #ffffff;" fill="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                                <span>Add VAR Partner</span>
                            </button>
                        </div>

                        <!-- VAR Overview -->  
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-white">${this.varPartners.length}</div>
                                    <div class="text-sm" style="color: rgba(148, 163, 184, 0.7);">Total VAR Partners</div>
                                </div>
                            </div>
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-white">${this.varPartners.filter(v => v.isActive).length}</div>
                                    <div class="text-sm" style="color: rgba(76, 29, 149, 0.7);">Active Partners</div>
                                </div>
                            </div>
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-white">${this.varPartners.length > 0 ? (this.varPartners.reduce((sum, v) => sum + (v.commissionRate || 0), 0) / this.varPartners.length).toFixed(1) : '0'}%</div>
                                    <div class="text-sm" style="color: rgba(76, 29, 149, 0.7);">Avg Commission Rate</div>
                                </div>
                            </div>
                            <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-white">${this.clients.filter(c => c.billingModel === 'var').length}</div>
                                    <div class="text-sm" style="color: rgba(76, 29, 149, 0.7);">VAR Clients</div>
                                </div>
                            </div>
                        </div>

                        <!-- VAR Partners Table -->
                        <div class="card-glass rounded-2xl overflow-hidden" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="border-b" style="border-color: rgba(76, 29, 149, 0.3); background: rgba(0, 51, 102, 0.2);">
                                        <tr>
                                            <th class="text-left py-4 px-6 text-white font-semibold">Company</th>
                                            <th class="text-left py-4 px-6 text-white font-semibold">Region</th>
                                            <th class="text-left py-4 px-6 text-white font-semibold">Contact</th>
                                            <th class="text-left py-4 px-6 text-white font-semibold">Commission</th>
                                            <th class="text-left py-4 px-6 text-white font-semibold">Status</th>
                                            <th class="text-left py-4 px-6 text-white font-semibold">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${this.varPartners.map((partner, index) => `
                                            <tr class="border-b hover:bg-slate-800/30 transition-colors" style="border-color: rgba(148, 163, 184, 0.1);">
                                                <td class="py-4 px-6">
                                                    <div class="text-white font-medium">${partner.name}</div>
                                                    <div class="text-sm" style="color: rgba(148, 163, 184, 0.7);">${partner.email}</div>
                                                </td>
                                                <td class="py-4 px-6">
                                                    <span class="px-3 py-1 rounded-full text-xs font-medium" style="background: rgba(76, 29, 149, 0.2); color: #ffffff;">${partner.region}</span>
                                                </td>
                                                <td class="py-4 px-6">
                                                    <div class="text-white">${partner.contactPerson}</div>
                                                    <div class="text-sm" style="color: rgba(148, 163, 184, 0.7);">${partner.phone || 'No phone'}</div>
                                                </td>
                                                <td class="py-4 px-6">
                                                    <span class="text-white font-semibold">${partner.commissionRate || 0}%</span>
                                                </td>
                                                <td class="py-4 px-6">
                                                    <span class="px-2 py-1 rounded-full text-xs font-medium" style="color: ${partner.isActive ? '#94a3b8' : '#ef4444'}; background: ${partner.isActive ? 'rgba(148, 163, 184, 0.2)' : 'rgba(239, 68, 68, 0.2)'};">
                                                        ${partner.isActive ? 'Active' : 'Inactive'}
                                                    </span>
                                                </td>
                                                <td class="py-4 px-6">
                                                    <div class="flex space-x-2">
                                                        <button onclick="app.editVarPartner('${partner.id}')" class="text-blue-400 hover:text-blue-300 transition-colors" title="Edit">
                                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                                        </button>
                                                        <button onclick="app.toggleVarPartnerStatus('${partner.id}')" class="${partner.isActive ? 'text-orange-400 hover:text-orange-300' : 'text-green-400 hover:text-green-300'} transition-colors" title="${partner.isActive ? 'Deactivate' : 'Activate'}">
                                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>${partner.isActive ? '<path d="M15.5 14L12 10.5 8.5 14"/>' : '<path d="M8.5 10L12 13.5 15.5 10"/>'}</svg>
                                                        </button>
                                                        <button onclick="app.deleteVarPartner('${partner.id}')" class="text-red-400 hover:text-red-300 transition-colors" title="Delete">
                                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            getBillingOverviewContent() {
                const currentYear = new Date().getFullYear();
                return `
                    <div class="p-8 animate-fade-in">
                        <div class="flex items-center justify-between mb-8">
                            <div>
                                <h1 class="text-4xl font-bold text-white mb-2">Billing Overview</h1>
                                <p class="text-lg" style="color: rgba(148, 163, 184, 0.8);">Monthly and yearly billing projections with model filtering</p>
                            </div>
                            <div class="flex space-x-4">
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm font-medium" style="color: rgba(148, 163, 184, 0.9);">Year:</label>
                                    <select id="billing-year" class="px-3 py-2 rounded-lg font-semibold" style="background: rgba(6, 63, 120, 0.3); border: 1px solid rgba(148, 163, 184, 0.4); color: #94a3b8;" onchange="app.updateBillingOverview()">
                                        <option value="${currentYear}">${currentYear}</option>
                                        <option value="${currentYear + 1}">${currentYear + 1}</option>
                                        <option value="${currentYear + 2}">${currentYear + 2}</option>
                                    </select>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm font-medium" style="color: rgba(148, 163, 184, 0.9);">Model:</label>
                                    <select id="billing-model-filter" class="px-3 py-2 rounded-lg font-semibold" style="background: rgba(6, 63, 120, 0.3); border: 1px solid rgba(148, 163, 184, 0.4); color: #94a3b8;" onchange="app.updateBillingOverview()">
                                        <option value="all">All Models</option>
                                        <option value="perpetual">Perpetual</option>
                                        <option value="subscription">Subscription</option>
                                        <option value="installment">Instalment</option>
                                        <option value="var">VAR</option>
                                        <option value="rentals">Rentals</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Billing Summary Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="billing-summary-cards">
                            ${this.getBillingSummaryCards()}
                        </div>

                        <!-- Monthly Billing Tables by Currency -->
                        <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8">
                            <!-- ZAR Monthly Billing Table -->
                            <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl border border-slate-700 overflow-hidden">
                                <div class="p-6 border-b border-slate-700">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center">
                                            <span class="text-purple-400 font-bold text-sm">R</span>
                                        </div>
                                        <div>
                                            <h3 class="text-xl font-semibold text-white">ZAR Monthly Breakdown</h3>
                                            <p class="text-slate-400 mt-1">South African Rand revenue by month</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="overflow-x-auto" id="zar-monthly-billing-table">
                                    ${this.getMonthlyBillingTableByCurrency('ZAR')}
                                </div>
                            </div>
                            
                            <!-- USD Monthly Billing Table -->
                            <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl border border-slate-700 overflow-hidden">
                                <div class="p-6 border-b border-slate-700">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-8 h-8 rounded-lg bg-green-500/20 flex items-center justify-center">
                                            <span class="text-green-400 font-bold text-sm">$</span>
                                        </div>
                                        <div>
                                            <h3 class="text-xl font-semibold text-white">USD Monthly Breakdown</h3>
                                            <p class="text-slate-400 mt-1">US Dollar revenue by month</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="overflow-x-auto" id="usd-monthly-billing-table">
                                    ${this.getMonthlyBillingTableByCurrency('USD')}
                                </div>
                            </div>
                        </div>

                        <!-- 6-Month Summary -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl border border-slate-700 p-6">
                                <h3 class="text-xl font-semibold text-white mb-4">6-Month Projections</h3>
                                <div class="space-y-4" id="six-month-projections">
                                    ${this.getSixMonthProjections()}
                                </div>
                            </div>
                            <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl border border-slate-700 p-6">
                                <h3 class="text-xl font-semibold text-white mb-4">Annual Comparison</h3>
                                <div class="space-y-4" id="annual-comparison">
                                    ${this.getAnnualComparison()}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Client Monthly Billing Details by Model -->
                        <div class="space-y-8 mt-8" id="billing-models-tables">
                            ${this.getBillingModelTables()}
                        </div>


                    </div>
                `;
            }
            
            // Old duplicate functions removed - using updated versions
            
            getRenewalCountForMonth(clients, month) {
                return clients.filter(client => client.anniversaryMonth === month).length;
            }
            
            // This duplicate function has been removed - using the correct one below
            
            // This duplicate function has been removed - using the correct one above
            

            
            getBillingModelTables() {
                const currentYear = parseInt(document.getElementById('billing-year')?.value || new Date().getFullYear());
                const modelFilter = document.getElementById('billing-model-filter')?.value || 'all';
                
                const billingModels = [
                    { 
                        key: 'perpetual', 
                        title: 'Perpetual License Clients', 
                        description: 'Annual Support & Maintenance billing',
                        color: 'rgba(76, 29, 149, 0.4)',
                        icon: '<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159-.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z"/></svg>'
                    },
                    { 
                        key: 'subscription', 
                        title: 'Subscription Clients', 
                        description: 'Recurring revenue based on billing frequency',
                        color: 'rgba(6, 63, 120, 0.4)',
                        icon: '<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"/></svg>'
                    },
                    { 
                        key: 'installment', 
                        title: 'Instalment Plan Clients', 
                        description: 'Fixed monthly payments over contract period',
                        color: 'rgba(5, 150, 105, 0.4)',
                        icon: '<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
                    },
                    { 
                        key: 'var', 
                        title: 'VAR Partnership Clients', 
                        description: 'Commission-based revenue distributed monthly',
                        color: 'rgba(3, 46, 102, 0.4)',
                        icon: '<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/></svg>'
                    },
                    { 
                        key: 'rentals', 
                        title: 'BuildSmart Rental Clients', 
                        description: 'Monthly rental payments with flexible terms',
                        color: 'rgba(139, 92, 246, 0.4)',
                        icon: '<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-18M2.25 9l4.5-1.636M18.75 3l-1.5.545m0 6.205l3 1m1.5.5l-1.5-.5M6.75 7.364V3h-3v18m3-13.636l10.5-3.819"/></svg>'
                    }
                ];
                
                let html = '';
                
                billingModels.forEach(model => {
                    // Skip models that are filtered out
                    if (modelFilter !== 'all' && modelFilter !== model.key) return;
                    
                    const modelClients = this.clients.filter(c => c.isActive && c.billingModel === model.key);
                    
                    if (modelClients.length === 0) return;
                    
                    html += `
                        <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl border border-slate-700 overflow-hidden">
                            <div class="p-6 border-b border-slate-700">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: ${model.color};">
                                        <div style="color: #4c1d95;">${model.icon}</div>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-semibold text-white">${model.title}</h3>
                                        <p class="text-slate-400">${model.description} • ${modelClients.length} clients</p>
                                    </div>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                ${this.getClientMonthlyBillingTableForModel(model.key, modelClients, currentYear)}
                            </div>
                        </div>
                    `;
                });
                
                if (html === '') {
                    return `
                        <div class="p-8 text-center bg-slate-800/50 backdrop-blur-sm rounded-2xl border border-slate-700">
                            <div class="text-slate-400">No clients found for the selected filters</div>
                        </div>
                    `;
                }
                
                return html;
            }
            
            getClientMonthlyBillingTableForModel(modelType, clients, currentYear) {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                return `
                    <table class="w-full">
                        <thead style="background: rgba(6, 63, 120, 0.4);">
                            <tr>
                                <th class="text-left py-4 px-4 font-semibold text-slate-300 sticky left-0" style="background: rgba(6, 63, 120, 0.4); min-width: 200px;">Client</th>
                                <th class="text-center py-4 px-3 font-semibold text-slate-300" style="min-width: 80px;">Users</th>
                                ${modelType === 'subscription' ? '<th class="text-center py-4 px-3 font-semibold text-slate-300" style="min-width: 100px;">Frequency</th>' : ''}
                                ${modelType === 'installment' ? '<th class="text-center py-4 px-3 font-semibold text-slate-300" style="min-width: 100px;">Periods</th>' : ''}
                                ${modelType === 'var' ? '<th class="text-center py-4 px-3 font-semibold text-slate-300" style="min-width: 100px;">Commission</th>' : ''}
                                ${months.map(month => `
                                    <th class="text-center py-4 px-3 font-semibold text-slate-300" style="min-width: 120px;">${month}</th>
                                `).join('')}
                                <th class="text-center py-4 px-4 font-semibold text-slate-300" style="min-width: 120px;">Annual Total</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-700">
                            ${clients.map(client => {
                                const monthlyValues = months.map((month, index) => {
                                    return this.calculateClientMonthlyBilling(client, currentYear, index + 1);
                                });
                                const annualTotal = monthlyValues.reduce((sum, val) => sum + val, 0);
                                
                                return `
                                    <tr class="hover:bg-slate-700/30 transition-colors">
                                        <td class="py-4 px-4 sticky left-0" style="background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px);">
                                            <div>
                                                <div class="text-white font-medium">${client.clientName}</div>
                                                <div class="text-xs text-slate-400">${client.country ? client.country + ' • ' : ''}${this.formatCurrency(client.total)}</div>
                                            </div>
                                        </td>
                                        <td class="py-4 px-3 text-center">
                                            <span class="text-white font-medium">${client.users || 0}</span>
                                        </td>
                                        ${modelType === 'subscription' ? `
                                            <td class="py-4 px-3 text-center">
                                                <span class="text-slate-300 text-sm capitalize">${client.billingFrequency || 'annually'}</span>
                                            </td>
                                        ` : ''}
                                        ${modelType === 'installment' ? `
                                            <td class="py-4 px-3 text-center">
                                                <span class="text-slate-300 text-sm">${client.instalmentPeriods || 12} months</span>
                                            </td>
                                        ` : ''}
                                        ${modelType === 'var' ? `
                                            <td class="py-4 px-3 text-center">
                                                <span class="text-slate-300 text-sm">${client.commissionRate || 20}%</span>
                                            </td>
                                        ` : ''}
                                        ${monthlyValues.map(value => `
                                            <td class="py-4 px-3 text-center">
                                                <span class="text-white font-medium text-center ${value > 0 ? 'px-2 py-1 rounded' : ''}" ${value > 0 ? 'style="background: rgba(76, 29, 149, 0.2);"' : ''}>${value > 0 ? this.formatCurrency(value) : '-'}</span>
                                            </td>
                                        `).join('')}
                                        <td class="py-4 px-4 text-center">
                                            <span class="text-blue-400 font-bold">${this.formatCurrency(annualTotal)}</span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                            <tr style="background: rgba(6, 63, 120, 0.2); border-top: 2px solid rgba(148, 163, 184, 0.3);">
                                <td class="py-4 px-4 font-bold text-white sticky left-0" style="background: rgba(6, 63, 120, 0.3);">TOTAL</td>
                                <td class="py-4 px-3 text-center font-bold text-white">${clients.reduce((sum, client) => sum + (client.users || 0), 0)}</td>
                                ${modelType === 'subscription' || modelType === 'installment' || modelType === 'var' ? '<td class="py-4 px-3 text-center font-bold text-white">-</td>' : ''}
                                ${months.map((month, index) => {
                                    const monthTotal = clients.reduce((sum, client) => 
                                        sum + this.calculateClientMonthlyBilling(client, currentYear, index + 1), 0);
                                    return `
                                        <td class="py-4 px-3 text-center font-bold text-white">${monthTotal > 0 ? this.formatCurrency(monthTotal) : '-'}</td>
                                    `;
                                }).join('')}
                                <td class="py-4 px-4 text-center font-bold text-blue-400">
                                    ${this.formatCurrency(clients.reduce((sum, client) => {
                                        const clientAnnual = months.reduce((clientSum, month, index) => 
                                            clientSum + this.calculateClientMonthlyBilling(client, currentYear, index + 1), 0);
                                        return sum + clientAnnual;
                                    }, 0))}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `;
            }
            
            calculateClientMonthlyBilling(client, year, month) {
                const monthNames = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                const monthField = monthNames[month - 1];
                const currentYear = new Date().getFullYear();
                
                // Handle different billing models
                switch(client.billingModel) {
                    case 'installment':
                        // For installment clients, use the actual monthly values from client data
                        return client[monthField] || 0;
                    
                    case 'rentals':
                        // For rentals clients, use the actual monthly values from client data
                        return client[monthField] || 0;
                    
                    case 'subscription':
                        // For subscription clients, use the actual monthly values from client data  
                        return client[monthField] || 0;
                    
                    case 'var':
                        // For VAR clients, use the actual monthly values from client data
                        return client[monthField] || 0;
                    
                    case 'perpetual':
                        // For perpetual clients, S&M is billed only in anniversary month
                        if (year <= currentYear) {
                            // For current/past years, use actual data
                            return client[monthField] || 0;
                        } else {
                            // For future years, S&M billing only happens in anniversary month
                            const anniversaryMonth = client.anniversaryMonth || new Date(client.dealStartDate).getMonth() + 1;
                            if (month === anniversaryMonth) {
                                return this.calculatePerpetualSM(client, year);
                            } else {
                                return 0; // No billing in non-anniversary months
                            }
                        }
                    
                    default:
                        // For current year (2025), use original values
                        if (year <= currentYear) {
                            return client[monthField] || 0;
                        }
                        
                        // For future years, check if we have calculated future year data
                        if (client.futureYearData && client.futureYearData[year]) {
                            return client.futureYearData[year][monthField] || 0;
                        }
                        
                        // If no future year data, return original value (fallback)
                        return client[monthField] || 0;
                }
            }
            
            getReportsContent() {
                return `
                    <div class="p-8 animate-fade-in">
                        <div class="mb-8">
                            <h1 class="text-4xl font-bold text-white mb-2">Professional Reports</h1>
                            <p class="text-lg" style="color: rgba(76, 29, 149, 0.8);">Generate comprehensive reports with integrated export functionality</p>
                        </div>

                        <!-- Professional Reports Section -->
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                            <div class="card-glass p-6 rounded-2xl hover:scale-105 transition-transform" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="flex items-center space-x-3 mb-4">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(76, 29, 149, 0.2);">
                                        <svg class="w-6 h-6" style="color: rgba(76, 29, 149, 0.8);" fill="currentColor" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-white">S&M Forecast</h3>
                                        <p class="text-sm text-slate-400">3-year projections</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="app.generateReport('sm-forecast')" class="flex-1 px-3 py-2 text-white rounded-lg text-sm font-medium transition-all duration-200" style="background: linear-gradient(135deg, rgba(76, 29, 149, 0.8), rgba(55, 48, 163, 0.8));" onmouseover="this.style.background='linear-gradient(135deg, rgba(76, 29, 149, 1), rgba(55, 48, 163, 1))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(76, 29, 149, 0.8), rgba(55, 48, 163, 0.8))'">
                                        Generate
                                    </button>
                                    <button onclick="app.exportReport('sm-forecast', 'csv')" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors" title="Export CSV">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/></svg>
                                    </button>
                                    <button onclick="app.exportReport('sm-forecast', 'xlsx')" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors" title="Export XLSX">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M21 8v13H3V3h13l5 5z"/></svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card-glass p-6 rounded-2xl hover:scale-105 transition-transform" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="flex items-center space-x-3 mb-4">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(0, 51, 102, 0.2);">
                                        <svg class="w-6 h-6" style="color: rgba(0, 51, 102, 0.8);" fill="currentColor" viewBox="0 0 24 24"><path d="M7 11V7a5 5 0 0110 0v4h1a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2v-6a2 2 0 012-2h1z"/></svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-white">License Audit</h3>
                                        <p class="text-sm text-slate-400">Prorated calculations</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="app.generateReport('licenses')" class="flex-1 px-3 py-2 text-white rounded-lg text-sm font-medium transition-all duration-200" style="background: linear-gradient(135deg, rgba(0, 51, 102, 0.8), rgba(76, 29, 149, 0.8));" onmouseover="this.style.background='linear-gradient(135deg, rgba(0, 51, 102, 1), rgba(76, 29, 149, 1))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(0, 51, 102, 0.8), rgba(76, 29, 149, 0.8))'">
                                        Generate
                                    </button>
                                    <button onclick="app.exportReport('licenses', 'csv')" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors" title="Export CSV">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/></svg>
                                    </button>
                                    <button onclick="app.exportReport('licenses', 'xlsx')" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors" title="Export XLSX">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M21 8v13H3V3h13l5 5z"/></svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card-glass p-6 rounded-2xl hover:scale-105 transition-transform" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="flex items-center space-x-3 mb-4">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(46, 16, 101, 0.2);">
                                        <svg class="w-6 h-6" style="color: rgba(46, 16, 101, 0.8);" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-white">Revenue Analysis</h3>
                                        <p class="text-sm text-slate-400">Model & currency breakdown</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="app.generateReport('revenue')" class="flex-1 px-3 py-2 text-white rounded-lg text-sm font-medium transition-all duration-200" style="background: linear-gradient(135deg, rgba(46, 16, 101, 0.8), rgba(30, 27, 75, 0.8));" onmouseover="this.style.background='linear-gradient(135deg, rgba(46, 16, 101, 1), rgba(30, 27, 75, 1))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(46, 16, 101, 0.8), rgba(30, 27, 75, 0.8))'">
                                        Generate
                                    </button>
                                    <button onclick="app.exportReport('revenue', 'csv')" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors" title="Export CSV">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/></svg>
                                    </button>
                                    <button onclick="app.exportReport('revenue', 'xlsx')" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors" title="Export XLSX">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M21 8v13H3V3h13l5 5z"/></svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card-glass p-6 rounded-2xl hover:scale-105 transition-transform" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="flex items-center space-x-3 mb-4">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(30, 27, 75, 0.2);">
                                        <svg class="w-6 h-6" style="color: rgba(30, 27, 75, 0.8);" fill="currentColor" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-white">VAR Commission</h3>
                                        <p class="text-sm text-slate-400">Partner calculations</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="app.generateReport('var')" class="flex-1 px-3 py-2 text-white rounded-lg text-sm font-medium transition-all duration-200" style="background: linear-gradient(135deg, rgba(30, 27, 75, 0.8), rgba(76, 29, 149, 0.8));" onmouseover="this.style.background='linear-gradient(135deg, rgba(30, 27, 75, 1), rgba(76, 29, 149, 1))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(30, 27, 75, 0.8), rgba(76, 29, 149, 0.8))'">
                                        Generate
                                    </button>
                                    <button onclick="app.exportReport('var', 'csv')" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors" title="Export CSV">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/></svg>
                                    </button>
                                    <button onclick="app.exportReport('var', 'xlsx')" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors" title="Export XLSX">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M21 8v13H3V3h13l5 5z"/></svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card-glass p-6 rounded-2xl hover:scale-105 transition-transform" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="flex items-center space-x-3 mb-4">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(76, 29, 149, 0.2);">
                                        <svg class="w-6 h-6" style="color: rgba(76, 29, 149, 0.8);" fill="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-white">Client Summary</h3>
                                        <p class="text-sm text-slate-400">Complete client directory</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="app.generateReport('client-summary')" class="flex-1 px-3 py-2 text-white rounded-lg text-sm font-medium transition-all duration-200" style="background: linear-gradient(135deg, rgba(76, 29, 149, 0.8), rgba(0, 51, 102, 0.8));" onmouseover="this.style.background='linear-gradient(135deg, rgba(76, 29, 149, 1), rgba(0, 51, 102, 1))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(76, 29, 149, 0.8), rgba(0, 51, 102, 0.8))'">
                                        Generate
                                    </button>
                                    <button onclick="app.exportReport('client-summary', 'csv')" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors" title="Export CSV">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/></svg>
                                    </button>
                                    <button onclick="app.exportReport('client-summary', 'xlsx')" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors" title="Export XLSX">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M21 8v13H3V3h13l5 5z"/></svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card-glass p-6 rounded-2xl hover:scale-105 transition-transform" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="flex items-center space-x-3 mb-4">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(0, 51, 102, 0.2);">
                                        <svg class="w-6 h-6" style="color: rgba(0, 51, 102, 0.8);" fill="currentColor" viewBox="0 0 24 24"><path d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4h3a1 1 0 011 1v3a1 1 0 01-1 1h-1v9a2 2 0 01-2 2H8a2 2 0 01-2-2v-9H5a1 1 0 01-1-1V8a1 1 0 011-1h3z"/></svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-white">Monthly Breakdown</h3>
                                        <p class="text-sm text-slate-400">Month-by-month analysis</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="app.generateReport('monthly-breakdown')" class="flex-1 px-3 py-2 text-white rounded-lg text-sm font-medium transition-all duration-200" style="background: linear-gradient(135deg, rgba(0, 51, 102, 0.8), rgba(46, 16, 101, 0.8));" onmouseover="this.style.background='linear-gradient(135deg, rgba(0, 51, 102, 1), rgba(46, 16, 101, 1))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(0, 51, 102, 0.8), rgba(46, 16, 101, 0.8))'">
                                        Generate
                                    </button>
                                    <button onclick="app.exportReport('monthly-breakdown', 'csv')" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors" title="Export CSV">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/></svg>
                                    </button>
                                    <button onclick="app.exportReport('monthly-breakdown', 'xlsx')" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors" title="Export XLSX">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M21 8v13H3V3h13l5 5z"/></svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card-glass p-6 rounded-2xl hover:scale-105 transition-transform" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="flex items-center space-x-3 mb-4">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(46, 16, 101, 0.2);">
                                        <svg class="w-6 h-6" style="color: rgba(46, 16, 101, 0.8);" fill="currentColor" viewBox="0 0 24 24"><path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-white">Payment Status</h3>
                                        <p class="text-sm text-slate-400">Outstanding & paid</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="app.generateReport('payment-status')" class="flex-1 px-3 py-2 text-white rounded-lg text-sm font-medium transition-all duration-200" style="background: linear-gradient(135deg, rgba(46, 16, 101, 0.8), rgba(55, 48, 163, 0.8));" onmouseover="this.style.background='linear-gradient(135deg, rgba(46, 16, 101, 1), rgba(55, 48, 163, 1))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(46, 16, 101, 0.8), rgba(55, 48, 163, 0.8))'">
                                        Generate
                                    </button>
                                    <button onclick="app.exportReport('payment-status', 'csv')" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors" title="Export CSV">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/></svg>
                                    </button>
                                    <button onclick="app.exportReport('payment-status', 'xlsx')" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors" title="Export XLSX">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M21 8v13H3V3h13l5 5z"/></svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card-glass p-6 rounded-2xl hover:scale-105 transition-transform" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                                <div class="flex items-center space-x-3 mb-4">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(30, 27, 75, 0.2);">
                                        <svg class="w-6 h-6" style="color: rgba(30, 27, 75, 0.8);" fill="currentColor" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-white">Growth Metrics</h3>
                                        <p class="text-sm text-slate-400">YoY & trend analysis</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="app.generateReport('growth-metrics')" class="flex-1 px-3 py-2 text-white rounded-lg text-sm font-medium transition-all duration-200" style="background: linear-gradient(135deg, rgba(30, 27, 75, 0.8), rgba(55, 48, 163, 0.8));" onmouseover="this.style.background='linear-gradient(135deg, rgba(30, 27, 75, 1), rgba(55, 48, 163, 1))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(30, 27, 75, 0.8), rgba(55, 48, 163, 0.8))'">
                                        Generate
                                    </button>
                                    <button onclick="app.exportReport('growth-metrics', 'csv')" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors" title="Export CSV">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/></svg>
                                    </button>
                                    <button onclick="app.exportReport('growth-metrics', 'xlsx')" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors" title="Export XLSX">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M21 8v13H3V3h13l5 5z"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Report Output -->
                        <div id="report-output" class="hidden mb-8">
                            <!-- Dynamic report content will be inserted here -->
                        </div>

                    </div>
                `;
            }

            // Business Logic Methods
            calculateARR() {
                let arr = 0;
                this.clients.forEach(client => {
                    switch(client.billingModel) {
                        case 'subscription':
                            arr += (client.total || 0);
                            break;
                        case 'perpetual':
                            arr += (client.total || 0);
                            break;
                        case 'var':
                            arr += ((client.total || 0) * (client.commissionRate || 20) / 100);
                            break;
                    }
                });
                return arr;
            }

            calculateARPU() {
                const totalRevenue = this.calculateARR();
                const totalUsers = this.getTotalLicenses();
                return totalUsers > 0 ? totalRevenue / totalUsers : 0;
            }

            calculateCLV() {
                // Simplified CLV calculation - average annual value × 3 years
                return this.calculateARPU() * 3;
            }

            calculateSMGrowth() {
                // Calculate average S&M growth from annual increases
                const increases = this.getAnnualIncreases();
                const totalGrowth = increases.reduce((sum, inc) => sum + inc.percentage, 0);
                return (totalGrowth / increases.length).toFixed(1);
            }

            projectSM(year) {
                let total = 0;
                this.clients.filter(c => c.billingModel === 'perpetual').forEach(client => {
                    total += (client.total || 0);
                });
                return total;
            }

            getTotalLicenses() {
                const baseUsers = this.clients.reduce((sum, c) => sum + (c.users || 0), 0);
                const additionalUsers = this.additionalLicenses.reduce((sum, l) => sum + l.quantity, 0);
                return baseUsers + additionalUsers;
            }

            // Initialize page-specific functionality
            initializePage(page) {
                if (page === 'licenses') {
                    this.populateLicenseClientSelect();
                } else if (page === 'analytics') {
                    setTimeout(() => this.initializeAnalyticsCharts(), 100);
                }
            }

            populateLicenseClientSelect() {
                const select = document.getElementById('license-client-select');
                if (select) {
                    select.innerHTML = '<option value="">Select Client</option>' + this.clients.map(client => 
                        `<option value="${client.id}" data-billing-model="${client.billingModel}" data-var-partner="${client.varPartner || ''}">${client.companyName} (${client.billingModel})</option>`
                    ).join('');
                }
            }
            
            getVarPartnerName(partnerId) {
                const partner = this.getVarPartners().find(p => p.id === partnerId);
                return partner ? partner.name : 'Unknown Partner';
            }

            initializeAnalyticsCharts() {
                // Revenue Line Chart
                const revenueCtx = document.getElementById('revenue-line-chart');
                if (revenueCtx) {
                    new Chart(revenueCtx, {
                        type: 'line',
                        data: {
                            labels: ['2022', '2023', '2024', '2025', '2026', '2027'],
                            datasets: [{
                                label: 'Revenue',
                                data: [45000, 52000, 61000, 73000, 89000, 108000],
                                borderColor: '#7c3aed',
                                backgroundColor: 'rgba(124, 58, 237, 0.2)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: { ticks: { color: '#e2e8f0' }, grid: { color: '#374151' } },
                                y: { 
                                    ticks: { 
                                        color: '#e2e8f0',
                                        callback: (value) => 'R ' + value.toLocaleString()
                                    },
                                    grid: { color: '#374151' }
                                }
                            },
                            plugins: { legend: { labels: { color: '#e2e8f0' } } }
                        }
                    });
                }

                // Model Bar Chart
                const modelCtx = document.getElementById('model-bar-chart');
                if (modelCtx) {
                    const metrics = this.calculateDashboardMetrics();
                    new Chart(modelCtx, {
                        type: 'bar',
                        data: {
                            labels: metrics.modelBreakdown.map(m => m.name),
                            datasets: [{
                                label: 'Revenue',
                                data: metrics.modelBreakdown.map(m => m.revenue),
                                backgroundColor: metrics.modelBreakdown.map(m => m.color),
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: { ticks: { color: '#e2e8f0' }, grid: { color: '#374151' } },
                                y: { 
                                    ticks: { 
                                        color: '#e2e8f0',
                                        callback: (value) => 'R ' + value.toLocaleString()
                                    },
                                    grid: { color: '#374151' }
                                }
                            },
                            plugins: { legend: { labels: { color: '#e2e8f0' } } }
                        }
                    });
                }

                // License Pie Chart
                const licenseCtx = document.getElementById('license-pie-chart');
                if (licenseCtx) {
                    new Chart(licenseCtx, {
                        type: 'pie',
                        data: {
                            labels: ['Perpetual', 'Subscription', 'VAR', 'Instalment', 'Rentals'],
                            datasets: [{
                                data: [
                                    this.clients.filter(c => c.billingModel === 'perpetual').reduce((sum, c) => sum + (c.users || 0), 0),
                                    this.clients.filter(c => c.billingModel === 'subscription').reduce((sum, c) => sum + (c.users || 0), 0),
                                    this.clients.filter(c => c.billingModel === 'var').reduce((sum, c) => sum + (c.users || 0), 0),
                                    this.clients.filter(c => c.billingModel === 'installment').reduce((sum, c) => sum + (c.users || 0), 0),
                                    this.clients.filter(c => c.billingModel === 'rentals').reduce((sum, c) => sum + (c.users || 0), 0)
                                ],
                                backgroundColor: ['#4c1d95', '#7c3aed', '#a855f7', '#c084fc', '#8b5cf6'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { labels: { color: '#e2e8f0' } } }
                        }
                    });
                }

                // Forecast Chart
                const forecastCtx = document.getElementById('forecast-chart');
                if (forecastCtx) {
                    new Chart(forecastCtx, {
                        type: 'line',
                        data: {
                            labels: ['2025', '2026', '2027'],
                            datasets: [{
                                label: 'Projected S&M Revenue',
                                data: [
                                    this.projectSM(2025),
                                    this.projectSM(2026),
                                    this.projectSM(2027)
                                ],
                                borderColor: '#a855f7',
                                backgroundColor: 'rgba(168, 85, 247, 0.2)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: { ticks: { color: '#e2e8f0' }, grid: { color: '#374151' } },
                                y: { 
                                    ticks: { 
                                        color: '#e2e8f0',
                                        callback: (value) => 'R ' + value.toLocaleString()
                                    },
                                    grid: { color: '#374151' }
                                }
                            },
                            plugins: { legend: { labels: { color: '#e2e8f0' } } }
                        }
                    });
                }
            }

            // Helper methods
            getBillingModelColor(model) {
                const colors = {
                    'perpetual': 'bg-teal-500/20 text-teal-300 border-teal-500/30',
                    'subscription': 'bg-blue-500/20 text-blue-300 border-blue-500/30',
                    'installment': 'bg-orange-500/20 text-orange-300 border-orange-500/30',
                    'var': 'bg-purple-400/20 text-purple-200 border-purple-400/30'
                };
                return colors[model] || colors.perpetual;
            }
            
            getBillingModelStyle(model) {
                const styles = {
                    'perpetual': '',
                    'subscription': 'background: rgba(0, 51, 102, 0.2); color: #4a90e2; border-color: rgba(74, 144, 226, 0.3);',
                    'installment': 'background: rgba(192, 132, 252, 0.2); color: #c084fc; border-color: rgba(192, 132, 252, 0.3);',
                    'var': 'background: rgba(107, 70, 193, 0.15); color: #94a3b8; border-color: rgba(107, 70, 193, 0.3);'
                };
                return styles[model] || '';
            }

            getMonthName(month) {
                const months = ['', 'January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
                return months[month] || 'N/A';
            }

            formatDate(dateString) {
                return new Date(dateString).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }

            // VAR Partners Management
            loadVarPartners() {
                const stored = localStorage.getItem('buildsmart_vars');
                if (stored) {
                    return JSON.parse(stored);
                }
                
                // Default VAR partners
                return [
                    { id: 'var1', name: 'TechSolutions Partners', region: 'North America', commissionRate: 15, contactPerson: 'John Smith', email: 'john@techsolutions.com', phone: '+1-555-0123', isActive: true },
                    { id: 'var2', name: 'Global IT Resellers', region: 'Europe', commissionRate: 12, contactPerson: 'Emma Johnson', email: 'emma@globalit.com', phone: '+44-20-1234-5678', isActive: true },
                    { id: 'var3', name: 'Enterprise Systems Inc', region: 'Asia Pacific', commissionRate: 18, contactPerson: 'Yuki Tanaka', email: 'yuki@enterprisesys.com', phone: '+81-3-1234-5678', isActive: true },
                    { id: 'var4', name: 'Business Solutions Ltd', region: 'Latin America', commissionRate: 14, contactPerson: 'Carlos Rodriguez', email: 'carlos@businesssol.com', phone: '+55-11-1234-5678', isActive: true },
                    { id: 'var5', name: 'Strategic Technology Partners', region: 'Middle East', commissionRate: 16, contactPerson: 'Ahmed Al-Rashid', email: 'ahmed@strategictech.com', phone: '+971-4-123-4567', isActive: true }
                ];
            }
            
            getVarPartners() {
                return this.varPartners || this.loadVarPartners();
            }
            
            saveVarPartners() {
                localStorage.setItem('buildsmart_vars', JSON.stringify(this.varPartners));
            }
            
            // Global Annual Increase Management
            updateGlobalAnnualIncrease(value) {
                // Allow decimal values and preserve them
                const numValue = parseFloat(value);
                this.globalAnnualIncrease = isNaN(numValue) ? 5.0 : numValue;
                localStorage.setItem('globalAnnualIncrease', this.globalAnnualIncrease.toString());
                // Don't refresh the page when user is typing - this causes the input to reset
                // Page will be refreshed when they click Apply instead
            }

            // Apply Annual Increase to Future Years
            applyAnnualIncrease() {
                const inputValue = document.getElementById('globalAnnualIncrease').value;
                if (!inputValue || inputValue.trim() === '') {
                    this.showSuccessNotification('Input Required', 'Please enter an annual increase percentage');
                    return;
                }
                const increasePercentage = parseFloat(inputValue);
                if (isNaN(increasePercentage) || increasePercentage < 0) {
                    this.showSuccessNotification('Invalid Input', 'Please enter a valid positive number for the increase percentage');
                    return;
                }
                console.log('Input value:', inputValue, 'Parsed value:', increasePercentage);
                const currentYear = new Date().getFullYear();
                const targetYear = currentYear + 1; // Usually 2026
                
                this.showCustomConfirm(
                    'Apply Annual Increase',
                    `Apply ${increasePercentage}% annual increase starting ${targetYear}? This will affect ${targetYear} and all subsequent years until a new increase is set.`,
                    () => {
                        // Set the annual increase for the target year
                        this.setAnnualIncrease(targetYear.toString(), increasePercentage);
                        
                        // Save changes
                        this.saveAnnualIncreases();
                        
                        // Show success message
                        this.showSuccessNotification(`Annual increase of ${increasePercentage}% set for ${targetYear} and subsequent years!`);
                        
                        // Update displays
                        this.updateBillingOverview();
                        this.updateDashboard();
                    }
                );
            }
            
            clearAnnualIncreases() {
                this.showCustomConfirm(
                    'Clear Annual Increases',
                    'Clear all annual increases? This will reset 2025, 2026, and 2027 to show the same values.',
                    () => {
                        localStorage.setItem('buildsmart_annual_increases', JSON.stringify([]));
                        this.showSuccessNotification('Annual increases cleared! All years now show base values.');
                        this.updateBillingOverview();
                        this.updateDashboard();
                    }
                );
            }
            
            updateIncreaseYear(year) {
                console.log('Updating increase year to:', year);
                this.increaseYear = parseInt(year) || 2026;
                localStorage.setItem('increaseYear', this.increaseYear.toString());
                console.log('Stored increaseYear:', this.increaseYear);
                // Refresh the current page to show updated calculations if needed
                if (this.currentPage === 'clients' || this.currentPage === 'analytics') {
                    this.showPage(this.currentPage);
                }
                // Show success notification
                this.showSuccessNotification(`Year selection updated to ${this.increaseYear} for future calculations.`);
            }

            // Individual Client Increase Modal
            openClientIncreaseModal(clientId) {
                const client = this.clients.find(c => c.id === clientId);
                if (!client) return;

                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-slate-800 p-8 rounded-2xl max-w-md w-full mx-4">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-10 h-10 rounded-xl bg-emerald-500/20 flex items-center justify-center">
                                <svg class="w-5 h-5 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                    <path d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-white">Individual Client Increase</h2>
                                <p class="text-sm text-slate-400">${client.clientName}</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Custom Increase Percentage</label>
                                <div class="flex items-center space-x-3">
                                    <input type="number" id="client-increase" step="any" min="0" max="50" class="flex-1 px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="5.5">
                                    <span class="text-slate-300">%</span>
                                </div>
                            </div>
                            <div class="text-xs text-slate-400">
                                This will apply a custom increase rate to <strong>${client.clientName}</strong> for future years, overriding the global increase rate.
                            </div>
                        </div>
                        <div class="flex space-x-3 mt-8">
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 bg-slate-700 text-white rounded-xl hover:bg-slate-600 transition-colors">
                                Cancel
                            </button>
                            <button onclick="app.applyClientIncrease('${clientId}', document.getElementById('client-increase').value); this.closest('.fixed').remove()" class="flex-1 px-4 py-3 text-white rounded-xl transition-all duration-200" style="background: linear-gradient(135deg, rgba(76, 29, 149, 0.8), rgba(55, 48, 163, 0.8));" onmouseover="this.style.background='linear-gradient(135deg, rgba(76, 29, 149, 1), rgba(55, 48, 163, 1))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(76, 29, 149, 0.8), rgba(55, 48, 163, 0.8))'">
                                <div class="text-center">Apply Increase</div>
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Apply Individual Client Increase
            applyClientIncrease(clientId, increasePercentage) {
                const client = this.clients.find(c => c.id === clientId);
                if (!client) return;

                const percentage = parseFloat(increasePercentage) || 5.0;
                const currentYear = new Date().getFullYear();

                this.showConfirmDialog(
                    'Apply Individual Increase',
                    `Apply ${percentage}% individual increase to ${client.clientName} for future years?`,
                    () => {
                    // Store original 2025 values if not already stored
                    if (!client.baseYearData) {
                        client.baseYearData = {
                            jan: client.jan || 0, feb: client.feb || 0, mar: client.mar || 0,
                            apr: client.apr || 0, may: client.may || 0, jun: client.jun || 0,
                            jul: client.jul || 0, aug: client.aug || 0, sep: client.sep || 0,
                            oct: client.oct || 0, nov: client.nov || 0, dec: client.dec || 0
                        };
                    }

                    // Store the custom increase rate for this client
                    client.customIncreaseRate = percentage;

                    // Initialize future year data if needed
                    if (!client.futureYearData) {
                        client.futureYearData = {};
                    }

                    // Calculate increased values for future years using custom rate
                    for (let yearOffset = 1; yearOffset <= 3; yearOffset++) {
                        const targetYear = currentYear + yearOffset;
                        const multiplier = Math.pow(1 + percentage / 100, yearOffset);

                        client.futureYearData[targetYear] = {
                            jan: Math.round(client.baseYearData.jan * multiplier),
                            feb: Math.round(client.baseYearData.feb * multiplier),
                            mar: Math.round(client.baseYearData.mar * multiplier),
                            apr: Math.round(client.baseYearData.apr * multiplier),
                            may: Math.round(client.baseYearData.may * multiplier),
                            jun: Math.round(client.baseYearData.jun * multiplier),
                            jul: Math.round(client.baseYearData.jul * multiplier),
                            aug: Math.round(client.baseYearData.aug * multiplier),
                            sep: Math.round(client.baseYearData.sep * multiplier),
                            oct: Math.round(client.baseYearData.oct * multiplier),
                            nov: Math.round(client.baseYearData.nov * multiplier),
                            dec: Math.round(client.baseYearData.dec * multiplier)
                        };
                    }

                    // Save updated client
                    this.saveClients();

                        // Show success message
                        this.showSuccessNotification(`Individual increase of ${percentage}% applied successfully to ${client.clientName}!`);

                        // Update displays
                        this.updateBillingOverview();
                        this.updateDashboard();
                    }
                );
            }

            // Export specific report type
            exportReport(reportType, format) {
                // Generate the report data first
                this.generateReport(reportType);
                
                // Then export based on format
                if (format === 'csv') {
                    this.exportToCSV();
                } else if (format === 'xlsx') {
                    this.exportToXLSX();
                }
            }
            
            populateVarPartners() {
                const varPartnerSelect = document.getElementById('var-partner-select');
                if (varPartnerSelect) {
                    const partners = this.getVarPartners();
                    varPartnerSelect.innerHTML = '<option value="">Select VAR Partner</option>' +
                        partners.map(partner => 
                            `<option value="${partner.id}" data-rate="${partner.commissionRate}">${partner.name} - ${partner.region} (${partner.commissionRate}%)</option>`
                        ).join('');
                }
            }
            
            getVarPartnerName(partnerId) {
                const partner = this.getVarPartners().find(p => p.id === partnerId);
                return partner ? `${partner.name} (${partner.region})` : 'Unknown Partner';
            }
            
            // VAR Management Functions
            addVarPartner(formData) {
                const varId = formData.get('varId');
                const varData = {
                    id: varId || Date.now().toString(),
                    name: formData.get('companyName'),
                    region: formData.get('region'),
                    contactPerson: formData.get('contactPerson'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    commissionRate: parseFloat(formData.get('commissionRate')),
                    isActive: true,
                    createdAt: new Date().toISOString()
                };
                
                if (varId) {
                    // Edit existing VAR
                    const index = this.varPartners.findIndex(v => v.id === varId);
                    if (index !== -1) {
                        this.varPartners[index] = { ...this.varPartners[index], ...varData };
                    }
                } else {
                    // Add new VAR
                    this.varPartners.push(varData);
                }
                
                this.saveVarPartners();
                this.closeAddVarModal();
                this.showPage('vars');
            }
            
            editVarPartner(id) {
                const partner = this.varPartners.find(v => v.id === id);
                if (partner) {
                    this.openAddVarModal(partner);
                }
            }
            
            toggleVarPartnerStatus(id) {
                const partner = this.varPartners.find(v => v.id === id);
                if (partner) {
                    partner.isActive = !partner.isActive;
                    this.saveVarPartners();
                    this.showPage('vars');
                }
            }
            
            deleteVarPartner(id) {
                this.showConfirmDialog(
                    'Delete VAR Partner',
                    'Are you sure you want to delete this VAR partner?',
                    () => {
                        this.varPartners = this.varPartners.filter(v => v.id !== id);
                        this.saveVarPartners();
                        this.showSuccessNotification('VAR partner deleted successfully!');
                        this.showPage('vars');
                    }
                );
            }
            
            openAddVarModal(partner = null) {
                const modal = document.getElementById('add-var-modal');
                const form = document.getElementById('add-var-form');
                const title = document.getElementById('var-modal-title');
                const submitBtn = document.getElementById('var-submit-btn');
                
                if (partner) {
                    // Edit mode
                    title.textContent = 'Edit VAR Partner';
                    submitBtn.textContent = 'Update VAR Partner';
                    
                    // Populate form
                    form.querySelector('input[name="varId"]').value = partner.id;
                    form.querySelector('input[name="companyName"]').value = partner.name;
                    form.querySelector('select[name="region"]').value = partner.region;
                    form.querySelector('input[name="contactPerson"]').value = partner.contactPerson;
                    form.querySelector('input[name="email"]').value = partner.email;
                    form.querySelector('input[name="phone"]').value = partner.phone || '';
                    form.querySelector('input[name="commissionRate"]').value = partner.commissionRate;
                } else {
                    // Add mode
                    title.textContent = 'Add New VAR Partner';
                    submitBtn.textContent = 'Add VAR Partner';
                    form.reset();
                    form.querySelector('input[name="varId"]').value = '';
                }
                
                modal.classList.remove('hidden');
            }
            
            closeAddVarModal() {
                document.getElementById('add-var-modal').classList.add('hidden');
            }
            
            loadIncreaseYear() {
                return parseInt(localStorage.getItem('increaseYear')) || 2026;
            }

            loadGlobalAnnualIncrease() {
                return parseFloat(localStorage.getItem('globalAnnualIncrease')) || 5.0;
            }

            // Client Management
            addClient(formData) {
                const clientData = {
                    id: Date.now().toString(),
                    clientName: formData.get('clientName'),
                    debtCode: formData.get('debtCode') || '',
                    users: parseInt(formData.get('users')) || 0,
                    billingModel: formData.get('billingModel'),
                    currency: formData.get('currency'),
                    jan: parseFloat(formData.get('jan')) || 0,
                    feb: parseFloat(formData.get('feb')) || 0,
                    mar: parseFloat(formData.get('mar')) || 0,
                    apr: parseFloat(formData.get('apr')) || 0,
                    may: parseFloat(formData.get('may')) || 0,
                    jun: parseFloat(formData.get('jun')) || 0,
                    jul: parseFloat(formData.get('jul')) || 0,
                    aug: parseFloat(formData.get('aug')) || 0,
                    sep: parseFloat(formData.get('sep')) || 0,
                    oct: parseFloat(formData.get('oct')) || 0,
                    nov: parseFloat(formData.get('nov')) || 0,
                    dec: parseFloat(formData.get('dec')) || 0,
                    total: parseFloat(formData.get('total')) || 0,
                    comments: formData.get('comments') || '',
                    dealStartDate: formData.get('dealStartDate') || new Date().toISOString().split('T')[0],
                    anniversaryMonth: parseInt(formData.get('anniversaryMonth')) || new Date(formData.get('dealStartDate') || new Date()).getMonth() + 1,
                    isActive: true,
                    createdAt: new Date().toISOString()
                };
                
                // Calculate total if not provided
                if (!clientData.total) {
                    clientData.total = clientData.jan + clientData.feb + clientData.mar + 
                                     clientData.apr + clientData.may + clientData.jun + 
                                     clientData.jul + clientData.aug + clientData.sep + 
                                     clientData.oct + clientData.nov + clientData.dec;
                }

                this.clients.push(clientData);
                this.saveClients();
                this.closeAddClientModal();
                this.showPage('clients');
                
                this.showSuccessNotification('Client added successfully!', 'Your new client has been added to the system.');
            }
            
            // Search functionality
            filterClients(searchTerm) {
                const rows = document.querySelectorAll('tbody tr');
                const term = searchTerm.toLowerCase();
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(term) ? '' : 'none';
                });
            }

            addAdditionalLicense(formData) {
                const clientId = formData.get('clientId');
                const client = this.clients.find(c => c.id === clientId);
                
                if (!client) {
                    alert('Client not found');
                    return;
                }
                
                const quantity = parseInt(formData.get('quantity'));
                const pricePerUnit = parseFloat(formData.get('pricePerUnit'));
                const currency = formData.get('currency');
                const startDate = formData.get('startDate');
                
                const licenseData = {
                    id: Date.now().toString(),
                    clientId: clientId,
                    billingModel: client.billingModel,
                    quantity: quantity,
                    pricePerUnit: pricePerUnit,
                    currency: currency,
                    startDate: startDate,
                    billingPeriods: formData.get('billingPeriods') ? parseInt(formData.get('billingPeriods')) : null,
                    isActive: true,
                    createdAt: new Date().toISOString()
                };
                
                // Add VAR partner if client is VAR model
                if (client.billingModel === 'var') {
                    licenseData.varPartner = formData.get('licenseVarPartner') || client.varPartner;
                }

                // Update client's user count and add automatic comment
                const clientIndex = this.clients.findIndex(c => c.id === clientId);
                if (clientIndex !== -1) {
                    const oldUsers = this.clients[clientIndex].users || 0;
                    this.clients[clientIndex].users = oldUsers + quantity;
                    
                    // Update billing totals for rental clients
                    if (client.billingModel === 'rentals') {
                        // For rentals, the additional rental value needs to be added to monthly billing from start date
                        const monthlyRentalValue = quantity * pricePerUnit;
                        const oldTotal = this.clients[clientIndex].total || 0;
                        const startDateObj = new Date(startDate);
                        const startMonth = startDateObj.getMonth(); // 0-based (0=Jan, 11=Dec)
                        const rentalPeriods = licenseData.billingPeriods || client.rentalPeriods || 12;
                        
                        console.log(`BEFORE UPDATE - Client: ${client.clientName}, Start Date: ${startDate}, Start Month: ${startMonth + 1}, Rental Periods: ${rentalPeriods}`);
                        console.log(`Adding monthly rental: ${monthlyRentalValue} per month for ${quantity} licenses at ${pricePerUnit} each`);
                        
                        // Add to monthly billing data starting from the start date
                        const monthNames = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                        let monthsAdded = 0;
                        let totalAdded = 0;
                        
                        for (let i = 0; i < rentalPeriods && i < 12; i++) {
                            const currentMonthIndex = (startMonth + i) % 12;
                            const monthName = monthNames[currentMonthIndex];
                            const oldMonthValue = this.clients[clientIndex][monthName] || 0;
                            
                            this.clients[clientIndex][monthName] = oldMonthValue + monthlyRentalValue;
                            totalAdded += monthlyRentalValue;
                            monthsAdded++;
                            
                            console.log(`Updated ${monthName}: ${oldMonthValue} -> ${this.clients[clientIndex][monthName]} (month ${i + 1} of ${rentalPeriods})`);
                        }
                        
                        // Update the total to reflect the actual rental value added
                        this.clients[clientIndex].total = oldTotal + totalAdded;
                        
                        console.log(`AFTER UPDATE - Client: ${client.clientName}, Total: ${this.clients[clientIndex].total}, Added ${monthsAdded} months`);
                        console.log(`Updated rental billing for ${client.clientName}: ${oldTotal} -> ${this.clients[clientIndex].total} (added ${totalAdded} total, ${monthlyRentalValue} monthly for ${monthsAdded} months)`);
                    }
                    
                    // Add automatic comment about the license addition
                    const currentDate = new Date().toLocaleDateString();
                    let billingDescription = '';
                    
                    switch(client.billingModel) {
                        case 'perpetual':
                            billingDescription = 'Annual S&M';
                            break;
                        case 'subscription':
                            billingDescription = 'Monthly subscription';
                            break;
                        case 'installment':
                            billingDescription = 'Monthly instalment';
                            break;
                        case 'rentals':
                            billingDescription = 'Monthly rental';
                            break;
                        case 'var':
                            billingDescription = 'VAR commission';
                            break;
                        default:
                            billingDescription = 'billing';
                    }
                    
                    const licenseComment = `[${currentDate}] Added ${quantity} additional licenses (${oldUsers} → ${this.clients[clientIndex].users} users) - ${billingDescription}: ${this.formatCurrency(quantity * pricePerUnit, currency)}`;
                    
                    // Append to existing comments or create new
                    const existingComments = this.clients[clientIndex].comments || '';
                    this.clients[clientIndex].comments = existingComments 
                        ? `${existingComments}\n${licenseComment}` 
                        : licenseComment;
                    
                    console.log(`Updated user count for ${client.clientName}: ${oldUsers} -> ${this.clients[clientIndex].users}`);
                    this.saveClients();
                }

                this.additionalLicenses.push(licenseData);
                this.saveAdditionalLicenses();
                this.closeAddLicenseModal();
                
                // Force refresh the clients page to show updated data
                setTimeout(() => {
                    this.showPage('clients');
                }, 100);
                
                // Provide detailed success message based on billing model
                let message = `Added ${quantity} licenses to ${client.clientName}. User count updated.`;
                
                switch(client.billingModel) {
                    case 'perpetual':
                        const licenseMonth = new Date(startDate).getMonth() + 1;
                        const anniversaryMonth = client.anniversaryMonth || new Date(client.dealStartDate).getMonth() + 1;
                        const monthName = new Date(0, anniversaryMonth - 1).toLocaleString('default', { month: 'long' });
                        
                        if (licenseMonth <= anniversaryMonth) {
                            message += ` S&M billing will be prorated for alignment starting ${new Date(startDate).getFullYear() + 1}, then aligned with ${monthName} anniversary.`;
                        } else {
                            message += ` S&M billing starts ${new Date(startDate).getFullYear() + 1} with prorated billing until ${monthName} anniversary.`;
                        }
                        break;
                        
                    case 'subscription':
                        const subscriptionPeriods = licenseData.billingPeriods;
                        if (subscriptionPeriods) {
                            message += ` Monthly subscription billing will start for ${subscriptionPeriods} months at ${this.formatCurrency(quantity * pricePerUnit, currency)} per month.`;
                        } else {
                            message += ` Ongoing monthly subscription billing will start immediately at ${this.formatCurrency(quantity * pricePerUnit, currency)} per month.`;
                        }
                        break;
                        
                    case 'installment':
                        const periods = licenseData.billingPeriods || client.instalmentPeriods || 12;
                        message += ` Monthly instalment billing will start for ${periods} months at ${this.formatCurrency(quantity * pricePerUnit, currency)} per month.`;
                        break;
                        
                    case 'rentals':
                        const rentalPeriods = licenseData.billingPeriods || client.rentalPeriods || 12;
                        message += ` Monthly rental billing will start for ${rentalPeriods} months at ${this.formatCurrency(quantity * pricePerUnit, currency)} per month.`;
                        break;
                        
                    case 'var':
                        const commissionRate = client.commissionRate || 20;
                        message += ` VAR commission at ${commissionRate}% will apply to these additional licenses.`;
                        break;
                }
                
                this.showSuccessNotification('Additional License Added!', message);
            }

            updateClient(id, formData) {
                const existingClientIndex = this.clients.findIndex(c => c.id === id);
                if (existingClientIndex === -1) {
                    alert('Client not found for update');
                    return;
                }

                // Update the existing client with new data
                const updatedClient = {
                    ...this.clients[existingClientIndex],
                    clientName: formData.get('clientName'),
                    debtCode: formData.get('debtCode'),
                    users: parseInt(formData.get('users')) || 0,
                    currency: formData.get('currency'),
                    billingModel: formData.get('billingModel'),
                    comments: formData.get('comments') || '',
                    dealStartDate: formData.get('dealStartDate') || this.clients[existingClientIndex].dealStartDate,
                    anniversaryMonth: parseInt(formData.get('anniversaryMonth')) || this.clients[existingClientIndex].anniversaryMonth,
                    jan: parseFloat(formData.get('jan')) || 0,
                    feb: parseFloat(formData.get('feb')) || 0,
                    mar: parseFloat(formData.get('mar')) || 0,
                    apr: parseFloat(formData.get('apr')) || 0,
                    may: parseFloat(formData.get('may')) || 0,
                    jun: parseFloat(formData.get('jun')) || 0,
                    jul: parseFloat(formData.get('jul')) || 0,
                    aug: parseFloat(formData.get('aug')) || 0,
                    sep: parseFloat(formData.get('sep')) || 0,
                    oct: parseFloat(formData.get('oct')) || 0,
                    nov: parseFloat(formData.get('nov')) || 0,
                    dec: parseFloat(formData.get('dec')) || 0
                };

                // Calculate the total from monthly values
                updatedClient.total = updatedClient.jan + updatedClient.feb + updatedClient.mar + 
                                    updatedClient.apr + updatedClient.may + updatedClient.jun + 
                                    updatedClient.jul + updatedClient.aug + updatedClient.sep + 
                                    updatedClient.oct + updatedClient.nov + updatedClient.dec;

                // Handle VAR specific fields
                if (updatedClient.billingModel === 'var') {
                    updatedClient.varPartner = formData.get('varPartner');
                    updatedClient.commissionRate = parseFloat(formData.get('commissionRate')) || 0;
                }

                // Update the client in the array
                this.clients[existingClientIndex] = updatedClient;
                
                this.saveClients();
                this.closeAddClientModal();
                this.showPage('clients');
                
                this.showSuccessNotification('Client updated successfully!', 'Your client information has been saved and updated.');
            }

            editClient(id) {
                console.log('Edit client called with ID:', id);
                const client = this.clients.find(c => c.id === id);
                if (!client) {
                    console.error('Client not found with ID:', id);
                    alert('Client not found');
                    return;
                }
                console.log('Found client:', client);

                try {
                    // Open the modal first
                    this.openAddClientModal();
                    
                    // Get the form after modal is open
                    const form = document.getElementById('add-client-form');
                    if (!form) {
                        console.error('Form not found');
                        alert('Form not available');
                        return;
                    }

                    // Populate the edit form with client data
                    if (form.elements['clientName']) form.elements['clientName'].value = client.clientName || '';
                    if (form.elements['debtCode']) form.elements['debtCode'].value = client.debtCode || '';
                    if (form.elements['users']) form.elements['users'].value = client.users || '';
                    if (form.elements['currency']) form.elements['currency'].value = client.currency || 'ZAR';
                    if (form.elements['billingModel']) form.elements['billingModel'].value = client.billingModel || 'perpetual';
                    if (form.elements['dealStartDate']) form.elements['dealStartDate'].value = client.dealStartDate || '';
                    if (form.elements['anniversaryMonth']) form.elements['anniversaryMonth'].value = client.anniversaryMonth || '';
                    if (form.elements['comments']) form.elements['comments'].value = client.comments || '';

                    // Set monthly values
                    const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                    months.forEach(month => {
                        if (form.elements[month]) {
                            form.elements[month].value = client[month] || '';
                        }
                    });

                    // Handle billing model specific fields
                    if (typeof handleClientBillingModelChange === 'function') {
                        handleClientBillingModelChange(form.elements['billingModel']);
                    }
                    if (client.billingModel === 'var' && client.varPartner && form.elements['varPartner']) {
                        form.elements['varPartner'].value = client.varPartner;
                    }
                    if (client.commissionRate !== undefined && form.elements['commissionRate']) {
                        form.elements['commissionRate'].value = client.commissionRate;
                    }

                    // Change modal title and button text for editing
                    const modalTitle = document.querySelector('#add-client-modal h2');
                    const submitButton = document.querySelector('#add-client-modal button[type="submit"]');
                    if (modalTitle) modalTitle.textContent = 'Edit Client';
                    if (submitButton) submitButton.textContent = 'Update Client';
                    
                    // Store the client ID for updating
                    form.dataset.editingClientId = id;
                    
                    console.log('Edit form populated successfully');
                } catch (error) {
                    console.error('Error in editClient:', error);
                    alert('Error opening edit form: ' + error.message);
                }
            }

            deleteClient(id) {
                this.showConfirmDialog(
                    'Delete Client',
                    'Are you sure you want to delete this client? This will also remove all associated additional licenses.',
                    () => {
                        this.clients = this.clients.filter(client => client.id !== id);
                        this.additionalLicenses = this.additionalLicenses.filter(license => license.clientId !== id);
                        this.saveClients();
                        this.saveAdditionalLicenses();
                        this.showSuccessNotification('Client deleted successfully!');
                        this.showPage('clients');
                    }
                );
            }

            editLicense(id) {
                this.showSuccessNotification('Edit license functionality - would open modal with license data for editing');
            }

            deleteLicense(id) {
                this.showConfirmDialog(
                    'Delete Additional License',
                    'Are you sure you want to delete this additional license?',
                    () => {
                        this.additionalLicenses = this.additionalLicenses.filter(license => license.id !== id);
                        this.saveAdditionalLicenses();
                        this.showSuccessNotification('Additional license deleted successfully!');
                        this.showPage('clients');
                    }
                );
            }

            viewClientDetails(id) {
                const client = this.clients.find(c => c.id === id);
                if (!client) {
                    alert('Client not found');
                    return;
                }

                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const monthKeys = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                
                let monthlyDetailsHtml = '';
                let annualTotal = 0;

                months.forEach((month, index) => {
                    const value = parseFloat(client[monthKeys[index]]) || 0;
                    annualTotal += value;
                    monthlyDetailsHtml += `
                        <div class="flex justify-between items-center py-2 border-b border-slate-600/30">
                            <span class="text-slate-300">${month}</span>
                            <span class="text-white font-semibold">${this.formatCurrency(value, client.currency)}</span>
                        </div>
                    `;
                });

                // Get the display name for billing model
                const billingModelDisplayName = this.getBillingModelDisplayName(client.billingModel);

                // Create and show details modal
                const modal = document.createElement('div');
                modal.id = 'client-details-modal';
                modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-40';
                modal.innerHTML = `
                    <div class="bg-slate-900 rounded-2xl p-8 w-full max-w-2xl border border-slate-800 shadow-2xl animate-fade-in overflow-y-auto max-h-[80vh]">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-white">Client Monthly Details</h2>
                            <button onclick="this.closest('#client-details-modal').remove()" class="text-2xl transition-colors" style="color: rgba(148, 163, 184, 0.7);" onmouseover="this.style.color='#ffffff'" onmouseout="this.style.color='rgba(148, 163, 184, 0.7)'">×</button>
                        </div>
                        
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-white mb-2">${client.clientName}</h3>
                            <div class="text-slate-400 text-sm mb-4">
                                <span>Debt Code: ${client.debtCode}</span> • 
                                <span>Users: ${client.users}</span> • 
                                <span>Model: ${billingModelDisplayName}</span>
                            </div>
                        </div>

                        <div class="bg-slate-800/50 backdrop-blur-sm p-6 rounded-xl border border-slate-700 mb-6">
                            <h4 class="text-lg font-semibold text-white mb-4">Monthly Revenue Breakdown</h4>
                            <div class="space-y-1">
                                ${monthlyDetailsHtml}
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-600/50">
                                <div class="flex justify-between items-center">
                                    <span class="text-white font-bold">Annual Total</span>
                                    <span class="text-white font-bold text-lg">${this.formatCurrency(annualTotal, client.currency)}</span>
                                </div>
                            </div>
                        </div>

                        ${client.comments ? `
                            <div class="bg-slate-800/30 p-4 rounded-xl">
                                <h4 class="text-sm font-semibold text-slate-300 mb-2">Comments</h4>
                                <p class="text-white text-sm">${client.comments}</p>
                            </div>
                        ` : ''}

                        <div class="flex justify-end mt-6">
                            <button onclick="this.closest('#client-details-modal').remove()" class="bg-slate-600 hover:bg-slate-700 text-white py-2 px-6 rounded-xl font-medium transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            }

            // Custom Confirmation Dialog System
            showCustomConfirm(title, message, onConfirm, onCancel = null) {
                // Generate unique IDs for this dialog instance
                const dialogId = 'dialog-' + Date.now();
                const contentId = dialogId + '-content';
                const cancelId = dialogId + '-cancel';
                const confirmId = dialogId + '-confirm';
                
                const overlay = document.createElement('div');
                overlay.className = 'fixed inset-0 z-50 flex items-center justify-center';
                overlay.style.background = 'rgba(0, 0, 0, 0.8)';
                overlay.style.backdropFilter = 'blur(8px)';
                
                overlay.innerHTML = `
                    <div class="relative max-w-md w-full mx-4 transform transition-all duration-300 ease-out scale-95 opacity-0" id="${contentId}">
                        <div class="rounded-2xl shadow-2xl overflow-hidden" style="background: linear-gradient(145deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95)); border: 1px solid rgba(148, 163, 184, 0.2);">
                            <!-- Header -->
                            <div class="px-6 py-4" style="background: linear-gradient(135deg, rgba(76, 29, 149, 0.1), rgba(55, 48, 163, 0.1)); border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, rgba(76, 29, 149, 0.2), rgba(55, 48, 163, 0.2));">
                                        <svg class="w-5 h-5 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-white">${title}</h3>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Content -->
                            <div class="px-6 py-6">
                                <p class="text-slate-300 leading-relaxed">${message}</p>
                            </div>
                            
                            <!-- Actions -->
                            <div class="px-6 py-4 flex space-x-3" style="background: rgba(15, 23, 42, 0.3); border-top: 1px solid rgba(148, 163, 184, 0.1);">
                                <button id="${cancelId}" class="flex-1 px-4 py-3 rounded-xl font-medium transition-all duration-200 hover:scale-105" style="background: rgba(71, 85, 105, 0.6); color: #cbd5e1; border: 1px solid rgba(148, 163, 184, 0.2);" onmouseover="this.style.background='rgba(71, 85, 105, 0.8)'" onmouseout="this.style.background='rgba(71, 85, 105, 0.6)'">
                                    Cancel
                                </button>
                                <button id="${confirmId}" class="flex-1 px-4 py-3 rounded-xl font-medium text-white transition-all duration-200 hover:scale-105" style="background: linear-gradient(135deg, rgba(76, 29, 149, 0.8), rgba(55, 48, 163, 0.8)); border: 1px solid rgba(76, 29, 149, 0.3);" onmouseover="this.style.background='linear-gradient(135deg, rgba(76, 29, 149, 1), rgba(55, 48, 163, 1))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(76, 29, 149, 0.8), rgba(55, 48, 163, 0.8))'">
                                    Confirm
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                // Animate in
                setTimeout(() => {
                    const content = document.getElementById(contentId);
                    if (content) {
                        content.style.transform = 'scale(1)';
                        content.style.opacity = '1';
                    }
                }, 50);
                
                // Event handlers
                const cleanup = () => {
                    const content = document.getElementById(contentId);
                    if (content) {
                        content.style.transform = 'scale(0.95)';
                        content.style.opacity = '0';
                    }
                    setTimeout(() => {
                        if (overlay.parentNode) {
                            overlay.parentNode.removeChild(overlay);
                        }
                    }, 200);
                };
                
                const cancelButton = document.getElementById(cancelId);
                const confirmButton = document.getElementById(confirmId);
                
                if (cancelButton) {
                    cancelButton.onclick = () => {
                        cleanup();
                        if (onCancel) onCancel();
                    };
                }
                
                if (confirmButton) {
                    confirmButton.onclick = () => {
                        cleanup();
                        if (onConfirm) onConfirm();
                    };
                }
                
                // Close on backdrop click
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        cleanup();
                        if (onCancel) onCancel();
                    }
                };
                
                // Close on Escape key
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        cleanup();
                        if (onCancel) onCancel();
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
            }

            // Success Notification System
            showSuccessNotification(title, message) {
                // Remove any existing notifications
                const existingNotifications = document.querySelectorAll('.success-notification');
                existingNotifications.forEach(notification => notification.remove());

                // Create the notification element
                const notification = document.createElement('div');
                notification.className = 'success-notification fixed top-6 right-6 z-[60] animate-fade-in';
                notification.innerHTML = `
                    <div class="card-glass rounded-2xl p-6 shadow-2xl max-w-sm" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(21, 128, 61, 0.1) 100%); border: 1px solid rgba(34, 197, 94, 0.3);">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(21, 128, 61, 0.2)); border: 1px solid rgba(34, 197, 94, 0.4);">
                                    <svg class="w-6 h-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-semibold text-white">${title}</h3>
                                    <button onclick="this.closest('.success-notification').remove()" class="text-slate-400 hover:text-white transition-colors">
                                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                                <p class="text-sm text-slate-300 mt-1">${message}</p>
                            </div>
                        </div>
                    </div>
                `;

                // Add to page
                document.body.appendChild(notification);

                // Auto-remove after 4 seconds
                setTimeout(() => {
                    if (notification && notification.parentNode) {
                        notification.style.opacity = '0';
                        notification.style.transform = 'translateX(100%)';
                        setTimeout(() => {
                            if (notification && notification.parentNode) {
                                notification.remove();
                            }
                        }, 300);
                    }
                }, 4000);
            }

            // Modal Management
            openAddClientModal() {
                // Make sure the license modal is hidden first
                document.getElementById('add-license-modal').classList.add('hidden');
                // Then show the client modal
                document.getElementById('add-client-modal').classList.remove('hidden');
                console.log('Opening Add Client Modal');
            }

            closeAddClientModal() {
                document.getElementById('add-client-modal').classList.add('hidden');
                const form = document.getElementById('add-client-form');
                form.reset();
                
                // Reset modal title and button text
                document.querySelector('#add-client-modal h2').textContent = 'Add New Client';
                document.querySelector('#add-client-modal button[type="submit"]').textContent = 'Add Client';
                
                // Remove editing flag
                delete form.dataset.editingClientId;
            }

            openAddLicenseModal() {
                console.log('Opening Add License Modal - Starting...');
                
                // First, try creating a simple test modal to see if modals work at all
                const testModal = document.createElement('div');
                testModal.id = 'test-modal';
                testModal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 99999; display: flex; justify-content: center; align-items: center; overflow-y: auto;">
                        <div style="background: linear-gradient(135deg, #1e293b, #0f172a); padding: 32px; border-radius: 24px; max-width: 600px; width: 90%; border: 1px solid rgba(76, 29, 149, 0.3); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8); max-height: 90vh; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                <h2 style="color: white; margin: 0; font-size: 24px; font-weight: bold;">Add Additional License</h2>
                                <button type="button" onclick="closeSimpleLicenseModal()" style="background: none; border: none; color: #94a3b8; font-size: 24px; cursor: pointer; padding: 4px;">×</button>
                            </div>
                            <form id="simple-license-form" style="display: grid; gap: 20px;">
                                <div>
                                    <label style="display: block; color: #cbd5e1; margin-bottom: 8px; font-weight: 500; font-size: 14px;">Client</label>
                                    <select name="clientId" required style="width: 100%; padding: 12px 16px; background: #374151; border: 1px solid #4b5563; border-radius: 12px; color: white; font-size: 14px;" id="simple-client-select" onchange="handleSimpleClientChange(this)">
                                        <!-- Options will be populated -->
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; color: #cbd5e1; margin-bottom: 8px; font-weight: 500; font-size: 14px;">Billing Model</label>
                                    <select name="billingModel" required style="width: 100%; padding: 12px 16px; background: #374151; border: 1px solid #4b5563; border-radius: 12px; color: white; font-size: 14px;" id="simple-billing-model" onchange="handleSimpleBillingModelChange(this)">
                                        <option value="">Select Billing Model</option>
                                        <option value="perpetual">Perpetual</option>
                                        <option value="subscription">Subscription</option>
                                        <option value="installment">Instalment</option>
                                        <option value="var">VAR</option>
                                        <option value="rentals">Rentals</option>
                                    </select>
                                </div>
                                <div id="simple-var-partner-field" style="display: none;">
                                    <label style="display: block; color: #cbd5e1; margin-bottom: 8px; font-weight: 500; font-size: 14px;">VAR Partner</label>
                                    <select name="licenseVarPartner" style="width: 100%; padding: 12px 16px; background: #374151; border: 1px solid #4b5563; border-radius: 12px; color: white; font-size: 14px;" id="simple-var-partner-select">
                                        <!-- Options populated by JavaScript -->
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; color: #cbd5e1; margin-bottom: 8px; font-weight: 500; font-size: 14px;">Quantity/Users</label>
                                    <input type="number" name="quantity" min="1" required style="width: 100%; padding: 12px 16px; background: #374151; border: 1px solid #4b5563; border-radius: 12px; color: white; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; color: #cbd5e1; margin-bottom: 8px; font-weight: 500; font-size: 14px;" id="simple-price-label">Price Per Unit</label>
                                    <input type="number" name="pricePerUnit" step="0.01" min="0" required style="width: 100%; padding: 12px 16px; background: #374151; border: 1px solid #4b5563; border-radius: 12px; color: white; font-size: 14px;" placeholder="Price per unit" id="simple-price-input">
                                </div>
                                <div>
                                    <label style="display: block; color: #cbd5e1; margin-bottom: 8px; font-weight: 500; font-size: 14px;">Currency</label>
                                    <select name="currency" required style="width: 100%; padding: 12px 16px; background: #374151; border: 1px solid #4b5563; border-radius: 12px; color: white; font-size: 14px;">
                                        <option value="ZAR">ZAR - South African Rand</option>
                                        <option value="USD">USD - US Dollar</option>
                                        <option value="EUR">EUR - Euro</option>
                                        <option value="GBP">GBP - British Pound</option>
                                        <option value="CAD">CAD - Canadian Dollar</option>
                                        <option value="AUD">AUD - Australian Dollar</option>
                                        <option value="JPY">JPY - Japanese Yen</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; color: #cbd5e1; margin-bottom: 8px; font-weight: 500; font-size: 14px;">Start Date</label>
                                    <input type="date" name="startDate" required style="width: 100%; padding: 12px 16px; background: #374151; border: 1px solid #4b5563; border-radius: 12px; color: white; font-size: 14px;">
                                </div>
                                <div id="simple-billing-periods-field" style="display: none;">
                                    <label style="display: block; color: #cbd5e1; margin-bottom: 8px; font-weight: 500; font-size: 14px;" id="simple-periods-label">Number of Months</label>
                                    <input type="number" name="billingPeriods" min="1" max="120" style="width: 100%; padding: 12px 16px; background: #374151; border: 1px solid #4b5563; border-radius: 12px; color: white; font-size: 14px;" placeholder="Number of months" id="simple-periods-input">
                                </div>
                                <div style="background: rgba(15, 15, 35, 0.6); border: 1px solid rgba(76, 29, 149, 0.5); border-radius: 12px; padding: 16px;" id="simple-billing-info">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <svg style="width: 16px; height: 16px; margin-right: 8px; color: #94a3b8;" fill="currentColor" viewBox="0 0 24 24"><path d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                                        <h4 style="margin: 0; color: #94a3b8; font-weight: 600;" id="simple-billing-title">Billing Information</h4>
                                    </div>
                                    <div style="color: rgba(255, 255, 255, 0.8); font-size: 14px;" id="simple-billing-text">
                                        Select a billing model to see specific billing information.
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: center; gap: 16px; margin-top: 8px;">
                                    <button type="button" onclick="closeSimpleLicenseModal()" style="background: rgba(0, 51, 102, 0.5); color: white; padding: 12px 24px; border: none; border-radius: 12px; cursor: pointer; font-weight: 500; transition: all 0.2s;">Cancel</button>
                                    <button type="submit" style="background: linear-gradient(135deg, #4c1d95, #003366); color: white; padding: 12px 24px; border: none; border-radius: 12px; cursor: pointer; font-weight: 500; box-shadow: 0 4px 14px 0 rgba(76, 29, 149, 0.4); transition: all 0.2s;"><div class="text-center">Add License</div></button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                // Remove any existing test modal
                const existingTest = document.getElementById('test-modal');
                if (existingTest) {
                    existingTest.remove();
                }
                
                // Add to page
                document.body.appendChild(testModal);
                
                // Populate client dropdown
                const clientSelect = document.getElementById('simple-client-select');
                if (clientSelect) {
                    clientSelect.innerHTML = '<option value="">Select Client</option>' +
                        this.clients.map(client => 
                            `<option value="${client.id}" data-billing-model="${client.billingModel}" data-var-partner="${client.varPartner || ''}">${client.clientName || client.companyName || 'Unnamed Client'}</option>`
                        ).join('');
                }
                
                // Populate VAR partners dropdown
                const varPartnerSelect = document.getElementById('simple-var-partner-select');
                if (varPartnerSelect) {
                    const partners = this.getVarPartners().filter(p => p.isActive);
                    varPartnerSelect.innerHTML = '<option value="">Select VAR Partner</option>' +
                        partners.map(partner => 
                            `<option value="${partner.id}">${partner.name} - ${partner.region} (${partner.commissionRate}%)</option>`
                        ).join('');
                }
                
                // Handle form submission
                document.getElementById('simple-license-form').onsubmit = (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const billingPeriods = formData.get('billingPeriods');
                    
                    const newLicense = {
                        id: Date.now(),
                        clientId: formData.get('clientId'),
                        billingModel: formData.get('billingModel'),
                        quantity: parseInt(formData.get('quantity')),
                        pricePerUnit: parseFloat(formData.get('pricePerUnit')),
                        currency: formData.get('currency'),
                        startDate: formData.get('startDate'),
                        licenseVarPartner: formData.get('licenseVarPartner') || null,
                        billingPeriods: billingPeriods ? parseInt(billingPeriods) : null
                    };
                    
                    // Call the full addAdditionalLicense method instead
                    this.addAdditionalLicense(formData);
                    testModal.remove();
                };
                
                console.log('Simple test modal created and should be visible');
            }
            
            populateVarPartnersForLicense() {
                const varPartnerSelect = document.getElementById('license-var-partner-select');
                if (varPartnerSelect) {
                    const partners = this.getVarPartners().filter(p => p.isActive);
                    varPartnerSelect.innerHTML = '<option value="">Select VAR Partner</option>' +
                        partners.map(partner => 
                            `<option value="${partner.id}">${partner.name} - ${partner.region} (${partner.commissionRate}%)</option>`
                        ).join('');
                }
            }
            
            handleLicenseClientChange(select) {
                const selectedOption = select.options[select.selectedIndex];
                const billingModel = selectedOption.dataset.billingModel;
                const varPartner = selectedOption.dataset.varPartner;
                const varField = document.getElementById('license-var-partner-field');
                const varSelect = document.getElementById('license-var-partner-select');
                const licenseModelSelect = document.getElementById('license-billing-model');
                
                // Auto-select billing model if client is VAR
                if (billingModel === 'var' && licenseModelSelect) {
                    licenseModelSelect.value = 'var';
                    varField.classList.remove('hidden');
                    if (varPartner) {
                        varSelect.value = varPartner;
                    }
                } else {
                    // Reset billing model selection
                    if (licenseModelSelect) {
                        licenseModelSelect.value = '';
                    }
                    varField.classList.add('hidden');
                }
            }
            
            handleLicenseBillingModelChange(select) {
                const varField = document.getElementById('license-var-partner-field');
                const priceLabel = document.getElementById('price-per-unit-label');
                const priceInput = document.getElementById('price-per-unit-input');
                const billingInfoTitle = document.getElementById('billing-info-title');
                const billingInfoText = document.getElementById('billing-info-text');
                
                // Handle VAR partner field
                if (select.value === 'var') {
                    varField.classList.remove('hidden');
                } else {
                    varField.classList.add('hidden');
                }
                
                // Update labels and info based on billing model
                switch(select.value) {
                    case 'perpetual':
                        priceLabel.textContent = 'Annual Support & Maintenance Value';
                        priceInput.placeholder = 'Annual S&M value per unit';
                        billingInfoTitle.textContent = 'Perpetual License Billing';
                        billingInfoText.textContent = 'Additional licenses will be prorated and aligned to the client\'s anniversary month for S&M billing. Year 1 is free, Year 2 is prorated, Year 3+ is full annual billing.';
                        break;
                        
                    case 'subscription':
                        priceLabel.textContent = 'Monthly Subscription Value';
                        priceInput.placeholder = 'Monthly subscription value per unit';
                        billingInfoTitle.textContent = 'Subscription Billing';
                        billingInfoText.textContent = 'Additional licenses will be added to the monthly subscription billing immediately at the specified monthly rate per unit.';
                        break;
                        
                    case 'installment':
                        priceLabel.textContent = 'Monthly Instalment Value';
                        priceInput.placeholder = 'Monthly instalment value per unit';
                        billingInfoTitle.textContent = 'Instalment Billing';
                        billingInfoText.textContent = 'Additional licenses will be billed as monthly instalments for the specified period at the monthly rate per unit.';
                        break;
                        
                    case 'rentals':
                        priceLabel.textContent = 'Monthly Rental Value';
                        priceInput.placeholder = 'Monthly rental value per unit';
                        billingInfoTitle.textContent = 'Rental Billing';
                        billingInfoText.textContent = 'Additional licenses will be billed as monthly rentals for the specified period at the monthly rate per unit.';
                        break;
                        
                    case 'var':
                        priceLabel.textContent = 'Commission Value';
                        priceInput.placeholder = 'Commission value per unit';
                        billingInfoTitle.textContent = 'VAR Partner Billing';
                        billingInfoText.textContent = 'Additional licenses will generate commission payments to the VAR partner based on the specified commission rate.';
                        break;
                        
                    default:
                        priceLabel.textContent = 'Price Per Unit';
                        priceInput.placeholder = 'Price per unit';
                        billingInfoTitle.textContent = 'Billing Information';
                        billingInfoText.textContent = 'Select a billing model to see specific billing information.';
                        break;
                }
            }

            closeAddLicenseModal() {
                const modal = document.getElementById('add-license-modal');
                modal.classList.add('hidden');
                modal.style.display = 'none';
                document.getElementById('add-license-form').reset();
            }
            
            openBillingConfigModal() {
                document.getElementById('billing-config-modal').classList.remove('hidden');
                this.loadBillingModelConfig();
            }
            
            closeBillingConfigModal() {
                document.getElementById('billing-config-modal').classList.add('hidden');
                document.getElementById('billing-config-form').reset();
            }
            
            getBillingModelSettings() {
                const saved = localStorage.getItem('buildsmart_billing_settings');
                const defaults = {
                    perpetual: {
                        year1Policy: 'free',
                        alignment: 'anniversary',
                        defaultAnniversary: 1
                    },
                    subscription: {
                        frequency: 'monthly',
                        renewal: 'auto',
                        gracePeriod: 7
                    },
                    var: {
                        defaultCommission: 20,
                        paymentTerms: 'net30',
                        minThreshold: 1000
                    },
                    installment: {
                        defaultPeriod: 12,
                        latePolicy: 'grace',
                        interestRate: 0
                    },
                    rentals: {
                        defaultPeriod: 12,
                        monthlyFactor: 0.08,
                        securityDeposit: 10
                    }
                };
                
                return saved ? { ...defaults, ...JSON.parse(saved) } : defaults;
            }
            
            saveBillingModelSettings(settings) {
                localStorage.setItem('buildsmart_billing_settings', JSON.stringify(settings));
                this.showSuccessNotification('Settings Saved', 'Billing model configurations have been updated successfully.');
            }
            
            loadBillingModelConfig() {
                const configDiv = document.getElementById('billing-model-config');
                const billingSettings = this.getBillingModelSettings();
                
                configDiv.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Perpetual Model Settings -->
                        <div class="bg-slate-800/50 p-6 rounded-xl">
                            <h3 class="text-xl font-bold text-white mb-4">Perpetual License Settings</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Year 1 S&M Policy (Additional Licenses Only)</label>
                                    <select name="perpetual_year1_policy" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                        <option value="free" ${billingSettings.perpetual.year1Policy === 'free' ? 'selected' : ''}>Free (New Additional Licenses Only)</option>
                                        <option value="prorated" ${billingSettings.perpetual.year1Policy === 'prorated' ? 'selected' : ''}>Prorated from Start Date</option>
                                        <option value="full" ${billingSettings.perpetual.year1Policy === 'full' ? 'selected' : ''}>Full Annual Amount</option>
                                    </select>
                                    <p class="text-xs text-slate-400 mt-2">Note: Existing perpetual clients always pay S&M from Year 1. Free year only applies to new additional licenses.</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Additional License Alignment</label>
                                    <select name="perpetual_alignment" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                        <option value="anniversary" ${billingSettings.perpetual.alignment === 'anniversary' ? 'selected' : ''}>Align to Anniversary Month</option>
                                        <option value="immediate" ${billingSettings.perpetual.alignment === 'immediate' ? 'selected' : ''}>Immediate Full Billing</option>
                                        <option value="calendar" ${billingSettings.perpetual.alignment === 'calendar' ? 'selected' : ''}>Calendar Year Alignment</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Subscription Model Settings -->
                        <div class="bg-slate-800/50 p-6 rounded-xl">
                            <h3 class="text-xl font-bold text-white mb-4">Subscription Model Settings</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Default Billing Frequency</label>
                                    <select name="subscription_frequency" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                        <option value="monthly" ${billingSettings.subscription.frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                                        <option value="quarterly" ${billingSettings.subscription.frequency === 'quarterly' ? 'selected' : ''}>Quarterly</option>
                                        <option value="semi-annual" ${billingSettings.subscription.frequency === 'semi-annual' ? 'selected' : ''}>Semi-Annual</option>
                                        <option value="annual" ${billingSettings.subscription.frequency === 'annual' ? 'selected' : ''}>Annual</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Grace Period (Days)</label>
                                    <input type="number" name="subscription_grace_period" min="0" max="90" value="${billingSettings.subscription.gracePeriod}" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                </div>
                            </div>
                        </div>

                        <!-- VAR Model Settings -->
                        <div class="bg-slate-800/50 p-6 rounded-xl">
                            <h3 class="text-xl font-bold text-white mb-4">VAR Partnership Settings</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Default Commission Rate (%)</label>
                                    <input type="number" name="var_default_commission" step="0.1" min="0" max="50" value="${billingSettings.var.defaultCommission}" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Minimum Commission Threshold</label>
                                    <input type="number" name="var_min_threshold" step="100" min="0" value="${billingSettings.var.minThreshold}" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                </div>
                            </div>
                        </div>

                        <!-- Instalment Model Settings -->
                        <div class="bg-slate-800/50 p-6 rounded-xl">
                            <h3 class="text-xl font-bold text-white mb-4">Instalment Model Settings</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Default Period (Months)</label>
                                    <input type="number" name="installment_default_period" min="1" max="60" value="${billingSettings.installment.defaultPeriod}" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Interest Rate (% per month)</label>
                                    <input type="number" name="installment_interest_rate" step="0.1" min="0" max="10" value="${billingSettings.installment.interestRate}" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                </div>
                            </div>
                        </div>

                        <!-- Rentals Model Settings -->
                        <div class="bg-slate-800/50 p-6 rounded-xl">
                            <h3 class="text-xl font-bold text-white mb-4">Rentals Model Settings</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Default Rental Period (Months)</label>
                                    <input type="number" name="rentals_default_period" min="1" max="120" value="${billingSettings.rentals?.defaultPeriod || 12}" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Monthly Rate Factor</label>
                                    <input type="number" name="rentals_monthly_factor" step="0.01" min="0.01" max="1" value="${billingSettings.rentals?.monthlyFactor || 0.08}" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Security Deposit (%)</label>
                                    <input type="number" name="rentals_security_deposit" step="5" min="0" max="100" value="${billingSettings.rentals?.securityDeposit || 10}" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            handleBillingModelChange(selectElement) {
                const model = selectElement.value;
                this.hideBillingSpecificFields();
                
                if (model === 'subscription') {
                    document.getElementById('subscription-fields').classList.remove('hidden');
                } else if (model === 'var') {
                    document.getElementById('var-fields').classList.remove('hidden');
                    // Populate VAR partners when VAR is selected
                    this.populateVarPartners();
                }
            }

            hideBillingSpecificFields() {
                document.getElementById('subscription-fields').classList.add('hidden');
                document.getElementById('var-fields').classList.add('hidden');
            }

            // Data Export Functions
            exportToCSV() {
                const headers = [
                    'Company Name', 'Contact Person', 'Email', 'Phone', 'Billing Model',
                    'Currency', 'Deal Value', 'Users', 'Start Date', 'Anniversary Month',
                    'Current Year S&M', 'Status'
                ];
                
                const currentYear = new Date().getFullYear();
                const rows = this.clients.map(client => [
                    client.companyName,
                    client.contactPerson,
                    client.email,
                    client.phone || '',
                    client.billingModel,
                    client.currency,
                    client.total || 0,
                    client.users || 0,
                    client.dealStartDate,
                    client.anniversaryMonth,
                    client.billingModel === 'perpetual' ? (client.total || 0) : 'N/A',
                    client.isActive ? 'Active' : 'Inactive'
                ]);

                const csvContent = [headers, ...rows].map(row => 
                    row.map(field => `"${field}"`).join(',')
                ).join('\\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `billtracker-clients-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            exportToJSON() {
                const data = {
                    exportDate: new Date().toISOString(),
                    clients: this.clients,
                    additionalLicenses: this.additionalLicenses,
                    annualIncreases: this.getAnnualIncreases(),
                    metadata: {
                        totalClients: this.clients.length,
                        totalLicenses: this.getTotalLicenses(),
                        currentARR: this.calculateARR()
                    }
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `billtracker-complete-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            exportData() {
                this.exportToJSON();
            }

            importData() {
                // Show billing model selection modal first
                document.getElementById('import-modal').classList.remove('hidden');
            }
            
            startImportProcess() {
                const billingModel = document.getElementById('import-billing-model').value;
                if (!billingModel) {
                    alert('Please select a billing model for the imported clients.');
                    return;
                }
                
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.csv,.xlsx,.xls';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.name.endsWith('.csv')) {
                            this.processCSVFile(file, billingModel);
                        } else if (file.name.endsWith('.xlsx')) {
                            this.processExcelFile(file, billingModel);
                        }
                        document.getElementById('import-modal').classList.add('hidden');
                    }
                };
                input.click();
            }
            
            processExcelFile(file, billingModel) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Get the first worksheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Convert to JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            alert('Excel file appears to be empty or has no data rows.');
                            return;
                        }
                        
                        // Parse Excel data (skip header row)
                        const importedClients = [];
                        const headers = jsonData[0];
                        console.log('Excel Headers:', headers);
                        
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            
                            if (row.length >= 16 && (row[0] || row[1])) { // Must have users or client name
                                const client = {
                                    id: Date.now() + Math.random() + i,
                                    users: parseInt(row[0]) || 0,
                                    clientName: row[1] || `Client ${i}`,
                                    debtCode: row[2] || '',
                                    jan: parseFloat(row[3]) || 0,
                                    feb: parseFloat(row[4]) || 0,
                                    mar: parseFloat(row[5]) || 0,
                                    apr: parseFloat(row[6]) || 0,
                                    may: parseFloat(row[7]) || 0,
                                    jun: parseFloat(row[8]) || 0,
                                    jul: parseFloat(row[9]) || 0,
                                    aug: parseFloat(row[10]) || 0,
                                    sep: parseFloat(row[11]) || 0,
                                    oct: parseFloat(row[12]) || 0,
                                    nov: parseFloat(row[13]) || 0,
                                    dec: parseFloat(row[14]) || 0,
                                    total: parseFloat(row[15]) || 0,
                                    comments: row[16] || '',
                                    currency: 'ZAR', // Default currency
                                    dealStartDate: new Date().toISOString().split('T')[0],
                                    isActive: true,
                                    createdAt: new Date().toISOString()
                                };
                                
                                importedClients.push(client);
                            }
                        }
                        
                        if (importedClients.length > 0) {
                            this.clients = [...this.clients, ...importedClients];
                            this.saveClients();
                            alert(`🎉 Successfully imported ${importedClients.length} clients from Excel!\n\nExpected Excel columns:\nUsers | Client Name | Debt Code | Jan | Feb | Mar | Apr | May | Jun | Jul | Aug | Sep | Oct | Nov | Dec | Total | Comments`);
                            this.showPage('clients');
                        } else {
                            alert('No valid client data found in Excel file.\n\nExpected Excel columns:\nUsers | Client Name | Debt Code | Jan | Feb | Mar | Apr | May | Jun | Jul | Aug | Sep | Oct | Nov | Dec | Total | Comments');
                        }
                        
                    } catch (error) {
                        console.error('Excel parsing error:', error);
                        alert('Error reading Excel file. Please ensure it\'s a valid .xlsx file with the expected format.\n\nExpected columns:\nUsers | Client Name | Debt Code | Jan | Feb | Mar | Apr | May | Jun | Jul | Aug | Sep | Oct | Nov | Dec | Total | Comments');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            excelDateToJS(excelDate) {
                if (!excelDate) return null;
                
                // If it's already a date string, return it
                if (typeof excelDate === 'string') {
                    return excelDate;
                }
                
                // Excel date conversion (Excel epoch starts 1900-01-01)
                if (typeof excelDate === 'number') {
                    const date = new Date((excelDate - 25569) * 86400 * 1000);
                    return date.toISOString().split('T')[0];
                }
                
                return new Date().toISOString().split('T')[0];
            }
            
            processCSVFile(file, billingModel) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim());
                        
                        if (lines.length < 2) {
                            alert('CSV file appears to be empty or invalid format.');
                            return;
                        }
                        
                        // Parse CSV data
                        const importedClients = [];
                        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                        
                        console.log('CSV Headers:', headers);
                        
                        for (let i = 1; i < lines.length; i++) {
                            // Properly parse CSV with potential quoted values
                            const values = this.parseCSVLine(lines[i]);
                            
                            if (values.length >= 16 && (values[0] || values[1])) {
                                const client = {
                                    id: Date.now() + Math.random() + i,
                                    users: parseInt(values[0]) || 0,
                                    clientName: values[1] || `Client ${i}`,
                                    debtCode: values[2] || '',
                                    jan: parseFloat(values[3]?.replace(/[^\d.-]/g, '')) || 0,
                                    feb: parseFloat(values[4]?.replace(/[^\d.-]/g, '')) || 0,
                                    mar: parseFloat(values[5]?.replace(/[^\d.-]/g, '')) || 0,
                                    apr: parseFloat(values[6]?.replace(/[^\d.-]/g, '')) || 0,
                                    may: parseFloat(values[7]?.replace(/[^\d.-]/g, '')) || 0,
                                    jun: parseFloat(values[8]?.replace(/[^\d.-]/g, '')) || 0,
                                    jul: parseFloat(values[9]?.replace(/[^\d.-]/g, '')) || 0,
                                    aug: parseFloat(values[10]?.replace(/[^\d.-]/g, '')) || 0,
                                    sep: parseFloat(values[11]?.replace(/[^\d.-]/g, '')) || 0,
                                    oct: parseFloat(values[12]?.replace(/[^\d.-]/g, '')) || 0,
                                    nov: parseFloat(values[13]?.replace(/[^\d.-]/g, '')) || 0,
                                    dec: parseFloat(values[14]?.replace(/[^\d.-]/g, '')) || 0,
                                    total: parseFloat(values[15]?.replace(/[^\d.-]/g, '')) || 0,
                                    comments: values[16] || '',
                                    currency: 'ZAR',
                                    dealStartDate: new Date().toISOString().split('T')[0],
                                    isActive: true,
                                    createdAt: new Date().toISOString()
                                };
                                
                                importedClients.push(client);
                            }
                        }
                        
                        if (importedClients.length > 0) {
                            this.clients = [...this.clients, ...importedClients];
                            this.saveClients();
                            alert(`Successfully imported ${importedClients.length} clients!\n\nExpected CSV format:\nUsers, Client Name, Debt Code, Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oct, Nov, Dec, Total, Comments`);
                            this.showPage('clients');
                        } else {
                            alert('No valid client data found in file.\n\nExpected CSV format:\nUsers, Client Name, Debt Code, Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oct, Nov, Dec, Total, Comments');
                        }
                        
                    } catch (error) {
                        console.error('CSV parsing error:', error);
                        alert('Error reading CSV file. Please ensure it\'s properly formatted.\n\nExpected format:\nUsers, Client Name, Debt Code, Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oct, Nov, Dec, Total, Comments');
                    }
                };
                reader.readAsText(file);
            }
            
            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current.trim());
                return result.map(val => val.replace(/"/g, ''));
            }
            
            clearAllData() {
                if (confirm('⚠️ WARNING: This will permanently delete ALL your data including:\n\n• All clients\n• All additional licenses\n• All annual increases\n• All custom settings\n\nThis action cannot be undone. Are you absolutely sure?')) {
                    if (confirm('Final confirmation: Click OK to permanently delete ALL data, or Cancel to keep your data safe.')) {
                        try {
                            // Clear all arrays
                            this.clients = [];
                            this.additionalLicenses = [];
                            
                            // Clear localStorage completely
                            localStorage.removeItem('buildsmart_clients');
                            localStorage.removeItem('buildsmart_additional_licenses');
                            localStorage.removeItem('buildsmart_annual_increases');
                            
                            // Clear any cached data
                            localStorage.clear();
                            
                            // Reset to initial state with fresh sample data
                            this.initializeData();
                            
                            // Force save the new state
                            this.saveClients();
                            this.saveAdditionalLicenses();
                            
                            // Refresh the current page display
                            this.currentPage = 'dashboard';
                            this.render();
                            
                            this.showSuccessNotification('All data has been cleared successfully! Sample data has been restored so you can see how the application works.');
                            
                        } catch (error) {
                            console.error('Error clearing data:', error);
                            this.showSuccessNotification('Error occurred while clearing data. Please refresh the page and try again.');
                        }
                    }
                }
            }

            generateReport(type) {
                const reportOutput = document.getElementById('report-output');
                if (!reportOutput) return;

                let reportContent = '';
                const currentDate = new Date().toLocaleDateString('en-ZA');

                switch(type) {
                    case 'sm-forecast':
                        reportContent = this.generateSMForecastReport();
                        break;
                    case 'licenses':
                        reportContent = this.generateLicenseAuditReport();
                        break;
                    case 'revenue':
                        reportContent = this.generateRevenueAnalysisReport();
                        break;
                    case 'var':
                        reportContent = this.generateVARCommissionReport();
                        break;
                    case 'client-summary':
                        reportContent = this.generateClientSummaryReport();
                        break;
                    case 'monthly-breakdown':
                        reportContent = this.generateMonthlyBreakdownReport();
                        break;
                    case 'payment-status':
                        reportContent = this.generatePaymentStatusReport();
                        break;
                    case 'growth-metrics':
                        reportContent = this.generateGrowthMetricsReport();
                        break;
                    default:
                        reportContent = `<div class="text-center text-slate-400 py-8">Report type "${type}" not implemented yet.</div>`;
                }

                reportOutput.innerHTML = `
                    <div class="card-glass p-6 rounded-2xl" style="border: 1px solid rgba(76, 29, 149, 0.4);">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-white">${this.getReportTitle(type)}</h3>
                            <button onclick="document.getElementById('report-output').classList.add('hidden')" class="text-slate-400 hover:text-white">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                        <div class="text-xs text-slate-400 mb-4">Generated on ${currentDate}</div>
                        ${reportContent}
                    </div>
                `;
                reportOutput.classList.remove('hidden');
                reportOutput.scrollIntoView({ behavior: 'smooth' });
            }

            getReportTitle(type) {
                const titles = {
                    'sm-forecast': 'S&M Forecast Report',
                    'licenses': 'License Audit Report',
                    'revenue': 'Revenue Analysis Report',
                    'var': 'VAR Commission Report',
                    'client-summary': 'Client Summary Report',
                    'monthly-breakdown': 'Monthly Breakdown Report',
                    'payment-status': 'Payment Status Report',
                    'growth-metrics': 'Growth Metrics Report'
                };
                return titles[type] || 'Report';
            }

            generateSMForecastReport() {
                const perpetualClients = this.clients.filter(c => c.billingModel === 'perpetual');
                const totalSM = perpetualClients.reduce((sum, client) => sum + (client.total || 0), 0);
                
                return `
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-slate-800/50 p-4 rounded-xl">
                                <div class="text-sm text-slate-400">Current S&M Base</div>
                                <div class="text-xl font-semibold text-white">R ${totalSM.toLocaleString()}</div>
                            </div>
                            <div class="bg-slate-800/50 p-4 rounded-xl">
                                <div class="text-sm text-slate-400">Year 2 Projection (10%)</div>
                                <div class="text-xl font-semibold text-white">R ${(totalSM * 1.1).toLocaleString()}</div>
                            </div>
                            <div class="bg-slate-800/50 p-4 rounded-xl">
                                <div class="text-sm text-slate-400">Year 3 Projection (10%)</div>
                                <div class="text-xl font-semibold text-white">R ${(totalSM * 1.21).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-xl">
                            <h4 class="font-semibold text-white mb-2">S&M Client Breakdown</h4>
                            <div class="space-y-2">
                                ${perpetualClients.map(client => `
                                    <div class="flex justify-between text-sm">
                                        <span class="text-slate-300">${client.clientName}</span>
                                        <span class="text-white">R ${(client.total || 0).toLocaleString()}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            generateLicenseAuditReport() {
                const totalUsers = this.clients.reduce((sum, c) => sum + (c.users || 0), 0);
                const additionalLicenses = this.additionalLicenses.reduce((sum, l) => sum + l.quantity, 0);
                
                return `
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-slate-800/50 p-4 rounded-xl">
                                <div class="text-sm text-slate-400">Base User Licenses</div>
                                <div class="text-xl font-semibold text-white">${totalUsers.toLocaleString()}</div>
                            </div>
                            <div class="bg-slate-800/50 p-4 rounded-xl">
                                <div class="text-sm text-slate-400">Additional Licenses</div>
                                <div class="text-xl font-semibold text-white">${additionalLicenses.toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-xl">
                            <h4 class="font-semibold text-white mb-2">License Breakdown by Client</h4>
                            <div class="space-y-2">
                                ${this.clients.map(client => `
                                    <div class="flex justify-between text-sm">
                                        <span class="text-slate-300">${client.clientName}</span>
                                        <span class="text-white">${client.users || 0} users</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            generateRevenueAnalysisReport() {
                const totalRevenue = this.clients.reduce((sum, c) => sum + (c.total || 0), 0);
                const modelBreakdown = {
                    perpetual: this.clients.filter(c => c.billingModel === 'perpetual').reduce((sum, c) => sum + (c.total || 0), 0),
                    subscription: this.clients.filter(c => c.billingModel === 'subscription').reduce((sum, c) => sum + (c.total || 0), 0),
                    var: this.clients.filter(c => c.billingModel === 'var').reduce((sum, c) => sum + (c.total || 0), 0),
                    installment: this.clients.filter(c => c.billingModel === 'installment').reduce((sum, c) => sum + (c.total || 0), 0),
                    rentals: this.clients.filter(c => c.billingModel === 'rentals').reduce((sum, c) => sum + (c.total || 0), 0)
                };

                return `
                    <div class="space-y-4">
                        <div class="bg-slate-800/50 p-4 rounded-xl">
                            <div class="text-sm text-slate-400">Total Revenue</div>
                            <div class="text-2xl font-bold text-white">R ${totalRevenue.toLocaleString()}</div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-slate-800/50 p-4 rounded-xl">
                                <div class="text-sm text-slate-400">Perpetual</div>
                                <div class="text-lg font-semibold text-white">R ${modelBreakdown.perpetual.toLocaleString()}</div>
                            </div>
                            <div class="bg-slate-800/50 p-4 rounded-xl">
                                <div class="text-sm text-slate-400">Subscription</div>
                                <div class="text-lg font-semibold text-white">R ${modelBreakdown.subscription.toLocaleString()}</div>
                            </div>
                            <div class="bg-slate-800/50 p-4 rounded-xl">
                                <div class="text-sm text-slate-400">VAR</div>
                                <div class="text-lg font-semibold text-white">R ${modelBreakdown.var.toLocaleString()}</div>
                            </div>
                            <div class="bg-slate-800/50 p-4 rounded-xl">
                                <div class="text-sm text-slate-400">Instalment</div>
                                <div class="text-lg font-semibold text-white">R ${modelBreakdown.installment.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            generateVARCommissionReport() {
                const varClients = this.clients.filter(c => c.billingModel === 'var');
                const totalCommission = varClients.reduce((sum, client) => {
                    return sum + ((client.total || 0) * (client.commissionRate || 20) / 100);
                }, 0);

                return `
                    <div class="space-y-4">
                        <div class="bg-slate-800/50 p-4 rounded-xl">
                            <div class="text-sm text-slate-400">Total VAR Commission</div>
                            <div class="text-2xl font-bold text-white">R ${totalCommission.toLocaleString()}</div>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-xl">
                            <h4 class="font-semibold text-white mb-2">VAR Partner Breakdown</h4>
                            <div class="space-y-2">
                                ${varClients.map(client => {
                                    const commission = (client.total || 0) * (client.commissionRate || 20) / 100;
                                    return `
                                        <div class="flex justify-between text-sm">
                                            <span class="text-slate-300">${client.clientName}</span>
                                            <span class="text-white">R ${commission.toLocaleString()} (${client.commissionRate || 20}%)</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            generateClientSummaryReport() {
                return `
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-slate-800/50 p-4 rounded-xl">
                                <div class="text-sm text-slate-400">Total Clients</div>
                                <div class="text-xl font-semibold text-white">${this.clients.length}</div>
                            </div>
                            <div class="bg-slate-800/50 p-4 rounded-xl">
                                <div class="text-sm text-slate-400">Total Users</div>
                                <div class="text-xl font-semibold text-white">${this.clients.reduce((sum, c) => sum + (c.users || 0), 0)}</div>
                            </div>
                            <div class="bg-slate-800/50 p-4 rounded-xl">
                                <div class="text-sm text-slate-400">Total Revenue</div>
                                <div class="text-xl font-semibold text-white">R ${this.clients.reduce((sum, c) => sum + (c.total || 0), 0).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-xl">
                            <h4 class="font-semibold text-white mb-2">Complete Client Directory</h4>
                            <div class="space-y-2 max-h-64 overflow-y-auto">
                                ${this.clients.map(client => `
                                    <div class="flex justify-between items-center text-sm border-b border-slate-700 pb-2">
                                        <div>
                                            <div class="text-white font-medium">${client.clientName}</div>
                                            <div class="text-slate-400 text-xs">${client.debtCode} • ${client.billingModel}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-white">R ${(client.total || 0).toLocaleString()}</div>
                                            <div class="text-slate-400 text-xs">${client.users || 0} users</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            generateMonthlyBreakdownReport() {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const monthlyTotals = months.map(month => {
                    return this.clients.reduce((sum, client) => sum + (client[month.toLowerCase()] || 0), 0);
                });
                const maxMonth = Math.max(...monthlyTotals);

                return `
                    <div class="space-y-4">
                        <div class="bg-slate-800/50 p-4 rounded-xl">
                            <h4 class="font-semibold text-white mb-4">Monthly Revenue Distribution</h4>
                            <div class="grid grid-cols-6 gap-2">
                                ${months.map((month, index) => `
                                    <div class="text-center">
                                        <div class="text-xs text-slate-400 mb-1">${month}</div>
                                        <div class="bg-gradient-to-t from-purple-900 to-purple-700 h-16 rounded flex items-end justify-center relative" style="height: ${Math.max(20, (monthlyTotals[index] / maxMonth) * 60)}px;">
                                            <div class="text-xs text-white font-medium mb-1">R${(monthlyTotals[index] / 1000).toFixed(0)}k</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-xl">
                            <h4 class="font-semibold text-white mb-2">Monthly Totals</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                                ${months.map((month, index) => `
                                    <div class="flex justify-between">
                                        <span class="text-slate-400">${month}:</span>
                                        <span class="text-white">R ${monthlyTotals[index].toLocaleString()}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            generatePaymentStatusReport() {
                const totalRevenue = this.clients.reduce((sum, c) => sum + (c.total || 0), 0);
                const paidAmount = totalRevenue * 0.75; // Simulate 75% paid
                const outstanding = totalRevenue - paidAmount;

                return `
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-slate-800/50 p-4 rounded-xl">
                                <div class="text-sm text-slate-400">Total Billed</div>
                                <div class="text-xl font-semibold text-white">R ${totalRevenue.toLocaleString()}</div>
                            </div>
                            <div class="bg-slate-800/50 p-4 rounded-xl">
                                <div class="text-sm text-center" style="color: rgba(0, 51, 102, 0.8);">Amount Paid</div>
                                <div class="text-xl font-semibold text-center" style="color: rgba(0, 51, 102, 0.9);">R ${paidAmount.toLocaleString()}</div>
                            </div>
                            <div class="bg-slate-800/50 p-4 rounded-xl">
                                <div class="text-sm text-red-400">Outstanding</div>
                                <div class="text-xl font-semibold text-red-300">R ${outstanding.toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-xl">
                            <h4 class="font-semibold text-white mb-2">Payment Status by Client</h4>
                            <div class="space-y-2">
                                ${this.clients.map(client => {
                                    const paid = Math.random() > 0.3; // Random payment status for demo
                                    return `
                                        <div class="flex justify-between items-center text-sm">
                                            <span class="text-slate-300">${client.clientName}</span>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-white">R ${(client.total || 0).toLocaleString()}</span>
                                                <span class="px-2 py-1 text-xs rounded text-center ${paid ? 'text-white' : 'bg-red-900 text-red-300'}" ${paid ? 'style="background: rgba(76, 29, 149, 0.6);"' : ''}>
                                                    ${paid ? 'Paid' : 'Outstanding'}
                                                </span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            generateGrowthMetricsReport() {
                const totalRevenue = this.clients.reduce((sum, c) => sum + (c.total || 0), 0);
                const lastYearRevenue = totalRevenue * 0.85; // Simulate 15% growth
                const growthRate = ((totalRevenue - lastYearRevenue) / lastYearRevenue) * 100;

                return `
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-slate-800/50 p-4 rounded-xl">
                                <div class="text-sm text-slate-400">Current Year</div>
                                <div class="text-xl font-semibold text-white">R ${totalRevenue.toLocaleString()}</div>
                            </div>
                            <div class="bg-slate-800/50 p-4 rounded-xl">
                                <div class="text-sm text-slate-400">Previous Year</div>
                                <div class="text-xl font-semibold text-white">R ${lastYearRevenue.toLocaleString()}</div>
                            </div>
                            <div class="bg-slate-800/50 p-4 rounded-xl">
                                <div class="text-sm text-center" style="color: rgba(76, 29, 149, 0.8);">Growth Rate</div>
                                <div class="text-xl font-semibold text-center" style="color: rgba(76, 29, 149, 0.9);">+${growthRate.toFixed(1)}%</div>
                            </div>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-xl">
                            <h4 class="font-semibold text-white mb-2">Growth by Billing Model</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-300">Perpetual Licenses</span>
                                    <span style="color: rgba(76, 29, 149, 0.8);">+12%</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-300">Subscriptions</span>
                                    <span style="color: rgba(0, 51, 102, 0.8);">+18%</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-300">VAR Partners</span>
                                    <span style="color: rgba(46, 16, 101, 0.8);">+22%</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-300">Instalment</span>
                                    <span style="color: rgba(30, 27, 75, 0.8);">+8%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Initialize the application
        try {
            console.log('Initializing BuildSmart Billing Pro...');
            const app = new BuildSmartBillingPro();
            window.app = app; // Make app globally accessible
            console.log('Application initialized successfully');
        } catch (error) {
            console.error('Error initializing application:', error);
            alert('Error starting application. Please refresh the page.');
        }

        // Global functions for HTML onclick handlers
        function showPage(page) {
            try {
                console.log('Global showPage called with:', page);
                if (window.app) {
                    app.showPage(page);
                } else {
                    console.error('App not found');
                    alert('Application not fully loaded. Please refresh the page.');
                }
            } catch (error) {
                console.error('Error in global showPage:', error);
                alert('Navigation error. Please refresh the page and try again.');
            }
        }

        function openAddClientModal() {
            app.openAddClientModal();
        }

        function closeAddClientModal() {
            app.closeAddClientModal();
        }

        function openAddLicenseModal() {
            console.log('Global function called: openAddLicenseModal');
            app.openAddLicenseModal();
        }

        function closeAddLicenseModal() {
            app.closeAddLicenseModal();
        }
        
        function openBillingConfigModal() {
            app.openBillingConfigModal();
        }
        
        function closeBillingConfigModal() {
            app.closeBillingConfigModal();
        }
        
        function editBillingModel(modelType) {
            app.openBillingConfigModal();
        }
        
        function closeSimpleLicenseModal() {
            const testModal = document.getElementById('test-modal');
            if (testModal) {
                testModal.remove();
            }
        }
        
        function handleSimpleClientChange(select) {
            const selectedOption = select.options[select.selectedIndex];
            const billingModel = selectedOption.dataset.billingModel;
            const varPartner = selectedOption.dataset.varPartner;
            const varField = document.getElementById('simple-var-partner-field');
            const varSelect = document.getElementById('simple-var-partner-select');
            const billingModelSelect = document.getElementById('simple-billing-model');
            
            // Auto-select billing model if client is VAR
            if (billingModel === 'var' && billingModelSelect) {
                billingModelSelect.value = 'var';
                varField.style.display = 'block';
                if (varPartner) {
                    varSelect.value = varPartner;
                }
            } else {
                varField.style.display = 'none';
                if (billingModelSelect) {
                    billingModelSelect.value = billingModel || '';
                }
            }
        }
        
        function handleSimpleBillingModelChange(select) {
            console.log('Billing model changed to:', select.value);
            const model = select.value;
            const varField = document.getElementById('simple-var-partner-field');
            const priceLabel = document.getElementById('simple-price-label');
            const priceInput = document.getElementById('simple-price-input');
            const billingTitle = document.getElementById('simple-billing-title');
            const billingText = document.getElementById('simple-billing-text');
            
            // Handle VAR partner field
            if (varField) {
                if (model === 'var') {
                    console.log('Showing VAR partner field');
                    varField.style.display = 'block';
                } else {
                    console.log('Hiding VAR partner field');
                    varField.style.display = 'none';
                }
            } else {
                console.error('VAR partner field not found');
            }
            
            // Handle billing periods field
            const periodsField = document.getElementById('simple-billing-periods-field');
            const periodsLabel = document.getElementById('simple-periods-label');
            const periodsInput = document.getElementById('simple-periods-input');
            
            if (periodsField) {
                if (model === 'subscription' || model === 'installment') {
                    console.log('Showing billing periods field for', model);
                    periodsField.style.display = 'block';
                    
                    if (model === 'subscription') {
                        periodsLabel.textContent = 'Subscription Duration (Months)';
                        periodsInput.placeholder = 'Number of months (leave blank for ongoing)';
                        periodsInput.required = false;
                    } else if (model === 'installment') {
                        periodsLabel.textContent = 'Instalment Period (Months)';
                        periodsInput.placeholder = 'Number of months to bill';
                        periodsInput.required = true;
                    }
                } else {
                    console.log('Hiding billing periods field');
                    periodsField.style.display = 'none';
                    periodsInput.required = false;
                }
            }
            
            // Update labels and info based on billing model
            if (priceLabel && priceInput && billingTitle && billingText) {
                switch(model) {
                    case 'perpetual':
                        priceLabel.textContent = 'Annual Support & Maintenance Value';
                        priceInput.placeholder = 'Annual S&M value per unit';
                        billingTitle.textContent = 'Perpetual License Billing';
                        billingText.textContent = 'Additional licenses: Year 1 free, Year 2 prorated from the month after license start to anniversary month, Year 3+ full annual billing aligned with anniversary. Annual increases apply to all aligned licenses.';
                        break;
                        
                    case 'subscription':
                        priceLabel.textContent = 'Monthly Subscription Value';
                        priceInput.placeholder = 'Monthly subscription value per unit';
                        billingTitle.textContent = 'Subscription Billing';
                        billingText.textContent = 'Additional licenses will be added to the monthly subscription billing at the specified monthly rate per unit. Specify duration or leave blank for ongoing subscription.';
                        break;
                        
                    case 'installment':
                        priceLabel.textContent = 'Monthly Instalment Value';
                        priceInput.placeholder = 'Monthly instalment value per unit';
                        billingTitle.textContent = 'Instalment Billing';
                        billingText.textContent = 'Additional licenses will be billed as monthly instalments for the specified period at the monthly rate per unit. The instalment period is required.';
                        break;
                        
                    case 'rentals':
                        priceLabel.textContent = 'Monthly Rental Value';
                        priceInput.placeholder = 'Monthly rental value per unit';
                        billingTitle.textContent = 'Rental Billing';
                        billingText.textContent = 'Additional licenses will be billed as monthly rentals for the specified period at the monthly rate per unit. The rental period is required.';
                        break;
                        
                    case 'var':
                        priceLabel.textContent = 'Commission Value';
                        priceInput.placeholder = 'Commission value per unit';
                        billingTitle.textContent = 'VAR Partner Billing';
                        billingText.textContent = 'Additional licenses will generate commission payments to the VAR partner based on the specified commission rate.';
                        break;
                        
                    default:
                        priceLabel.textContent = 'Price Per Unit';
                        priceInput.placeholder = 'Price per unit';
                        billingTitle.textContent = 'Billing Information';
                        billingText.textContent = 'Select a billing model to see specific billing information.';
                        break;
                }
            }
        }
        
        function handleClientBillingModelChange(select) {
            console.log('Client billing model changed to:', select.value);
            const model = select.value;
            const varField = document.getElementById('client-var-partner-field');
            
            if (varField) {
                if (model === 'var') {
                    console.log('Showing client VAR partner field');
                    varField.classList.remove('hidden');
                    // Populate VAR partners dropdown
                    const varSelect = document.getElementById('client-var-partner-select');
                    if (varSelect && window.billingApp) {
                        const partners = window.billingApp.getVarPartners().filter(p => p.isActive);
                        varSelect.innerHTML = '<option value="">Select VAR Partner</option>' +
                            partners.map(partner => 
                                `<option value="${partner.id}">${partner.name} - ${partner.region} (${partner.commissionRate}%)</option>`
                            ).join('');
                    }
                } else {
                    console.log('Hiding client VAR partner field');
                    varField.classList.add('hidden');
                }
            } else {
                console.error('Client VAR partner field not found');
            }
        }

        function handleBillingModelChange(selectElement) {
            app.handleBillingModelChange(selectElement);
        }

        function exportData() {
            app.exportData();
        }

        function importData() {
            app.importData();
        }
        
        function clearAllData() {
            app.clearAllData();
        }
        
        function closeImportModal() {
            document.getElementById('import-modal').classList.add('hidden');
            document.getElementById('import-billing-model').value = '';
        }
        
        function handleVarPartnerChange(selectElement) {
            try {
                const commissionRateInput = document.querySelector('input[name="commissionRate"]');
                const selectedOption = selectElement.options[selectElement.selectedIndex];
                
                if (selectedOption && selectedOption.dataset.rate && commissionRateInput) {
                    commissionRateInput.value = selectedOption.dataset.rate;
                }
            } catch (error) {
                console.error('Error in handleVarPartnerChange:', error);
            }
        }
        
        // Global reference to app for external functions
        window.billingApp = app;
        
        function openAddVarModal() {
            app.openAddVarModal();
        }
        
        function closeAddVarModal() {
            app.closeAddVarModal();
        }
        
        function handleLicenseClientChange(selectElement) {
            app.handleLicenseClientChange(selectElement);
        }
        
        function handleLicenseBillingModelChange(selectElement) {
            app.handleLicenseBillingModelChange(selectElement);
        }

        // Function to auto-populate anniversary month from deal start date
        function updateAnniversaryFromDealDate(dateInput) {
            if (dateInput.value) {
                const date = new Date(dateInput.value);
                const month = date.getMonth() + 1; // Convert to 1-based month
                const anniversarySelect = document.querySelector('select[name="anniversaryMonth"]');
                if (anniversarySelect) {
                    anniversarySelect.value = month.toString();
                }
            }
        }

        // Event listeners
        document.addEventListener('click', function(e) {
            if (e.target.id === 'add-client-modal' || e.target.id === 'add-license-modal') {
                if (e.target.id === 'add-client-modal') app.closeAddClientModal();
                if (e.target.id === 'add-license-modal') app.closeAddLicenseModal();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                app.closeAddClientModal();
                app.closeAddLicenseModal();
            }
        });
    </script>
</body>
</html>